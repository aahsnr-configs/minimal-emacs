#+TITLE: Emacs Dashboard
#+STARTUP: overview hideblocks indent
#+OPTIONS: toc:nil num:nil ^:nil

* ğŸš€ Quick Actions
:PROPERTIES:
:VISIBILITY: all
:END:

** ğŸ“ Capture
- [[elisp:(org-capture nil "t")][ğŸ“‹ Quick Task]]
- [[elisp:(org-capture nil "n")][ğŸ“„ Note]]
- [[elisp:(org-capture nil "j")][ğŸ“” Journal Entry]]
- [[elisp:(org-capture nil "m")][ğŸ¤ Meeting]]
- [[elisp:(org-capture nil "p")][ğŸ¯ New Project]]
- [[elisp:(org-roam-dailies-capture-today)][ğŸ“… Daily Note]]

** ğŸ§­ Navigation
- [[elisp:(find-file (expand-file-name "inbox.org" org-directory))][ğŸ“¥ Inbox]]
- [[elisp:(find-file (expand-file-name "journal.org" org-directory))][ğŸ““ Journal]]
- [[elisp:(find-file (expand-file-name "projects.org" org-directory))][ğŸ¯ Projects]]
- [[elisp:(find-file (expand-file-name "habits.org" org-directory))][ğŸ”„ Habits]]
- [[elisp:(find-file (expand-file-name "goals.org" org-directory))][ğŸ† Goals]]
- [[elisp:(org-roam-node-find)][ğŸŒ Roam Notes]]

** ğŸ› ï¸ Tools
- [[elisp:(magit-status)][ğŸ”§ Magit Status]]
- [[elisp:(project-switch-project)][ğŸ“‚ Switch Project]]
- [[elisp:(consult-recent-file)][ğŸ• Recent Files]]
- [[elisp:(org-pomodoro)][ğŸ… Start Pomodoro]]
- [[elisp:(treemacs)][ğŸŒ³ Treemacs]]
- [[elisp:(dirvish)][ğŸ“ File Manager]]
- [[elisp:(vterm)][ğŸ’» Terminal]]

** ğŸ—‚ï¸ Workspaces
- [[elisp:(tabspaces-switch-or-create-workspace)][ğŸ—‚ï¸  Switch Workspace]]
- [[elisp:(tab-bar-new-tab)][â• New Workspace]]
- [[elisp:(tab-bar-close-tab)][â– Close Workspace]]

* ğŸ“… Today's Schedule
:PROPERTIES:
:VISIBILITY: all
:END:

#+BEGIN: ar/agenda-today
#+END:

* âœ… Task Overview
:PROPERTIES:
:VISIBILITY: all
:END:

#+BEGIN: ar/task-summary
#+END:

** ğŸ”¥ Priority Tasks
#+BEGIN: ar/priority-tasks
#+END:

** â­ï¸ Next Actions
#+BEGIN: ar/next-actions
#+END:

* ğŸ“‚ Projects & Files
:PROPERTIES:
:VISIBILITY: all
:END:

** ğŸ“ Current Project
#+BEGIN: ar/current-project
#+END:

** ğŸ“Š All Projects
#+BEGIN: ar/projects
#+END:

** ğŸ“‘ Recent Files
#+BEGIN: ar/recent-files :limit 15
#+END:

** ğŸ“Œ Project TODOs
#+BEGIN: ar/project-todos
#+END:

* ğŸ”¥ Active Projects
:PROPERTIES:
:VISIBILITY: all
:END:

#+BEGIN: ar/active-projects
#+END:

* ğŸ”„ Git Activity
:PROPERTIES:
:VISIBILITY: all
:END:

** ğŸ”´ Uncommitted Changes
#+BEGIN: ar/project-git-status
#+END:

** ğŸ“ Recent Commits
#+BEGIN: ar/project-recent-commits :limit 15
#+END:

* â±ï¸ Time Tracking
:PROPERTIES:
:VISIBILITY: all
:END:

** Today
#+BEGIN: clocktable :scope agenda :maxlevel 3 :block today :tags "-ARCHIVE"
#+END:

** This Week
#+BEGIN: clocktable :scope agenda :maxlevel 2 :block thisweek :compact t
#+END:

* ğŸ”„ Habits Progress
:PROPERTIES:
:VISIBILITY: all
:END:

#+BEGIN: ar/habit-consistency
#+END:

* ğŸ“Š Statistics
:PROPERTIES:
:VISIBILITY: all
:END:

#+BEGIN: ar/productivity-stats
#+END:

* ğŸ¯ Goals & Metrics
:PROPERTIES:
:VISIBILITY: all
:END:

#+BEGIN: ar/goal-progress
#+END:

* ğŸ” Quick Search
:PROPERTIES:
:VISIBILITY: all
:END:

- [[elisp:(consult-line-multi t)][ğŸ” Search All Buffers]]
- [[elisp:(consult-ripgrep org-directory)][ğŸ“ Search Org Files]]
- [[elisp:(consult-org-roam-search)][ğŸŒ Search Roam]]
- [[elisp:(hl-todo-rg-project)][ğŸ“Œ Find TODOs]]
- [[elisp:(consult-flymake)][ğŸ”¥ Search Errors]]

* ğŸ“ Scratchpad
:PROPERTIES:
:VISIBILITY: all
:END:

<!-- Quick notes here - they'll persist across sessions -->
<!-- Use C-c C-c to refile when ready -->
```

---

## 2. Add Dynamic Block Functions to `config.org`

Add this new section after your Org Mode configuration:

```elisp
** Dynamic Dashboard Blocks
#+begin_src emacs-lisp
;; Helper function to get nerd-icons
(defun ar/dashboard-icon (icon-type icon-name)
  "Get nerd-icon safely."
  (if (and (display-graphic-p) (featurep 'nerd-icons))
      (pcase icon-type
        ('codicon (nerd-icons-codicon icon-name))
        ('devicon (nerd-icons-devicon icon-name))
        ('faicon (nerd-icons-faicon icon-name))
        ('flicon (nerd-icons-flicon icon-name))
        ('mdicon (nerd-icons-mdicon icon-name))
        ('octicon (nerd-icons-octicon icon-name))
        ('pomicon (nerd-icons-pomicon icon-name))
        ('sucicon (nerd-icons-sucicon icon-name))
        ('wicon (nerd-icons-wicon icon-name))
        (_ ""))
    ""))

;; Today's Agenda
(defun org-dblock-write:ar/agenda-today (params)
  "Generate today's agenda for dashboard."
  (let* ((date (calendar-current-date))
         (date-string (format-time-string "%Y-%m-%d %A"))
         (icon (ar/dashboard-icon 'mdicon "nf-md-calendar_today")))
    (insert (format "%s *%s*\n\n" icon date-string))
    (let ((org-agenda-files (org-agenda-files t t))
          (org-agenda-buffer-name "*Dashboard Agenda*"))
      (org-agenda-list nil nil 'day)
      (with-current-buffer "*Dashboard Agenda*"
        (let ((content (buffer-substring-no-properties
                       (point-min) (point-max))))
          (kill-buffer)
          (insert content))))))

;; Task Summary
(defun org-dblock-write:ar/task-summary (params)
  "Generate task summary statistics with icons."
  (require 'org-element)
  (let ((todo-count 0)
        (next-count 0)
        (prog-count 0)
        (wait-count 0)
        (done-today 0)
        (icon-todo (ar/dashboard-icon 'mdicon "nf-md-circle_outline"))
        (icon-next (ar/dashboard-icon 'mdicon "nf-md-arrow_right_circle"))
        (icon-prog (ar/dashboard-icon 'mdicon "nf-md-progress_clock"))
        (icon-wait (ar/dashboard-icon 'mdicon "nf-md-pause_circle"))
        (icon-done (ar/dashboard-icon 'mdicon "nf-md-check_circle")))

    ;; Count tasks
    (org-map-entries
     (lambda ()
       (let ((todo-state (org-get-todo-state)))
         (pcase todo-state
           ("TODO" (cl-incf todo-count))
           ("NEXT" (cl-incf next-count))
           ("PROG" (cl-incf prog-count))
           ("WAIT" (cl-incf wait-count))
           ("DONE"
            (when (and (org-entry-get nil "CLOSED")
                       (string-match-p
                        (format-time-string "%Y-%m-%d")
                        (org-entry-get nil "CLOSED")))
              (cl-incf done-today))))))
     nil 'agenda)

    ;; Format output with icons
    (insert (format "| Status | Count |\n"))
    (insert (format "|--------+-------|\n"))
    (insert (format "| %s TODO   | %5d |\n" icon-todo todo-count))
    (insert (format "| %s NEXT   | %5d |\n" icon-next next-count))
    (insert (format "| %s PROG   | %5d |\n" icon-prog prog-count))
    (insert (format "| %s WAIT   | %5d |\n" icon-wait wait-count))
    (insert (format "|--------+-------|\n"))
    (insert (format "| *Total Open* | *%d* |\n" (+ todo-count next-count prog-count wait-count)))
    (insert (format "| %s Completed Today | %d |\n" icon-done done-today))))

;; Priority Tasks
(defun org-dblock-write:ar/priority-tasks (params)
  "Show high-priority tasks with icons."
  (let ((tasks '())
        (icon-priority (ar/dashboard-icon 'mdicon "nf-md-fire")))
    (org-map-entries
     (lambda ()
       (when (member (org-get-todo-state) '("TODO" "NEXT" "PROG"))
         (let ((priority (org-entry-get nil "PRIORITY")))
           (when (and priority (string= priority "A"))
             (push (list
                    (org-get-heading t t t t)
                    (org-get-todo-state)
                    (or (org-entry-get nil "SCHEDULED") "")
                    (buffer-file-name))
                   tasks)))))
     nil 'agenda)

    (if tasks
        (progn
          (insert (format "| Priority | Task | State | Scheduled |\n"))
          (insert (format "|----------+------+-------+-----------|\n"))
          (dolist (task (nreverse tasks))
            (insert (format "| %s [#A] | %s | %s | %s |\n"
                          icon-priority
                          (nth 0 task)
                          (nth 1 task)
                          (if (string-empty-p (nth 2 task))
                              "-"
                            (format-time-string "%m-%d"
                                              (org-time-string-to-time (nth 2 task))))))))
      (insert (format "%s No priority A tasks! ğŸ‰\n"
                     (ar/dashboard-icon 'mdicon "nf-md-party_popper"))))))

;; Next Actions by Context
(defun org-dblock-write:ar/next-actions (params)
  "List next actions by context with icons."
  (let ((contexts '(("@work" . "nf-md-briefcase")
                   ("@home" . "nf-md-home")
                   ("@computer" . "nf-md-laptop")
                   ("@errands" . "nf-md-cart")))
        (task-count 0))
    (dolist (context-pair contexts)
      (let ((context (car context-pair))
            (icon-name (cdr context-pair))
            (context-tasks '()))
        (org-map-entries
         (lambda ()
           (when (and (string= (org-get-todo-state) "NEXT")
                      (member context (org-get-tags)))
             (push (org-get-heading t t t t) context-tasks)
             (cl-incf task-count)))
         nil 'agenda)

        (when context-tasks
          (let ((icon (ar/dashboard-icon 'mdicon icon-name)))
            (insert (format "\n%s *%s* (%d)\n" icon context (length context-tasks)))
            (dolist (task (nreverse context-tasks))
              (insert (format "- [ ] %s\n" task)))))))

    (when (= task-count 0)
      (insert (format "%s No next actions defined. Review your TODO items!\n"
                     (ar/dashboard-icon 'mdicon "nf-md-information"))))))

;; Active Projects
(defun org-dblock-write:ar/active-projects (params)
  "List active projects with progress and icons."
  (let ((projects '())
        (icon-project (ar/dashboard-icon 'mdicon "nf-md-folder_star")))
    (org-map-entries
     (lambda ()
       (when (and (member (org-get-todo-state) '("PLAN" "ACTIVE"))
                  (member "project" (org-get-tags)))
         (let* ((heading (org-get-heading t t t t))
                (state (org-get-todo-state))
                (total-tasks 0)
                (done-tasks 0))
           ;; Count subtasks
           (org-map-entries
            (lambda ()
              (cl-incf total-tasks)
              (when (string= (org-get-todo-state) "DONE")
                (cl-incf done-tasks)))
            nil 'tree)

           (push (list heading state total-tasks done-tasks) projects))))
     nil 'agenda)

    (if projects
        (progn
          (insert (format "| %s Project | State | Progress |\n" icon-project))
          (insert (format "|---------+-------+----------|\n"))
          (dolist (proj (nreverse projects))
            (let* ((name (nth 0 proj))
                   (state (nth 1 proj))
                   (total (max 1 (nth 2 proj)))
                   (done (nth 3 proj))
                   (percent (/ (* 100.0 done) total))
                   (progress-icon (cond
                                  ((>= percent 75) "ğŸŸ¢")
                                  ((>= percent 50) "ğŸŸ¡")
                                  ((>= percent 25) "ğŸŸ ")
                                  (t "ğŸ”´"))))
              (insert (format "| %s | %s | %s %.0f%% (%d/%d) |\n"
                            name state progress-icon percent done total)))))
      (insert (format "%s No active projects.\n"
                     (ar/dashboard-icon 'mdicon "nf-md-folder_open"))))))

;; Recent Files
(defun org-dblock-write:ar/recent-files (params)
  "Display recent files with icons and links."
  (let* ((limit (or (plist-get params :limit) 10))
         (exclude-pattern (or (plist-get params :exclude)
                             "^/tmp\\|/\\.emacs\\.d/\\(elpa\\|elpaca\\|straight\\)"))
         (files (cl-remove-if
                 (lambda (f)
                   (or (string-match-p exclude-pattern f)
                       (not (file-exists-p f))))
                 recentf-list))
         (files (cl-subseq files 0 (min limit (length files)))))

    (if files
        (progn
          (insert "| File | Modified | Project |\n")
          (insert "|------+----------+---------|\n")
          (dolist (file files)
            (let* ((name (file-name-nondirectory file))
                   (dir (abbreviate-file-name (file-name-directory file)))
                   (modified (format-time-string
                             "%m/%d %H:%M"
                             (nth 5 (file-attributes file))))
                   (proj (if (and (require 'project nil t)
                                 (project-current nil (file-name-directory file)))
                            (file-name-nondirectory
                             (directory-file-name
                              (project-root (project-current nil (file-name-directory file)))))
                          "-"))
                   ;; Get icon based on file type
                   (icon (if (and (display-graphic-p)
                                 (featurep 'nerd-icons))
                            (nerd-icons-icon-for-file name)
                          "")))
              (insert (format "| [[file:%s][%s %s]] | %s | %s |\n"
                            file
                            icon
                            name
                            modified
                            proj)))))
      (insert (format "%s No recent files found.\n"
                     (ar/dashboard-icon 'mdicon "nf-md-file_question"))))))

;; Project List
(defun org-dblock-write:ar/projects (params)
  "Display known projects with git status and quick actions."
  (require 'project)
  (let* ((projects (project-known-project-roots))
         (current-proj (when (project-current)
                        (project-root (project-current))))
         (icon-folder (ar/dashboard-icon 'mdicon "nf-md-folder"))
         (icon-git (ar/dashboard-icon 'mdicon "nf-md-git")))

    (if projects
        (progn
          (insert (format "| %s Project | Status | Files | Branch | Actions |\n" icon-folder))
          (insert (format "|---------+--------+-------+--------+---------|\n"))
          (dolist (proj projects)
            (let* ((name (file-name-nondirectory (directory-file-name proj)))
                   (is-current (and current-proj (string= proj current-proj)))
                   (marker (if is-current "ğŸ‘‰ " ""))
                   ;; Get git branch
                   (branch (if (file-exists-p (expand-file-name ".git" proj))
                              (with-temp-buffer
                                (let ((default-directory proj))
                                  (when (= 0 (call-process "git" nil t nil
                                                          "rev-parse" "--abbrev-ref" "HEAD"))
                                    (string-trim (buffer-string)))))
                            "-"))
                   ;; Count files
                   (file-count (length (directory-files proj nil "^[^.]")))
                   ;; Git status
                   (status (if (file-exists-p (expand-file-name ".git" proj))
                              (with-temp-buffer
                                (let ((default-directory proj))
                                  (call-process "git" nil t nil "status" "--porcelain")
                                  (if (= (buffer-size) 0)
                                      "âœ“"
                                    "â—")))
                            "-")))

              (insert (format "| %s[[elisp:(project-switch-project \"%s\")][%s]] | %s | %d | %s | [[elisp:(magit-status \"%s\")][%s]] [[elisp:(dired \"%s\")][ğŸ“]] |\n"
                            marker
                            proj
                            name
                            status
                            file-count
                            branch
                            proj
                            icon-git
                            proj)))))
      (insert (format "%s No projects found. Use `project-remember-project' to add some.\n"
                     (ar/dashboard-icon 'mdicon "nf-md-folder_alert"))))))

;; Current Project Detail
(defun org-dblock-write:ar/current-project (params)
  "Display current project details with file tree."
  (require 'project)
  (let ((icon-project (ar/dashboard-icon 'mdicon "nf-md-folder_star"))
        (icon-location (ar/dashboard-icon 'mdicon "nf-md-map_marker"))
        (icon-branch (ar/dashboard-icon 'octicon "nf-oct-git_branch"))
        (icon-files (ar/dashboard-icon 'mdicon "nf-md-file_multiple")))
    (if-let ((proj (project-current)))
        (let* ((root (project-root proj))
               (name (file-name-nondirectory (directory-file-name root)))
               (files (project-files proj))
               (git-branch (when (file-exists-p (expand-file-name ".git" root))
                            (with-temp-buffer
                              (let ((default-directory root))
                                (when (= 0 (call-process "git" nil t nil
                                                        "rev-parse" "--abbrev-ref" "HEAD"))
                                  (string-trim (buffer-string)))))))
               (recent-files (cl-remove-if-not
                             (lambda (f) (string-prefix-p root f))
                             recentf-list)))

          (insert (format "%s *Project:* %s\n" icon-project name))
          (insert (format "%s *Location:* [[file:%s][%s]]\n" icon-location root root))
          (when git-branch
            (insert (format "%s *Branch:* %s\n" icon-branch git-branch)))
          (insert (format "%s *Total Files:* %d\n\n" icon-files (length files)))

          (insert "*Quick Actions:*\n")
          (insert (format "- [[elisp:(project-find-file)][ğŸ” Find File]] | "))
          (insert (format "[[elisp:(consult-ripgrep \"%s\")][ğŸ” Search]] | " root))
          (insert (format "[[elisp:(magit-status \"%s\")][ğŸ”§ Git Status]] | " root))
          (insert (format "[[elisp:(project-compile)][âš™ï¸ Compile]] | "))
          (insert (format "[[elisp:(treemacs-add-and-display-current-project)][ğŸŒ³ Treemacs]]\n\n"))

          (when recent-files
            (insert (format "*Recent Files in Project:*\n"))
            (dolist (file (cl-subseq recent-files 0 (min 8 (length recent-files))))
              (let* ((rel-name (file-relative-name file root))
                     (icon (if (and (display-graphic-p) (featurep 'nerd-icons))
                              (nerd-icons-icon-for-file rel-name)
                            "")))
                (insert (format "- [[file:%s][%s %s]]\n" file icon rel-name))))))

      (insert (format "%s No project active. Open a file in a project directory.\n"
                     (ar/dashboard-icon 'mdicon "nf-md-folder_open"))))))

;; Project TODOs
(defun org-dblock-write:ar/project-todos (params)
  "Find TODO comments in current project files."
  (require 'project)
  (let ((icon-todo (ar/dashboard-icon 'mdicon "nf-md-check_circle_outline")))
    (if-let ((proj (project-current)))
        (let* ((root (project-root proj))
               (default-directory root)
               (todos '()))

          ;; Use ripgrep if available, otherwise grep
          (with-temp-buffer
            (if (executable-find "rg")
                (call-process "rg" nil t nil
                            "-n" "--no-heading"
                            "-g" "!{node_modules,vendor,.git}"
                            "TODO|FIXME|HACK|XXX|NOTE")
              (call-process "grep" nil t nil
                          "-rn" "--exclude-dir=node_modules"
                          "--exclude-dir=.git"
                          "-E" "TODO|FIXME|HACK|XXX|NOTE"
                          "."))

            (goto-char (point-min))
            (while (not (eobp))
              (let ((line (buffer-substring-no-properties
                          (line-beginning-position)
                          (line-end-position))))
                (when (string-match "^\\([^:]+\\):\\([0-9]+\\):\\(.+\\)" line)
                  (push (list (match-string 1 line)
                            (match-string 2 line)
                            (string-trim (match-string 3 line)))
                        todos)))
              (forward-line 1)))

          (if todos
              (progn
                (insert (format "| File | Line | TODO |\n"))
                (insert (format "|------+------+------|\n"))
                (dolist (todo (nreverse todos))
                  (let ((file (expand-file-name (nth 0 todo) root))
                        (line-num (nth 1 todo))
                        (text (nth 2 todo)))
                    (insert (format "| [[file:%s::%s][%s]] | %s | %s |\n"
                                  file
                                  line-num
                                  (file-name-nondirectory (nth 0 todo))
                                  line-num
                                  (substring text 0 (min 60 (length text))))))))
            (insert (format "%s No TODOs found in project! ğŸ‰\n"
                           (ar/dashboard-icon 'mdicon "nf-md-party_popper")))))

      (insert (format "%s No project active.\n"
                     (ar/dashboard-icon 'mdicon "nf-md-folder_open"))))))

;; Git Status Across Projects
(defun org-dblock-write:ar/project-git-status (params)
  "Show git status across all projects."
  (require 'project)
  (let ((projects (project-known-project-roots))
        (dirty-projects '())
        (icon-git (ar/dashboard-icon 'octicon "nf-oct-git_branch"))
        (icon-changes (ar/dashboard-icon 'mdicon "nf-md-file_edit")))

    (dolist (proj projects)
      (when (file-exists-p (expand-file-name ".git" proj))
        (with-temp-buffer
          (let ((default-directory proj))
            (call-process "git" nil t nil "status" "--porcelain")
            (when (> (buffer-size) 0)
              (push (cons proj (buffer-string)) dirty-projects))))))

    (if dirty-projects
        (progn
          (insert (format "%s *Projects with uncommitted changes:*\n\n" icon-changes))
          (dolist (item dirty-projects)
            (let* ((proj (car item))
                   (name (file-name-nondirectory (directory-file-name proj)))
                   (changes (cdr item))
                   (line-count (length (split-string changes "\n" t))))
              (insert (format "- [[elisp:(magit-status \"%s\")][%s %s]] (%d files changed)\n"
                            proj icon-git name line-count)))))
      (insert (format "%s All projects clean! âœ¨\n"
                     (ar/dashboard-icon 'mdicon "nf-md-check_all"))))))

;; Recent Commits
(defun org-dblock-write:ar/project-recent-commits (params)
  "Show recent commits across projects."
  (require 'project)
  (let* ((projects (project-known-project-roots))
         (limit (or (plist-get params :limit) 10))
         (commits '())
         (icon-commit (ar/dashboard-icon 'octicon "nf-oct-git_commit")))

    (dolist (proj projects)
      (when (file-exists-p (expand-file-name ".git" proj))
        (with-temp-buffer
          (let ((default-directory proj))
            (call-process "git" nil t nil
                        "log" "-n" "5"
                        "--pretty=format:%h|%ar|%s|%an")
            (goto-char (point-min))
            (while (not (eobp))
              (let ((line (buffer-substring-no-properties
                          (line-beginning-position)
                          (line-end-position))))
                (when (string-match "^\\([^|]+\\)|\\([^|]+\\)|\\([^|]+\\)|\\(.+\\)" line)
                  (push (list proj
                            (match-string 1 line)
                            (match-string 2 line)
                            (match-string 3 line)
                            (match-string 4 line))
                        commits)))
              (forward-line 1))))))

    ;; Sort by time and limit
    (setq commits (cl-subseq commits 0 (min limit (length commits))))

    (if commits
        (progn
          (insert (format "| Project | %s Commit | Time | Message | Author |\n" icon-commit))
          (insert (format "|---------+--------+------+---------+--------|\n"))
          (dolist (commit commits)
            (let ((proj-name (file-name-nondirectory
                            (directory-file-name (nth 0 commit))))
                  (hash (nth 1 commit))
                  (time (nth 2 commit))
                  (msg (nth 3 commit))
                  (author (nth 4 commit)))
              (insert (format "| %s | ~%s~ | %s | %s | %s |\n"
                            proj-name hash time
                            (substring msg 0 (min 40 (length msg)))
                            author)))))
      (insert (format "%s No git commits found.\n"
                     (ar/dashboard-icon 'octicon "nf-oct-git_commit"))))))

;; Habit Consistency
(defun org-dblock-write:ar/habit-consistency (params)
  "Show habit completion rates with icons."
  (require 'org-habit)
  (let ((habits '())
        (icon-habit (ar/dashboard-icon 'mdicon "nf-md-repeat")))
    (org-map-entries
     (lambda ()
       (when (org-is-habit-p)
         (let* ((heading (org-get-heading t t t t))
                (habit-stats (org-habit-parse-todo)))
           (when habit-stats
             (push (list heading habit-stats) habits)))))
     nil 'agenda)

    (if habits
        (progn
          (insert (format "| %s Habit | Status |\n" icon-habit))
          (insert (format "|-------+--------|\n"))
          (dolist (habit habits)
            (insert (format "| %s | Active |\n" (car habit)))))
      (insert (format "%s No habits tracked.\n"
                     (ar/dashboard-icon 'mdicon "nf-md-information"))))))

;; Productivity Statistics
(defun org-dblock-write:ar/productivity-stats (params)
  "Generate productivity statistics with icons."
  (let* ((today (format-time-string "%Y-%m-%d"))
         (tasks-completed 0)
         (total-clocked 0)
         (icon-task (ar/dashboard-icon 'mdicon "nf-md-check_circle"))
         (icon-clock (ar/dashboard-icon 'mdicon "nf-md-clock"))
         (icon-streak (ar/dashboard-icon 'mdicon "nf-md-fire")))

    ;; Count completed tasks today
    (org-map-entries
     (lambda ()
       (when (and (string= (org-get-todo-state) "DONE")
                  (org-entry-get nil "CLOSED")
                  (string-match-p today (org-entry-get nil "CLOSED")))
         (cl-incf tasks-completed)))
     nil 'agenda)

    ;; Get clocked time today
    (setq total-clocked
          (/ (org-clock-sum-today) 60.0))

    (insert (format "| Metric | Value |\n"))
    (insert (format "|--------+-------|\n"))
    (insert (format "| %s Tasks Completed | %d |\n" icon-task tasks-completed))
    (insert (format "| %s Hours Clocked | %.1f |\n" icon-clock total-clocked))
    (insert (format "| %s Active Streak | - |\n" icon-streak))))

;; Goal Progress
(defun org-dblock-write:ar/goal-progress (params)
  "Show progress on goals with icons."
  (let ((goals '())
        (icon-goal (ar/dashboard-icon 'mdicon "nf-md-trophy")))
    (org-map-entries
     (lambda ()
       (when (and (string= (org-get-todo-state) "GOAL")
                  (member "goal" (org-get-tags)))
         (push (list
                (org-get-heading t t t t)
                (or (org-entry-get nil "DEADLINE") "No deadline"))
               goals)))
     nil 'agenda)

    (if goals
        (progn
          (insert (format "| %s Goal | Deadline |\n" icon-goal))
          (insert (format "|------+----------|\n"))
          (dolist (goal (nreverse goals))
            (insert (format "| %s | %s |\n"
                          (nth 0 goal)
                          (nth 1 goal)))))
      (insert (format "%s No active goals. Time to set some!\n"
                     (ar/dashboard-icon 'mdicon "nf-md-information"))))))

;; Auto-refresh dashboard blocks
(defun ar/dashboard-refresh-blocks ()
  "Refresh all dynamic blocks in dashboard."
  (interactive)
  (when (and buffer-file-name
             (string-match-p "dashboard\\.org$" buffer-file-name))
    (save-excursion
      (goto-char (point-min))
      (while (re-search-forward "^[ \t]*#\\+BEGIN:" nil t)
        (condition-case err
            (org-update-dblock)
          (error
           (message "Error updating dblock: %s" (error-message-string err))))))))

;; Add hook to refresh on save
(defun ar/dashboard-setup ()
  "Setup dashboard buffer behavior."
  (when (and buffer-file-name
             (string-match-p "dashboard\\.org$" buffer-file-name))
    (read-only-mode -1)  ; Ensure buffer is writable
    (add-hook 'after-save-hook #'ar/dashboard-refresh-blocks nil t)))

(add-hook 'org-mode-hook #'ar/dashboard-setup)
#+end_src
```

---

## 3. Replace Dashboard Package Configuration

In your `config.org`, **replace the entire Dashboard section** with:

```elisp
* Org Dashboard
#+begin_src emacs-lisp
(defvar ar/dashboard-file
  (expand-file-name "dashboard.org" user-emacs-directory)
  "Path to the Org-mode dashboard file.")

;; Ensure dashboard.org exists
(unless (file-exists-p ar/dashboard-file)
  (message "Creating dashboard.org...")
  ;; You'll need to manually create the file with the content from section 1 above
  ;; Or we can create a minimal version programmatically
  (with-temp-file ar/dashboard-file
    (insert "#+TITLE: Emacs Dashboard\n")
    (insert "#+STARTUP: overview hideblocks indent\n")
    (insert "#+OPTIONS: toc:nil num:nil ^:nil\n\n")
    (insert "* Welcome to Emacs\n\n")
    (insert "Edit this file at: =~/.config/emacs/dashboard.org=\n")))

;; Set as initial buffer (batch-mode safe)
(setq initial-buffer-choice
      (lambda ()
        (cond
         ;; Don't interfere with batch mode (package upgrades)
         (noninteractive nil)
         ;; Don't interfere with command-line file arguments
         ((> (length command-line-args) 2) nil)
         ;; Otherwise, open dashboard
         (t
          (find-file ar/dashboard-file)
          ;; Refresh blocks on startup (delayed slightly)
          (run-with-idle-timer 0.5 nil
                               (lambda ()
                                 (when (get-buffer (file-name-nondirectory ar/dashboard-file))
                                   (with-current-buffer (file-name-nondirectory ar/dashboard-file)
                                     (ar/dashboard-refresh-blocks)))))
          (current-buffer)))))

;; Quick access to dashboard
(defun ar/open-dashboard ()
  "Open or switch to the dashboard."
  (interactive)
  (if (get-buffer (file-name-nondirectory ar/dashboard-file))
      (switch-to-buffer (file-name-nondirectory ar/dashboard-file))
    (find-file ar/dashboard-file))
  (ar/dashboard-refresh-blocks))

;; Auto-refresh dashboard every 5 minutes when idle
(defvar ar/dashboard-refresh-timer nil
  "Timer for dashboard auto-refresh.")

(defun ar/start-dashboard-refresh-timer ()
  "Start the dashboard auto-refresh timer."
  (when ar/dashboard-refresh-timer
    (cancel-timer ar/dashboard-refresh-timer))
  (setq ar/dashboard-refresh-timer
        (run-with-idle-timer 300 t
          (lambda ()
            (when (and (get-buffer (file-name-nondirectory ar/dashboard-file))
                       (eq (current-buffer)
                           (get-buffer (file-name-nondirectory ar/dashboard-file))))
              (ar/dashboard-refresh-blocks))))))

(add-hook 'after-init-hook #'ar/start-dashboard-refresh-timer)
#+end_src
