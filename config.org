#+TITLE: Emacs Configuration
#+AUTHOR: Ahsanur Rahman
#+DESCRIPTION: Personal Minimal Emacs Configuration
#+VERSION: 0.45
#+STARTUP: overview
#+PROPERTY: header-args:emacs-lisp :tangle ./init.el :mkdirp yes

* TODO Core Emacs
** DONE Lexical Binding
#+begin_src emacs-lisp
;;; init.el --- Main Configuration File -*- no-byte-compile: t; lexical-binding: t; -*-
;;; Commentary:
#+end_src

** DONE Garbage Collection
#+begin_src emacs-lisp
;; CRITICAL: Restore GC after startup with optimized values
(defvar better-gc-cons-threshold (* 80 1024 1024)  ;; 128MB
  "Optimal GC threshold for modern LSP-heavy workflows.
Lower this if you experience freezing, raise if stuttering.")

(defvar better-gc-cons-percentage 0.1
  "GC percentage of heap to trigger collection.")

;; Restore GC settings after startup
(add-hook 'emacs-startup-hook
          (lambda ()
            (setq gc-cons-threshold better-gc-cons-threshold
                  gc-cons-percentage better-gc-cons-percentage)

            ;; FIX: Only restore file handlers if the original variable actually exists
            (when (boundp 'file-name-handler-alist-original)
              (setq file-name-handler-alist file-name-handler-alist-original)
              (makunbound 'file-name-handler-alist-original))

            ;; Report startup time
            (message "Emacs loaded in %.2fs with %d GCs"
                     (float-time (time-subtract after-init-time before-init-time))
                     gcs-done))
          101) ;; Run late to ensure accurate timing

;; Increase GC threshold in minibuffer to prevent slowdowns during completion
(add-hook 'emacs-startup-hook
          (lambda ()
            (defun gc-minibuffer-setup-hook ()
              (setq gc-cons-threshold (* better-gc-cons-threshold 2)))

            (defun gc-minibuffer-exit-hook ()
              (garbage-collect)
              (setq gc-cons-threshold better-gc-cons-threshold))

            (add-hook 'minibuffer-setup-hook #'gc-minibuffer-setup-hook)
            (add-hook 'minibuffer-exit-hook #'gc-minibuffer-exit-hook)))
#+end_src

** DONE Package Management
#+begin_src emacs-lisp
(defvar bootstrap-version)
(let ((bootstrap-file
       (expand-file-name
        "straight/repos/straight.el/bootstrap.el"
        (or (bound-and-true-p straight-base-dir)
            user-emacs-directory)))
      (bootstrap-version 7))
  (unless (file-exists-p bootstrap-file)
    (with-current-buffer
        (url-retrieve-synchronously
         "https://raw.githubusercontent.com/radian-software/straight.el/develop/install.el"
         'silent 'inhibit-cookies)
      (goto-char (point-max))
      (eval-print-last-sexp)))
  (load bootstrap-file nil 'nomessage))


(straight-use-package 'use-package)

(setq straight-use-package-by-default t)
#+end_src

** DONE Custom Functions
#+begin_src emacs-lisp
(defun childframe-workable-p ()
  "Whether childframe is workable."
  (and (>= emacs-major-version 26)
       (not noninteractive)
       (or (display-graphic-p)
           (featurep 'tty-child-frames))
       (eq (frame-parameter (selected-frame) 'minibuffer) 't)))

(defun childframe-completion-workable-p ()
  "Whether childframe completion is workable."
  (childframe-workable-p))

(defun icons-displayable-p ()
  "Return non-nil if icons are displayable."
  (or (featurep 'nerd-icons)
      (require 'nerd-icons nil t)))

(defun too-long-file-p ()
  "Check whether the file is too long."
  (or (> (buffer-size) 500000)
      (and (fboundp 'buffer-line-statistics)
           (> (car (buffer-line-statistics)) 10000))))

(defun reload-init-file ()
  "Tangle and reload the Emacs configuration from config.org.
This function is designed for use with package.el.

IMPORTANT: This does NOT fully restart Emacs. Some changes (especially
removed keybindings, hooks, or modes) will persist until you restart Emacs."
  (interactive)
  (let* ((config-org (expand-file-name "config.org" user-emacs-directory))
         (init-el (expand-file-name "init.el" user-emacs-directory))
         (start-time (current-time)))

    ;; Check if config.org exists
    (unless (file-exists-p config-org)
      (user-error "Configuration file %s not found!" config-org))

    ;; Confirm before reloading
    (when (yes-or-no-p "Reload configuration? (This won't reset removed keybindings/hooks) ")
      (message "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━")
      (message "Tangling configuration from config.org...")

      ;; Tangle the org file
      (condition-case err
          (org-babel-tangle-file config-org init-el "emacs-lisp")
        (error
         (user-error "Failed to tangle config.org: %s" (error-message-string err))))

      (message "✓ Tangling complete")
      (message "Loading init.el...")

      ;; Load the tangled init file
      (condition-case err
          (load-file init-el)
        (error
         (message "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━")
         (user-error "Failed to load init.el: %s" (error-message-string err))))

      ;; Calculate load time
      (let ((elapsed-time (float-time (time-subtract (current-time) start-time))))
        (message "✓ Configuration loaded successfully")
        (message "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━")
        (message "Reload completed in %.2f seconds" elapsed-time)
        (message "")
        (message "NOTE: Some changes require a full Emacs restart:")
        (message "  • Removed keybindings, hooks, or modes")
        (message "  • Package installations/removals")
        (message "  • Major structural changes")
        (message "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━")))))

(defun my/auto-tangle-config-org ()
  "Automatically tangle config.org when saved."
  (when (string-equal (buffer-file-name)
                      (expand-file-name "config.org" user-emacs-directory))
    ;; Dynamic scoping to avoid confirmation prompts
    (let ((org-confirm-babel-evaluate nil))
      (org-babel-tangle))))

(add-hook 'org-mode-hook
          (lambda ()
            (add-hook 'after-save-hook #'my/auto-tangle-config-org nil t)))

(defun selected-region-or-symbol-at-point ()
  "Return the selected region, otherwise return the symbol at point."
  (if (region-active-p)
      (buffer-substring-no-properties (region-beginning) (region-end))
    (thing-at-point 'symbol t)))
#+end_src

** DONE Constants
#+begin_src emacs-lisp
(defconst sys/linuxp
  (eq system-type 'gnu/linux)
  "Are we running on a GNU/Linux system?")

(defconst sys/rootp
  (string-equal "root" (getenv "USER"))
  "Are you using ROOT user?")

(defconst emacs/>=29p
  (>= emacs-major-version 29)
  "Emacs is 29 or above.")

(defconst emacs/>=29.2p
  (and (>= emacs-major-version 29)
       (>= emacs-minor-version 2))
  "Emacs is 29.2 or above.")

(defconst emacs/>=30p
  (>= emacs-major-version 30)
  "Emacs is 30 or above.")

(defconst emacs/>=31p
  (>= emacs-major-version 31)
  "Emacs is 31 or above.")
#+end_src

** DONE Performance Tuning
#+begin_src emacs-lisp
(setq-default bidi-display-reordering nil
              bidi-paragraph-direction 'left-to-right
              bidi-inhibit-bpa t)

;; Mitigate Input Lag by disabling GTK input methods.
;; The function `pgtk-use-im-context` MUST be called after a frame is
;; created, otherwise it will error. We hook it into `after-make-frame-functions`
;; to ensure it runs at the correct time, both on startup and for new frames
;; created by emacsclient in daemon mode.
;; (when (fboundp 'pgtk-use-im-context)
;;   (add-hook 'after-make-frame-functions
;;             (lambda (frame)
;;               (with-selected-frame frame
;;                 (pgtk-use-im-context nil)))))


;; Apply to common modes
(defun my/bidi-optimizations ()
  "Apply bidi optimizations for current buffer."
  (setq-local bidi-paragraph-direction 'left-to-right
              bidi-inhibit-bpa t))

(add-hook 'org-mode-hook #'my/bidi-optimizations)
(add-hook 'text-mode-hook #'my/bidi-optimizations)
(add-hook 'prog-mode-hook #'my/bidi-optimizations)

(setq-default long-line-threshold 1000
              large-hscroll-threshold 1000
              syntax-wholeline-max 1000)

(setq undo-limit 800000
      undo-strong-limit 1200000
      undo-outer-limit 120000000)

(setq fast-but-imprecise-scrolling t  ;; Trade accuracy for speed
      redisplay-skip-fontification-on-input t)  ;; Skip during rapid input

(setq highlight-nonselected-windows nil)
(setq blink-cursor-mode nil)

(setq frame-resize-pixelwise t)
(setq window-resize-pixelwise nil)

(setq byte-compile-warnings '(not obsolete))
(setq native-comp-async-report-warnings-errors 'silent)

(setq ffap-machine-p-known 'reject)

(setq inhibit-compacting-font-caches t)  ;; Don't compact font cache
#+end_src

** DONE Small Configs
#+begin_src emacs-lisp
;; Move backup files to dedicated directory
(setq backup-directory-alist `(("." . ,(expand-file-name ".backup" user-emacs-directory))))

;; Explicitly disable bzr, svn, hg to prevent TRAMP errors
(setq vc-handled-backends '(Git))

;; Automatically follow symlinks to version-controlled files (suppress prompt)
(setq vc-follow-symlinks t)

;; Confirmation settings
(setq confirm-kill-processes nil)  ;; Auto-kill processes on exit

;; Faster echo of keystrokes
(setq echo-keystrokes 0.1)

;; Don't create lockfiles
(setq-default create-lockfiles nil)

;; Compilation settings
(setq-default compilation-always-kill t
              compilation-ask-about-save nil
              compilation-scroll-output t)

;; Suppress redefinition warnings
(setq ad-redefinition-action 'accept)

;; Require final newline
(setq require-final-newline t)

;; Enable commands
(put 'erase-buffer 'disabled nil)

(delete-selection-mode 1)

;; File associations
(add-to-list 'auto-mode-alist '("\\.in\\'" . text-mode))
(add-to-list 'auto-mode-alist '("\\.out\\'" . text-mode))
(add-to-list 'auto-mode-alist '("\\.args\\'" . text-mode))
(add-to-list 'auto-mode-alist '("\\.bb\\'" . shell-script-mode))
(add-to-list 'auto-mode-alist '("\\.bbclass\\'" . shell-script-mode))
(add-to-list 'auto-mode-alist '("\\.Rmd\\'" . markdown-mode))
#+end_src

** DONE Garbage Collector Magic Hack
#+begin_src emacs-lisp
(use-package gcmh
  :hook (after-init . gcmh-mode)
  :init
  ;; Match early-init.el restoration value
  (setq gcmh-idle-delay 'auto
        gcmh-high-cons-threshold (* 80 1024 1024)))
#+end_src

** DONE UTF-8 Coding System
#+begin_src emacs-lisp
(set-selection-coding-system 'utf-8)
(prefer-coding-system 'utf-8)
(set-language-environment "UTF-8")
(set-default-coding-systems 'utf-8)
(set-terminal-coding-system 'utf-8)
(set-keyboard-coding-system 'utf-8)
(setq locale-coding-system 'utf-8)
#+end_src

** DONE Environment
#+begin_src emacs-lisp
(use-package exec-path-from-shell
  :custom
  (exec-path-from-shell-variables
   '("PATH" "MANPATH"
     "OPENAI_API_KEY" "ANTHROPIC_API_KEY"
     "XAI_API_KEY" "DEEPSEEK_API_KEY"
     "OPENROUTER_API_KEY" "GEMINI_API_KEY"))
  :config
  (when (daemonp)
    (exec-path-from-shell-initialize)))
#+end_src

** DONE Session Management
#+begin_src emacs-lisp
;; Save place
(use-package saveplace
  :straight (:type built-in)
  :hook (after-init . save-place-mode))

;; History with symlink resolution
(use-package recentf
  :straight (:type built-in)
  :hook (after-init . recentf-mode)
  :init
  (setq recentf-max-saved-items 300
        recentf-exclude
        '("\\.?cache" ".cask" "url" "COMMIT_EDITMSG\\'" "bookmarks"
          "\\.\\(?:gz\\|gif\\|svg\\|png\\|jpe?g\\|bmp\\|xpm\\)$"
          "\\.?ido\\.last$" "\\.revive$" "/G?TAGS$" "/.elfeed/"
          "^/tmp/" "^/var/folders/.+$" "^/ssh:" "/persp-confs/"
          (lambda (file) (file-in-directory-p file package-user-dir))))
  :config
  (push (expand-file-name recentf-save-file) recentf-exclude)

  ;; CRITICAL: Resolve symlinks FIRST, then abbreviate
  ;; This ensures ~/org/todo.org and ~/Git/.../org/todo.org become the same
  (setq recentf-filename-handlers
        '(file-truename        ; Resolve symlinks to real path
          abbreviate-file-name)) ; Then abbreviate for display

  ;; Prevent org-agenda files from cluttering recent files
  ;; Dashboard opens these files, triggering recentf
  (defun ar/exclude-org-agenda-files (file)
    "Exclude files in org-agenda-files from recentf."
    (when (bound-and-true-p org-agenda-files)
      (let ((file-true (file-truename file)))
        (cl-some (lambda (agenda-file)
                   (string= file-true (file-truename agenda-file)))
                 (org-agenda-files t)))))

  (add-to-list 'recentf-exclude #'ar/exclude-org-agenda-files))

(use-package savehist
  :straight (:type built-in)
  :hook (after-init . savehist-mode)
  :init
  (setq enable-recursive-minibuffers t
        history-length 1000
        savehist-additional-variables '(mark-ring
                                        global-mark-ring
                                        search-ring
                                        regexp-search-ring
                                        extended-command-history)
        savehist-autosave-interval 300))
#+end_src

** DONE Misc
#+begin_src emacs-lisp
(use-package simple
  :straight (:type built-in)
  :hook ((text-mode . visual-line-mode)
         ((prog-mode markdown-mode conf-mode) . enable-trailing-whitespace))
  :init
  (setq column-number-mode t
        line-number-mode t
        kill-whole-line t
        line-move-visual nil
        track-eol t
        set-mark-command-repeat-pop t)

  (setq-default show-trailing-whitespace nil)
  (defun enable-trailing-whitespace ()
    (setq show-trailing-whitespace t)
    (add-hook 'before-save-hook #'delete-trailing-whitespace nil t))

  ;; Prettify the process list
  (with-no-warnings
    (defun my-list-processes--prettify ()
      (when-let* ((entries tabulated-list-entries))
        (setq tabulated-list-entries nil)
        (dolist (p (process-list))
          (when-let* ((val (cadr (assoc p entries)))
                      (name (aref val 0))
                      (pid (aref val 1))
                      (status (aref val 2))
                      (status (list status 'face
                                    (if (memq status '(stop exit closed failed)) 'error 'success)))
                      (buf-label (aref val 3))
                      (tty (list (aref val 4) 'face 'font-lock-doc-face))
                      (thread (list (aref val 5) 'face 'font-lock-doc-face))
                      (cmd (list (aref val 6) 'face 'completions-annotations)))
            (push (list p (vector name pid status buf-label tty thread cmd))
		          tabulated-list-entries)))))
    (advice-add #'list-processes--refresh :after #'my-list-processes--prettify)))

;; Misc Settings
(if (boundp 'use-short-answers)
    (setq use-short-answers t)
  (fset 'yes-or-no-p 'y-or-n-p))

(setq-default major-mode 'text-mode
              fill-column 80
              tab-width 4
              indent-tabs-mode nil)

;; Silence the Bell
(setq visible-bell nil)
(setq ring-bell-function #'ignore)

;; Suppress "End/Beginning of buffer" Messages
(setq command-error-function
      (lambda (data context caller)
        (when (not (memq (car data) '(beginning-of-buffer end-of-buffer)))
          (command-error-default-function data context caller))))

;; Removes <dir> style
(setq uniquify-buffer-name-style 'forward)

;; Other Misc
(setq inhibit-compacting-font-caches t
      delete-by-moving-to-trash t
      make-backup-files nil
      auto-save-default nil
      adaptive-fill-regexp "[ t]+|[ t]*([0-9]+.|*+)[ t]*"
      adaptive-fill-first-line-regexp "^* *$"
      sentence-end "\\([。！？]\\|……\\|[.?!][]\"')}]*\\($\\|[ \t]\\)\\)[ \t\n]*"
      sentence-end-double-space nil
      word-wrap-by-category t)
#+end_src

** DONE Setup User
#+begin_src emacs-lisp
(setq user-full-name "Ahsanur Rahman"
      user-mail-address "ahsanur041@proton.me")
#+end_src

** DONE Title
#+begin_src emacs-lisp
(setq frame-title-format '("Emacs - %b")
      icon-title-format frame-title-format)
#+end_src

* DONE Vim Emulation
** DONE Undo Fu
#+begin_src emacs-lisp
(use-package undo-fu :defer t)

(use-package undo-fu-session
  :commands undo-fu-session-global-mode
  :hook (after-init . undo-fu-session-global-mode))
#+end_src

** DONE Goto Chg
#+begin_src emacs-lisp
(use-package goto-chg
  :after evil
  :commands (goto-last-change goto-last-change-reverse)
  :config
  (evil-define-key 'normal 'global (kbd "g;") 'goto-last-change)
  (evil-define-key 'normal 'global (kbd "g,") 'goto-last-change-reverse))
#+end_src

** DONE Evil
#+begin_src emacs-lisp
(setq evil-undo-system 'undo-fu)

(use-package evil
  :init
  (setq evil-want-integration t)
  (setq evil-want-keybinding nil)

  :custom
  (evil-ex-visual-char-range t)
  (evil-ex-search-vim-style-regexp t)
  (evil-split-window-below t)
  (evil-vsplit-window-right t)
  (evil-echo-state nil)
  (evil-move-cursor-back nil)
  (evil-v$-excludes-newline t)
  (evil-want-C-h-delete t)
  (evil-want-C-u-delete t)
  (evil-want-fine-undo t)
  (evil-move-beyond-eol t)
  (evil-search-wrap nil)
  (evil-want-Y-yank-to-eol t)
  :config
  (evil-mode 1)
  (evil-select-search-module 'evil-search-module 'isearch))
#+end_src

** DONE Evil Collection
#+begin_src emacs-lisp
(use-package evil-collection
  :ensure t
  :config
  (evil-collection-init))
#+end_src

** DONE Evil Surround
#+begin_src emacs-lisp
(use-package evil-surround
  :after evil
  :commands global-evil-surround-mode
  :custom
  (evil-surround-pairs-alist
   '((?\( . ("(" . ")"))
     (?\[ . ("[" . "]"))
     (?\{ . ("{" . "}"))

     (?\) . ("(" . ")"))
     (?\] . ("[" . "]"))
     (?\} . ("{" . "}"))

     (?< . ("<" . ">"))
     (?> . ("<" . ">"))))
  :config (global-evil-surround-mode 1))
#+end_src

** DONE Evil Args
#+begin_src emacs-lisp
(use-package evil-args
  :after evil
  :config
  ;; Bind text objects to 'a' (argument)
  (define-key evil-inner-text-objects-map "a" 'evil-inner-arg)
  (define-key evil-outer-text-objects-map "a" 'evil-outer-arg))
#+end_src

** DONE Evil Numbers
#+begin_src emacs-lisp
;; Increment/Decrement numbers with C-a/C-x
(use-package evil-numbers
  :after evil
  :config
  (define-key evil-normal-state-map (kbd "C-a") 'evil-numbers/inc-at-pt)
  (define-key evil-normal-state-map (kbd "C-x") 'evil-numbers/dec-at-pt))
#+end_src

** DONE Evil Exchange
#+begin_src emacs-lisp
;; Swap two regions of text with 'gx'
(use-package evil-exchange
  :after evil
  :config
  (evil-exchange-install))
#+end_src

** DONE Evil Goggles
#+begin_src emacs-lisp
;; Visual feedback when editing (pulsing regions on yank/paste)
(use-package evil-goggles
  :after evil
  :config
  (evil-goggles-mode)
  (setq evil-goggles-duration 0.1))
#+end_src

** DONE Evil Lion
#+begin_src emacs-lisp
;; Align text with 'gl' (e.g., 'glip=' aligns paragraph on = signs)
(use-package evil-lion
  :after evil
  :config
  (evil-lion-mode))
#+end_src

** DONE Evil Window Movement Enhancements
#+begin_src emacs-lisp
(defcustom ar/evil-want-move-window-to-wrap-around nil
  "If non-nil, window movement commands wrap around."
  :type 'boolean
  :group 'evil)

(defun ar/evil-window-move-left ()
  "Move to window on the left, wrapping if needed."
  (interactive)
  (if (and ar/evil-want-move-window-to-wrap-around
           (not (ignore-errors (windmove-left))))
      (evil-window-bottom-right)
    (windmove-left)))

(defun ar/evil-window-move-right ()
  "Move to window on the right, wrapping if needed."
  (interactive)
  (if (and ar/evil-want-move-window-to-wrap-around
           (not (ignore-errors (windmove-right))))
      (evil-window-top-left)
    (windmove-right)))

(defun ar/evil-window-move-up ()
  "Move to window above, wrapping if needed."
  (interactive)
  (if (and ar/evil-want-move-window-to-wrap-around
           (not (ignore-errors (windmove-up))))
      (evil-window-bottom-right)
    (windmove-up)))

(defun ar/evil-window-move-down ()
  "Move to window below, wrapping if needed."
  (interactive)
  (if (and ar/evil-want-move-window-to-wrap-around
           (not (ignore-errors (windmove-down))))
      (evil-window-top-left)
    (windmove-down)))
#+end_src

** DONE Native Commenting Operator
#+begin_src emacs-lisp
(with-eval-after-load 'evil
  (evil-define-operator ar/evil-comment-operator (beg end type)
    "Toggle comment for the region defined by BEG and END."
    :move-point nil
    (interactive "<R>")
    (comment-or-uncomment-region beg end))

  ;; Bind 'gc' to this operator
  (define-key evil-normal-state-map (kbd "gc") #'ar/evil-comment-operator)
  ;; Bind 'gc' in visual mode to ensure it works on selections
  (define-key evil-visual-state-map (kbd "gc") #'ar/evil-comment-operator))
#+end_src

** DONE Smart Comment Continuation
#+begin_src emacs-lisp
(defcustom ar/evil-want-o/O-to-continue-comments t
  "If non-nil, o/O keys will continue comment lines."
  :type 'boolean
  :group 'evil)

(defun ar/evil-open-below-smart ()
  "Open line below. If in a comment, continue it using Emacs native logic."
  (interactive)
  (if (and ar/evil-want-o/O-to-continue-comments
           (save-excursion (comment-beginning)))
      (progn
        (end-of-line)
        ;; Delegates to Emacs' native 'M-j' behavior, which handles
        ;; every language's comment syntax (;;, //, #, *) perfectly.
        (comment-indent-new-line)
        (evil-insert-state))
    (evil-open-below 1)))

(defun ar/evil-open-above-smart ()
  "Open line above. If in a comment, continue it using Emacs native logic."
  (interactive)
  (if (and ar/evil-want-o/O-to-continue-comments
           (save-excursion (comment-beginning)))
      (progn
        (beginning-of-line)
        ;; Split the current comment line from above
        (comment-indent-new-line)
        ;; Move to the upper line (the new one)
        (forward-line -1)
        (indent-according-to-mode)
        (evil-insert-state))
    (evil-open-above 1)))

(with-eval-after-load 'evil
  (define-key evil-normal-state-map "o" #'ar/evil-open-below-smart)
  (define-key evil-normal-state-map "O" #'ar/evil-open-above-smart))
#+end_src

* Editor Behaviour
** DONE Child Frame
#+begin_src emacs-lisp
(use-package posframe
  :defer t
  :init
  (defface posframe-border
    `((t (:inherit region)))
    "Face used by the `posframe' border."
    :group 'posframe)
  (defvar posframe-border-width 1
    "Default posframe border width.")
  :config
  (with-no-warnings
    (defun my-posframe--prettify-frame (&rest _)
      (set-face-background 'fringe nil posframe--frame))
    (advice-add #'posframe--create-posframe :after #'my-posframe--prettify-frame)

    (defun posframe-poshandler-frame-center-near-bottom (info)
      (cons (/ (- (plist-get info :parent-frame-width)
                  (plist-get info :posframe-width))
               2)
            (/ (+ (plist-get info :parent-frame-height)
                  (* 2 (plist-get info :font-height)))
               2)))))
#+end_src

** DONE Remap C-g to Escape
#+begin_src emacs-lisp
(keymap-set key-translation-map "C-g" "<escape>")
(keymap-global-set "C-M-g" #'keyboard-quit)
#+end_src

** DONE Nerd Icons
#+begin_src emacs-lisp
(use-package nerd-icons
  :custom
  (nerd-icons-font-family "Symbols Nerd Font Mono")
  (nerd-icons-color-icons t))
#+end_src

** DONE Transient
#+begin_src emacs-lisp
(use-package transient
  :bind ("<f6>" . ar/toggles-transient)
  :init
  (setq resize-mini-windows t)

  :config
  (require 'nerd-icons)
  (defun ar/transient-title ()
    (concat
     (if (fboundp 'nerd-icons-faicon)
         (nerd-icons-faicon "nf-fa-toggle_on" :face 'transient-heading :v-adjust 0.02)
       "")
     (propertize " Emacs Toggles" 'face 'transient-heading)))

  (defun ar/toggle-whitespace ()
    (interactive)
    (setq show-trailing-whitespace (not show-trailing-whitespace))
    (redraw-display)
    (message "Trailing whitespace %s" (if show-trailing-whitespace "ON" "OFF")))

  (defun ar/toggle-line-numbers ()
    "Toggle line numbers (Relative -> Absolute -> Off)."
    (interactive)
    (cond
     ((bound-and-true-p display-line-numbers-mode)
      (if (eq display-line-numbers 'relative)
          (setq display-line-numbers t)
        (display-line-numbers-mode -1)))
     (t
      (display-line-numbers-mode 1)
      (setq display-line-numbers 'relative))))

  (transient-define-prefix ar/toggles-transient ()
    "Global Toggles and Actions"
    [:description ar/transient-title

     ["Basic"
      ("n" "Line numbers" ar/toggle-line-numbers :transient t)
      ("a" "Aggressive indent" global-aggressive-indent-mode :transient t
       :if (lambda () (fboundp 'global-aggressive-indent-mode)))
      ("d" "Hungry delete" global-hungry-delete-mode :transient t
       :if (lambda () (fboundp 'global-hungry-delete-mode)))
      ("e" "Electric pair" electric-pair-mode :transient t)
      ("c" "Spell check" flyspell-mode :transient t
       :if (lambda () (fboundp 'flyspell-mode)))
      ("s" "Pretty symbol" prettify-symbols-mode :transient t)
      ("l" "Page break lines" global-page-break-lines-mode :transient t
       :if (lambda () (fboundp 'global-page-break-lines-mode)))
      ("b" "Battery" display-battery-mode :transient t)
      ("i" "Time" display-time-mode :transient t)
      ("m" "Modeline" (lambda () (interactive)
                        (if (bound-and-true-p doom-modeline-mode)
                            (doom-modeline-mode -1)
                          (doom-modeline-mode 1)))
       :transient t :if (lambda () (fboundp 'doom-modeline-mode)))]

     ["Highlight"
      ("h l" "Line" global-hl-line-mode :transient t)
      ("h p" "Paren" show-paren-mode :transient t)
      ("h s" "Symbol" symbol-overlay-mode :transient t
       :if (lambda () (fboundp 'symbol-overlay-mode)))
      ("h r" "Rainbow" rainbow-mode :transient t
       :if (lambda () (fboundp 'rainbow-mode)))
      ("h w" "Whitespace" ar/toggle-whitespace :transient t)
      ("h d" "Delimiters" rainbow-delimiters-mode :transient t
       :if (lambda () (fboundp 'rainbow-delimiters-mode)))
      ("h i" "Indent guides" indent-bars-mode :transient t
       :if (lambda () (fboundp 'indent-bars-mode)))
      ("h t" "Todo" global-hl-todo-mode :transient t
       :if (lambda () (fboundp 'global-hl-todo-mode)))]

     ["Program"
      ("f" "Flymake" flymake-mode :transient t)
      ("O" "Hideshow" hs-minor-mode :transient t)
      ("u" "Subword" subword-mode :transient t)
      ("W" "Which func" which-function-mode :transient t)
      ("E" "Debug on error" toggle-debug-on-error :transient t)
      ("Q" "Debug on quit" toggle-debug-on-quit :transient t)
      ("v" "Gutter" diff-hl-mode :transient t
       :if (lambda () (fboundp 'diff-hl-mode)))]

     ["Theme"
      ("t d" "Light (Modus)" (lambda () (interactive) (load-theme 'modus-operandi t)))
      ("t k" "Dark (Modus)" (lambda () (interactive) (load-theme 'modus-vivendi t)))
      ("t n" "Tokyo Night" (lambda () (interactive) (load-theme 'doom-tokyo-night t)))
      ("t t" "Tango" (lambda () (interactive) (load-theme 'tango t)))
      ("t g" "Tango-dark" (lambda () (interactive) (load-theme 'tango-dark t)))
      ("t l" "Leuven" (lambda () (interactive) (load-theme 'leuven t)))
      ("t D" "Deeper-blue" (lambda () (interactive) (load-theme 'deeper-blue t)))
      ("t o" "Other..." load-theme)
      ("t c" "Customize" customize-themes)
      ("t u" "Unload all" (lambda () (interactive) (mapc #'disable-theme custom-enabled-themes)))]

     ["Package"
      ("p r" "Refresh archives" package-refresh-contents)
      ("p l" "List packages" package-list-packages)
      ("p i" "Install package" package-install)
      ("p d" "Delete package" package-delete)
      ("p a" "Autoremove" package-autoremove)
      ;; Hidden Toggle
      ("<f6>" "" transient-quit-one :format " ")]]))
#+end_src

** DONE Cross Referencing Commands
#+begin_src emacs-lisp
(use-package xref
  :straight (:type built-in)
  :defer t
  :autoload xref-show-definitions-completing-read
  :bind (("M-g ." . xref-find-definitions)
         ("M-g ," . xref-go-back))
  :init
  ;; Use faster search tool
  (when (executable-find "rg")
    (setq xref-search-program 'ripgrep))

  ;; Select from xref candidates in minibuffer
  (setq xref-show-definitions-function #'xref-show-definitions-completing-read
        xref-show-xrefs-function #'xref-show-definitions-completing-read))
#+end_src

** DONE Autorevert
#+begin_src emacs-lisp
(use-package autorevert
  :straight (:type built-in)
  :hook (after-init . global-auto-revert-mode))
#+end_src

** DONE Avy/Ace
#+begin_src emacs-lisp
;; Jump to things in Emacs tree-style
(use-package avy
  :hook (after-init . avy-setup-default)
  :config (setq avy-all-windows nil
                avy-all-windows-alt t
                avy-background t
                avy-style 'pre))

;; Kill text between the point and the character CHAR
(use-package avy-zap
  :defer t)

;; Quickly follow links
(use-package ace-link
  :hook (after-init . ace-link-setup-default))
#+end_src

** DONE Anzu
#+begin_src emacs-lisp
(use-package anzu
  :bind (([remap query-replace] . anzu-query-replace)
         ([remap query-replace-regexp] . anzu-query-replace-regexp)
         :map isearch-mode-map
         ([remap isearch-query-replace] . anzu-isearch-query-replace)
         ([remap isearch-query-replace-regexp] . anzu-isearch-query-replace-regexp))
  :hook (after-init . global-anzu-mode))

(use-package evil-anzu :after evil)
#+end_src

** DONE Automatic parenthesis pairing
#+begin_src emacs-lisp
(use-package elec-pair
  :straight (:type built-in)
  :hook (after-init . electric-pair-mode)
  :init (setq electric-pair-inhibit-predicate 'electric-pair-conservative-inhibit))
#+end_src

** DONE Edit multiple regions simultaneously
#+begin_src emacs-lisp
(use-package iedit :defer t)
#+end_src

** DONE Sudo edit
#+begin_src emacs-lisp
(use-package sudo-edit :defer t)
#+end_src

** DONE Subword: Handling capitalized subwords in a nomenclature
#+begin_src emacs-lisp
(use-package subword
  :straight (:type built-in)
  :hook ((prog-mode . subword-mode)
         (minibuffer-setup . subword-mode)))
#+end_src

** DONE Buffer Terminator
#+begin_src emacs-lisp
(use-package buffer-terminator
  :defer t
  :hook (after-init . buffer-terminator-mode)
  :custom
  (buffer-terminator-verbose nil)
  (buffer-terminator-inactivity-timeout (* 30 60))
  (buffer-terminator-interval (* 10 60)))
#+end_src

** DONE Helpful
#+begin_src emacs-lisp
(use-package helpful
  :defer t
  :commands (helpful-callable
             helpful-variable
             helpful-key
             helpful-command
             helpful-at-point
             helpful-function)
  :bind
  ([remap describe-command] . helpful-command)
  ([remap describe-function] . helpful-callable)
  ([remap describe-key] . helpful-key)
  ([remap describe-symbol] . helpful-symbol)
  ([remap describe-variable] . helpful-variable)
  :custom
  (helpful-max-buffers 7))
#+end_src

** DONE Jinx
#+begin_src emacs-lisp
(use-package jinx
  :hook (after-init . jinx-mode)
  :custom
  ;; Sensibly disable Jinx in modes where spell-checking is not desired.
  ;; This includes programming modes, UI-centric modes, and special buffers.
  (jinx-disabled-modes
   '(prog-mode           ; All programming modes
     conf-mode           ; All configuration file modes
     emacs-lisp-mode     ; Specifically for elisp
     dired-mode          ; File manager
     ibuffer-mode        ; Buffer list
     neotree-mode        ; File tree
     magit-status-mode   ; Magit UI
     magit-log-mode
     magit-diff-mode
     magit-branch-mode
     org-agenda-mode     ; Agenda view is not for writing
     org-src-mode        ; Don't check inside code blocks
     dashboard-mode      ; Startup dashboard
     which-key-mode      ; Keybinding helper
     help-mode           ; Help buffers
     Info-mode           ; Info documentation
     embark-collect-mode ; Embark's special buffer
     vterm-mode          ; Terminal emulator
     pdf-view-mode))     ; PDF viewer

    ;; Ensure the personal dictionary file exists, creating it if necessary.
  (let ((dict-file (expand-file-name "dict.txt" user-emacs-directory)))
    (unless (file-exists-p dict-file)
      (write-region "" nil dict-file))))
#+end_src

** DONE Stripspace
#+begin_src emacs-lisp
(use-package stripspace
  :commands stripspace-local-mode
  :hook ((prog-mode . stripspace-local-mode)
         (text-mode . stripspace-local-mode)
         (conf-mode . stripspace-local-mode))
  :custom
  (stripspace-only-if-initially-clean nil)
  (stripspace-restore-column t))
#+end_src

** DONE Fonts
#+begin_src emacs-lisp
(defun ar/set-fonts ()
  "Set the default, fixed-pitch, and variable-pitch fonts for the current frame."
  (set-face-attribute 'default nil :font "JetBrains Mono" :height 125 :weight 'medium)
  (set-face-attribute 'fixed-pitch nil :font "JetBrains Mono" :height 125 :weight 'medium)
  (set-face-attribute 'variable-pitch nil :font "JetBrains Mono" :height 125 :weight 'medium)
  ;; Apply italic slant to comments and keywords
  (set-face-attribute 'font-lock-comment-face nil :slant 'italic)
  (set-face-attribute 'font-lock-keyword-face nil :slant 'italic))

(if (daemonp)
    (add-hook 'emacs-startup-hook
              (lambda ()
                (add-hook 'after-make-frame-functions
                          (lambda (frame)
                            (with-selected-frame frame (ar/set-fonts))))))
  ;; For non-daemon mode, set fonts immediately
  (ar/set-fonts))

;; Line spacing
(setq-default line-spacing 0.02)

;; Font settings
(setq font-lock-maximum-decoration t
      inhibit-compacting-font-caches t)
#+end_src

** DONE Doom Themes
#+begin_src emacs-lisp
(use-package doom-themes
  :custom
  (doom-themes-enable-bold t)
  (doom-themes-enable-italic t)
  (doom-themes-treemacs-theme "doom-atom")
  :config
  (load-theme 'doom-tokyo-night t)
  (doom-themes-neotree-config)
  (doom-themes-treemacs-config)
  (doom-themes-org-config))
#+end_src

** DONE Solaire Mode
#+begin_src emacs-lisp
(use-package solaire-mode
  :hook (after-init . solaire-global-mode))
#+end_src

** DONE Modeline
#+begin_src emacs-lisp
(size-indication-mode -1)
(setq-default mode-line-percent-position nil)

(use-package doom-modeline
  :hook (after-init . doom-modeline-mode)
  :hook (doom-modeline-mode . column-number-mode)
  :init
  (setq doom-modeline-bar-width 3
        doom-modeline-github nil
        doom-modeline-mu4e nil
        doom-modeline-persp-name nil
        doom-modeline-minor-modes nil
        doom-modeline-major-mode-icon t
        doom-modeline-icon t
        doom-modeline-buffer-file-name-style 'relative-from-project)
  :config
  (setq doom-modeline-height 25
        doom-modeline-column-zero-based nil
        doom-modeline-bar-width 3
        doom-modeline-buffer-file-size nil
        doom-modeline-buffer-encoding nil
        doom-modeline-percent-position nil
        doom-modeline-vcs-icon t
        doom-modeline-vcs-max-length 0))
#+end_src

** DONE Hide Modeline
#+begin_src emacs-lisp
(use-package hide-mode-line
  :autoload turn-off-hide-mode-line-mode
  :hook (((eat-mode org-agenda-mode
           eshell-mode shell-mode
           term-mode vterm-mode
           embark-collect-mode lsp-ui-imenu-mode
           pdf-annot-list-mode) . turn-on-hide-mode-line-mode)))
#+end_src

** DONE Line Numbers
#+begin_src emacs-lisp
(use-package display-line-numbers
  :straight (:type built-in)
  :hook ((prog-mode
          conf-mode toml-ts-mode
          yaml-mode yaml-ts-mode)
         . display-line-numbers-mode)
  :init (setq display-line-numbers-width-start t))
#+end_src

** DONE Display dividers between windows
#+begin_src emacs-lisp
(setq window-divider-default-places t
      window-divider-default-bottom-width 1
      window-divider-default-right-width 1)
(add-hook 'window-setup-hook #'window-divider-mode)
#+end_src

** DONE Text Scaling
#+begin_src emacs-lisp
(use-package default-text-scale
  :hook (after-init . default-text-scale-mode))
#+end_src

** DONE Scrolling
#+begin_src emacs-lisp
;; Scroll one line at a time (less "jumpy" than defaults)
(setq hscroll-step 1
      hscroll-margin 2
      scroll-step 1
      scroll-margin 0
      scroll-conservatively 100000
      scroll-preserve-screen-position t
      auto-window-vscroll nil
      ;; mouse
      mouse-wheel-scroll-amount-horizontal 1
      mouse-wheel-progressive-speed nil)

;; Smooth scrolling
(when (fboundp 'pixel-scroll-precision-mode) ;; 29+
  (use-package ultra-scroll
    :functions (hl-todo-mode diff-hl-flydiff-mode)
    :hook (after-init . ultra-scroll-mode)
    :config
    (add-hook 'ultra-scroll-hide-functions #'diff-hl-flydiff-mode)
    (add-hook 'ultra-scroll-hide-functions #'hl-todo-mode)
    (add-hook 'ultra-scroll-hide-functions #'jit-lock-mode)))

#+end_src
** DONE Dashboard
#+begin_src emacs-lisp
(use-package dashboard
  :init
  (setq dashboard-banner-logo-title "Welcome to Emacs!")
  (setq dashboard-startup-banner 'logo)
  (setq dashboard-items '((recents   . 10)
                         (bookmarks . 3)
                         (projects  . 6)
                         (agenda    . 5)))

  ;; CRITICAL: Close org files after reading them for agenda
  (setq dashboard-agenda-release-buffers t)

  (setq dashboard-center-content t)
  (setq dashboard-set-heading-icons t)
  (setq dashboard-set-file-icons t)
  (setq dashboard-icon-type 'nerd-icons)

  :config
  ;; CRITICAL FIX: Suppress "Followed link to" messages in daemon mode
  (defun ar/dashboard-setup-startup-hook-quiet ()
    "Setup dashboard but suppress messages during daemon startup."
    (if (daemonp)
        ;; In daemon mode: suppress all messages during dashboard init
        (let ((inhibit-message t)
              (message-log-max nil))  ; Don't even log to *Messages*
          (dashboard-setup-startup-hook))
      ;; Normal mode: show messages as usual
      (dashboard-setup-startup-hook)))

  (ar/dashboard-setup-startup-hook-quiet)

  ;; FIX: Use get-buffer-create instead of get-buffer to avoid nil error
  ;; This creates the buffer if it doesn't exist
  ;; Also handle command-line files gracefully
  (setq initial-buffer-choice
        (lambda ()
          ;; If files were passed on command line, don't force dashboard
          (if (> (length command-line-args) 2)
              nil
            (get-buffer-create "*dashboard*")))))

#+end_src

** DONE Highlight the current line
#+begin_src emacs-lisp
(use-package hl-line
  :straight (:type built-in)
  :hook ((after-init . global-hl-line-mode)
         ((dashboard-mode eshell-mode shell-mode term-mode vterm-mode) .
          (lambda () (setq-local global-hl-line-mode nil))))
  :config
  ;; CRITICAL FIX: Disable hl-line in Evil Visual mode.
  ;; Otherwise, the current line highlight masks the selection, making it look
  ;; like the selection starts "late" or is broken.
  (defun ar/disable-hl-line-in-visual ()
    (when (bound-and-true-p hl-line-mode)
      (hl-line-mode -1)
      (setq-local ar/hl-line-was-on t)))

  (defun ar/enable-hl-line-after-visual ()
    (when (bound-and-true-p ar/hl-line-was-on)
      (hl-line-mode 1)
      (kill-local-variable 'ar/hl-line-was-on)))

  (add-hook 'evil-visual-state-entry-hook #'ar/disable-hl-line-in-visual)
  (add-hook 'evil-visual-state-exit-hook #'ar/enable-hl-line-after-visual))
#+end_src

** DONE Prettify Symbols
#+begin_src emacs-lisp
(defun my/org-prettify-src-blocks ()
  "Prettify org-mode src block delimiters using font-lock and nerd-icons."
  (font-lock-add-keywords nil
    '(;; #+begin_src (with language name)
      ("^[ \t]*\\(#\\+begin_src\\)[ \t]*.*$"
       (1 (prog1 nil
            (let ((icon (nerd-icons-codicon "nf-cod-code")))
              (compose-region (match-beginning 1) (match-end 1) icon)
              (put-text-property (match-beginning 1) (match-end 1)
                                'face '(:foreground "#9ece6a"))))))
      ;; #+end_src
      ("^[ \t]*\\(#\\+end_src\\)[ \t]*$"
       (1 (prog1 nil
            (let ((icon (nerd-icons-codicon "nf-cod-code")))
              (compose-region (match-beginning 1) (match-end 1) icon)
              (put-text-property (match-beginning 1) (match-end 1)
                                'face '(:foreground "#9ece6a"))))))
      ;; #+BEGIN_SRC (uppercase)
      ("^[ \t]*\\(#\\+BEGIN_SRC\\)[ \t]*.*$"
       (1 (prog1 nil
            (let ((icon (nerd-icons-codicon "nf-cod-file_code")))
              (compose-region (match-beginning 1) (match-end 1) icon)
              (put-text-property (match-beginning 1) (match-end 1)
                                'face '(:foreground "#9ece6a"))))))
      ;; #+END_SRC (uppercase)
      ("^[ \t]*\\(#\\+END_SRC\\)[ \t]*$"
       (1 (prog1 nil
            (let ((icon (nerd-icons-codicon "nf-cod-file_code")))
              (compose-region (match-beginning 1) (match-end 1) icon)
              (put-text-property (match-beginning 1) (match-end 1)
                                'face '(:foreground "#7aa2f7"))))))
      ;; #+begin_example
      ("^[ \t]*\\(#\\+begin_example\\)[ \t]*$"
       (1 (prog1 nil
            (let ((icon (nerd-icons-faicon "nf-fa-quote_left")))
              (compose-region (match-beginning 1) (match-end 1) icon)
              (put-text-property (match-beginning 1) (match-end 1)
                                'face '(:foreground "#bb9af7"))))))
      ;; #+end_example
      ("^[ \t]*\\(#\\+end_example\\)[ \t]*$"
       (1 (prog1 nil
            (let ((icon (nerd-icons-faicon "nf-fa-quote_right")))
              (compose-region (match-beginning 1) (match-end 1) icon)
              (put-text-property (match-beginning 1) (match-end 1)
                                'face '(:foreground "#bb9af7"))))))
      ;; #+BEGIN_EXAMPLE
      ("^[ \t]*\\(#\\+BEGIN_EXAMPLE\\)[ \t]*$"
       (1 (prog1 nil
            (let ((icon (nerd-icons-faicon "nf-fa-quote_left")))
              (compose-region (match-beginning 1) (match-end 1) icon)
              (put-text-property (match-beginning 1) (match-end 1)
                                'face '(:foreground "#bb9af7"))))))
      ;; #+END_EXAMPLE
      ("^[ \t]*\\(#\\+END_EXAMPLE\\)[ \t]*$"
       (1 (prog1 nil
            (let ((icon (nerd-icons-faicon "nf-fa-quote_right")))
              (compose-region (match-beginning 1) (match-end 1) icon)
              (put-text-property (match-beginning 1) (match-end 1)
                                'face '(:foreground "#bb9af7"))))))
      ;; #+header: or #+HEADER:
      ("^[ \t]*\\(#\\+\\(?:header\\|HEADER\\):\\)[ \t]*"
       (1 (prog1 nil
            (let ((icon (nerd-icons-mdicon "nf-md-cog")))
              (compose-region (match-beginning 1) (match-end 1) icon)
              (put-text-property (match-beginning 1) (match-end 1)
                                'face '(:foreground "#e0af68"))))))
      ;; #+results: or #+RESULTS:
      ("^[ \t]*\\(#\\+\\(?:results\\|RESULTS\\):\\)[ \t]*"
       (1 (prog1 nil
            (let ((icon (nerd-icons-mdicon "nf-md-chart_line")))
              (compose-region (match-beginning 1) (match-end 1) icon)
              (put-text-property (match-beginning 1) (match-end 1)
                                'face '(:foreground "#7dcfff"))))))
      ;; #+call: or #+CALL:
      ("^[ \t]*\\(#\\+\\(?:call\\|CALL\\):\\)[ \t]*"
       (1 (prog1 nil
            (let ((icon (nerd-icons-mdicon "nf-md-phone")))
              (compose-region (match-beginning 1) (match-end 1) icon)
              (put-text-property (match-beginning 1) (match-end 1)
                                'face '(:foreground "#9aa5ce"))))))
      ;; :PROPERTIES: or :properties:
      ("^[ \t]*\\(:\\(?:PROPERTIES\\|properties\\):\\)[ \t]*$"
       (1 (prog1 nil
            (let ((icon (nerd-icons-mdicon "nf-md-folder_cog")))
              (compose-region (match-beginning 1) (match-end 1) icon)
              (put-text-property (match-beginning 1) (match-end 1)
                                'face '(:foreground "#ff9e64"))))))
      ;; :LOGBOOK: or :logbook:
      ("^[ \t]*\\(:\\(?:LOGBOOK\\|logbook\\):\\)[ \t]*$"
       (1 (prog1 nil
            (let ((icon (nerd-icons-mdicon "nf-md-notebook")))
              (compose-region (match-beginning 1) (match-end 1) icon)
              (put-text-property (match-beginning 1) (match-end 1)
                                'face '(:foreground "#9ece6a")))))))
    'append))

(defvar-local my/org-prettify-overlays-to-restore nil
  "List of overlays to restore after cursor leaves.")

(defun my/org-reveal-composition-at-point ()
  "Remove composition from current line if on a prettified org element."
  (when (and (eq major-mode 'org-mode)
             (save-excursion
               (beginning-of-line)
               (looking-at "^[ \t]*\\(?:#\\+\\(?:begin_src\\|end_src\\|BEGIN_SRC\\|END_SRC\\|begin_example\\|end_example\\|BEGIN_EXAMPLE\\|END_EXAMPLE\\|\\(?:header\\|HEADER\\|results\\|RESULTS\\|call\\|CALL\\):\\)\\|:\\(?:PROPERTIES\\|properties\\|LOGBOOK\\|logbook\\):\\)")))
    (let ((line-start (line-beginning-position))
          (line-end (line-end-position)))
      ;; Store the composition for restoration
      (setq my/org-prettify-overlays-to-restore
            (list line-start line-end
                  (get-text-property line-start 'composition)))
      ;; Remove composition
      (with-silent-modifications
        (remove-text-properties line-start line-end '(composition nil face nil))))))

(defun my/org-restore-composition-at-point ()
  "Restore composition after leaving the line."
  (when my/org-prettify-overlays-to-restore
    (let ((line-start (line-beginning-position))
          (line-end (line-end-position))
          (old-line-start (nth 0 my/org-prettify-overlays-to-restore))
          (old-line-end (nth 1 my/org-prettify-overlays-to-restore)))
      ;; Only restore if we've moved to a different line
      (when (or (< line-end old-line-start)
                (> line-start old-line-end))
        ;; Trigger font-lock to reapply
        (font-lock-flush old-line-start old-line-end)
        (setq my/org-prettify-overlays-to-restore nil)))))

(defun my/org-setup-prettify-cursor-sensor ()
  "Setup cursor sensor for revealing compositions."
  (add-hook 'post-command-hook #'my/org-reveal-composition-at-point nil t)
  (add-hook 'post-command-hook #'my/org-restore-composition-at-point nil t))

(defun my/org-prettify-setup ()
  "Complete setup for org-mode prettification."
  (my/org-prettify-src-blocks)
  (my/org-setup-prettify-cursor-sensor))

;; Add to org-mode hook
(add-hook 'org-mode-hook #'my/org-prettify-setup)
#+end_src

** Ediff
#+begin_src emacs-lisp
(use-package ediff
  :straight (:type built-in)
  :custom
  (ediff-window-setup-function 'ediff-setup-windows-plain)
  (ediff-split-window-function 'split-window-horizontally)
  :hook (ediff-startup . (lambda ()
                          (ediff-toggle-help))))
#+end_src

** Scroll Mode
#+begin_src emacs-lisp
(use-package scroll-all
  :defer t
  :hook ((ediff-startup . scroll-all-mode)
         (ediff-quit . (lambda () (scroll-all-mode -1))))
  :config
  (setq scroll-preserve-screen-position t
        scroll-conservatively 0))
#+end_src


* DONE Markdown
#+begin_src emacs-lisp
(use-package markdown-mode
  :defer t
  :mode (("README\\.md\\'" . gfm-mode)
         ("\\.md\\'" . markdown-mode)
         ("\\.markdown\\'" . markdown-mode))
  :init
  ;; Basic settings
  (setq markdown-italic-underscore t
        markdown-asymmetric-header t
        markdown-fontify-code-blocks-natively t
        markdown-gfm-uppercase-checkbox t
        markdown-enable-math nil
        markdown-header-scaling t
        markdown-header-scaling-values '(1.2 1.15 1.1 1.05 1.0 1.0)
        markdown-display-message nil
        markdown-hide-urls t
        markdown-hide-markup t)

  ;; List indentation
  (setq markdown-list-indent-width 2)

  ;; PERFORMANCE OPTIMIZATIONS - Reduce fontification overhead
  (setq markdown-fontify-whole-heading-line nil
        markdown-fontify-quote-and-verse-blocks nil)

  ;; Defer expensive calculations
  (setq jit-lock-defer-time 0.05  ;; Small delay before fontifying
        jit-lock-stealth-time 1)   ;; Fontify invisible text after 1s idle

  :hook ((markdown-mode . eglot-ensure)
         (markdown-mode . visual-line-mode)
         (markdown-mode . ar/markdown-setup-rendering)
         (markdown-mode . ar/markdown-optimize-fontification))

  :config
  ;; EGLOT & MARKSMAN SETUP
  (with-eval-after-load 'eglot
    (add-to-list 'eglot-server-programs '(markdown-mode . ("marksman"))))

  ;; FORMATTING INTEGRATION
  (with-eval-after-load 'apheleia
    (setf (alist-get 'markdown-mode apheleia-mode-alist) '(eglot)))

  ;; FIX: Set imenu expression in :config after markdown-mode is loaded
  (setq markdown-imenu-generic-expression
        '(("^\\(.*\\)[ \t]*\n=+$" 1)
          ("^\\(.*\\)[ \t]*\n-+$" 1)
          ("^\\(#+ .*\\)" 1)))

  ;; OPTIMIZATION: Reduce fontification frequency
  (defun ar/markdown-optimize-fontification ()
    "Optimize font-lock for markdown to reduce sluggishness."
    (setq-local font-lock-multiline t)
    (setq-local font-lock-maximum-decoration 2)
    (setq-local jit-lock-chunk-size 1000)
    (setq-local jit-lock-defer-time 0.1))

  ;; DYNAMIC RENDERING: Detect when cursor is in markdown element
  (defun ar/markdown-in-element-p ()
    "Check if point is inside a markdown element that should show raw markup."
    (let ((face (get-text-property (point) 'face)))
      (or
       (and face
            (or (eq face 'markdown-code-face)
                (eq face 'markdown-inline-code-face)
                (eq face 'markdown-pre-face)
                (eq face 'markdown-gfm-code-block-face)
                (and (listp face)
                     (or (memq 'markdown-code-face face)
                         (memq 'markdown-inline-code-face face)
                         (memq 'markdown-pre-face face)
                         (memq 'markdown-gfm-code-block-face face)))))
       (and face
            (or (eq face 'markdown-bold-face)
                (eq face 'markdown-italic-face)
                (and (listp face)
                     (or (memq 'markdown-bold-face face)
                         (memq 'markdown-italic-face face)))))
       (and face
            (or (eq face 'markdown-link-face)
                (eq face 'markdown-url-face)
                (and (listp face)
                     (or (memq 'markdown-link-face face)
                         (memq 'markdown-url-face face)))))
       (save-excursion
         (and (looking-at-p "[*_`\\[\\]()]")
              (or (looking-back "[*_`]" 1)
                  (looking-at "[*_`]")))))))

  ;; ANTI-FLICKER: Throttled markup toggling
  (defvar ar/markdown-toggle-timer nil
    "Timer to throttle markup visibility toggling.")

  (defun ar/markdown-toggle-markup-at-point ()
    "Toggle markup hiding based on cursor position."
    (when (derived-mode-p 'markdown-mode)
      (when ar/markdown-toggle-timer
        (cancel-timer ar/markdown-toggle-timer))
      (setq ar/markdown-toggle-timer
            (run-with-idle-timer 0.05 nil
              (lambda ()
                (when (buffer-live-p (current-buffer))
                  (with-current-buffer (current-buffer)
                    (if (ar/markdown-in-element-p)
                        (remove-text-properties (line-beginning-position) (line-end-position)
                                              '(display nil composition nil invisible nil))
                      (when markdown-hide-markup
                        (font-lock-flush (line-beginning-position) (line-end-position)))))))))))

  (defun ar/markdown-setup-rendering ()
    (add-hook 'post-command-hook #'ar/markdown-toggle-markup-at-point nil t))

  ;; CHECKBOX RENDERING
  (defface ar/markdown-checkbox-face
    '((t (:inherit markdown-list-face :box (:line-width 1 :style released-button))))
    "Face for markdown checkboxes.")

  (defun ar/markdown-fontify-checkboxes (last)
    (when (markdown-match-generic-metadata "^[ \t]*- \\[[ X]\\]" last)
      (let ((checkbox-begin (match-beginning 0))
            (checkbox-end (match-end 0))
            (checkbox-state (match-string 0)))
        (if (string-match-p "\\[X\\]" checkbox-state)
            (compose-region (+ checkbox-begin 2) (+ checkbox-begin 5) "☑")
          (compose-region (+ checkbox-begin 2) (+ checkbox-begin 5) "☐"))
        (add-text-properties checkbox-begin checkbox-end
                           '(face ar/markdown-checkbox-face)))
      t))

  (font-lock-add-keywords 'markdown-mode
                         '((ar/markdown-fontify-checkboxes)) 'append))

(use-package markdown-toc
  :defer t
  :after markdown-mode
  :hook (markdown-mode . markdown-toc-mode)
  :config
  (setq markdown-toc-header-toc-title "\n## Table of Contents"
        markdown-toc-user-toc-structure-manipulation-fn 'cdr))
#+end_src

* DONE Version Control
** DONE Magit: The Git Porcelain
#+begin_src emacs-lisp
(use-package magit
  :defer t
  :commands (magit-status
             magit-blame
             magit-log-buffer-file
             magit-stage-file
             magit-unstage-file
             magit-stage
             magit-unstage
             magit-commit
             magit-push-current-to-pushremote
             magit-pull-from-upstream
             magit-fetch
             magit-run-git
             magit-branch
             magit-merge
             magit-rebase
             magit-diff-unstaged
             magit-diff-staged
             magit-stash
             magit-dispatch)
  :custom
  ;; Display settings
  (magit-display-buffer-function #'magit-display-buffer-fullframe-status-v1)
  (magit-bury-buffer-function #'magit-restore-window-configuration)

  ;; Performance
  (magit-refresh-status-buffer t)
  (magit-refresh-verbose nil)
  (magit-git-executable "git")

  ;; Behavior
  (magit-save-repository-buffers 'dontask)
  (magit-commit-ask-to-stage 'stage)
  (magit-commit-show-diff t)
  (magit-revision-show-gravatars nil)

  ;; Diff settings
  (magit-diff-refine-hunk 'all)
  (magit-diff-paint-whitespace t)
  (magit-diff-highlight-trailing t)

  :config
  ;; Enable gravatars if desired (requires imagemagick)
  (when (and (display-graphic-p)
             (image-type-available-p 'imagemagick))
    (setq magit-revision-show-gravatars '("^Author:     " . "^Commit:     "))))
#+end_src

** DONE Forge: GitHub/GitLab Integration
#+begin_src emacs-lisp
(use-package forge
  :after magit
  :defer t
  :config
  ;; Configure forge to use sqlite for storage
  (setq forge-database-connector 'sqlite-builtin))
#+end_src

** DONE Diff-hl
#+begin_src emacs-lisp
(use-package diff-hl
  :hook ((after-init . global-diff-hl-mode)
         (dired-mode . diff-hl-dired-mode))
  :hook (magit-pre-refresh . diff-hl-magit-pre-refresh)
  :hook (magit-post-refresh . diff-hl-magit-post-refresh)
  :init
  ;; Doom Emacs aesthetic: Thin vertical bars instead of blocks
  ;; We define custom bitmaps to match Doom's 'ui/vc-gutter' look
  (define-fringe-bitmap 'my-diff-hl-bmp-insert [224] nil nil '(center repeated))
  (define-fringe-bitmap 'my-diff-hl-bmp-modify [224] nil nil '(center repeated))
  (define-fringe-bitmap 'my-diff-hl-bmp-delete [128 192 224 240] nil nil 'bottom)

  :custom
  (diff-hl-draw-borders nil)
  (diff-hl-flydiff-delay 0.1) ;; Update immediately while typing

  :config
  ;; Enable real-time updates (equivalent to git-gutter+)
  (diff-hl-flydiff-mode 1)

  ;; Force the custom thin bitmaps defined in :init
  (setq diff-hl-fringe-bmp-function
        (lambda (type pos)
          (cond
           ((eq type 'delete) 'my-diff-hl-bmp-delete)
           ((eq type 'insert) 'my-diff-hl-bmp-insert)
           ((eq type 'change) 'my-diff-hl-bmp-modify)
           (t 'my-diff-hl-bmp-insert))))

  ;; Clean Tokyo Night colors (Foreground only, no ugly background blocks)
  (custom-set-faces
   '(diff-hl-insert ((t (:foreground "#9ece6a" :background unspecified))))
   '(diff-hl-change ((t (:foreground "#e0af68" :background unspecified))))
   '(diff-hl-delete ((t (:foreground "#f7768e" :background unspecified))))))
#+end_src

** DONE Git-Timemachine: Step Through File History
#+begin_src emacs-lisp
(use-package git-timemachine
  :defer t
  :commands (git-timemachine git-timemachine-toggle)

  :init
  ;; CRITICAL FIX: Only configure native-comp if it's actually available
  (when (and (fboundp 'native-comp-available-p)
             (native-comp-available-p))
    (with-eval-after-load 'comp
      (when (boundp 'native-comp-deferred-compilation-deny-list)
        (add-to-list 'native-comp-deferred-compilation-deny-list "git-timemachine"))))

  :custom
  (git-timemachine-abbreviation-length 7)
  (git-timemachine-show-minibuffer-details t)

  :config
  (defun ar/git-timemachine-setup ()
    "Disable interfering modes when entering git-timemachine."
    (when (bound-and-true-p diff-hl-mode)
      (diff-hl-mode -1)
      (setq-local ar/diff-hl-was-active t))

    (when (bound-and-true-p eglot--managed-mode)
      (eglot-managed-mode -1)
      (setq-local ar/eglot-was-active t))

    (when (bound-and-true-p flymake-mode)
      (flymake-mode -1)
      (setq-local ar/flymake-was-active t))

    (read-only-mode 1))

  (defun ar/git-timemachine-teardown ()
    "Re-enable modes when exiting git-timemachine."
    (when (bound-and-true-p ar/diff-hl-was-active)
      (diff-hl-mode 1)
      (kill-local-variable 'ar/diff-hl-was-active))

    (when (bound-and-true-p ar/eglot-was-active)
      (eglot-ensure)
      (kill-local-variable 'ar/eglot-was-active))

    (when (bound-and-true-p ar/flymake-was-active)
      (flymake-mode 1)
      (kill-local-variable 'ar/flymake-was-active))

    ;; 4. Disable read-only
    (read-only-mode -1))

  (add-hook 'git-timemachine-mode-hook #'ar/git-timemachine-setup)
  (add-hook 'git-timemachine-mode-exit-hook #'ar/git-timemachine-teardown))
#+end_src

** DONE Magit Custom Functions
#+begin_src emacs-lisp
(defun ar/magit-stage-all ()
  "Stage all changes in the project (equivalent to 'git add .')."
  (interactive)
  (magit-run-git "add" ".")
  (message "Staged all changes."))
#+end_src

** DONE Comprehensive VC Hydra
#+begin_src emacs-lisp
;; (with-eval-after-load 'hydra
;;   (pretty-hydra-define version-control-hydra
;;     (:title (pretty-hydra-title "Version Control" 'octicon "nf-oct-git_branch" :face 'nerd-icons-green)
;;      :color amaranth
;;      :quit-key ("q" "C-g"))

;;     ("Magit Core"
;;      (("s" magit-status "status" :exit t)
;;       ("a" ar/magit-stage-all "stage all")
;;       ("c" magit-commit "commit" :exit t)
;;       ("p" magit-push-current-to-pushremote "push")
;;       ("P" magit-pull-from-upstream "pull")
;;       ("f" magit-fetch "fetch")
;;       ("F" magit-fetch-all "fetch all"))

;;      "Branch & Log"
;;      (("b" magit-branch "branches" :exit t)
;;       ("B" magit-checkout "checkout" :exit t)
;;       ("m" magit-merge "merge" :exit t)
;;       ("r" magit-rebase "rebase" :exit t)
;;       ("l" ar/magit-log-buffer-file-and-follow "log file" :exit t)
;;       ("L" magit-log-current "log branch" :exit t))

;;      "Diff & Stage"
;;      (("d" magit-diff-unstaged "diff unstaged" :exit t)
;;       ("D" magit-diff-staged "diff staged" :exit t)
;;       ("S" magit-stage-file "stage file")
;;       ("u" magit-unstage-file "unstage file")
;;       ("U" magit-unstage-all "unstage all"))

;;      "Advanced"
;;      (("z" magit-stash "stash" :exit t)
;;       ("Z" magit-stash-pop "stash pop" :exit t)
;;       ("x" magit-reset "reset" :exit t)
;;       ("!" magit-run "run cmd" :exit t)
;;       ("R" magit-refresh "refresh")
;;       ("?" magit-dispatch "dispatch" :exit t)))))
#+end_src


* DONE Org Mode
** DONE Dynamic Directory Structure
#+begin_src emacs-lisp
;; Define base directory with symlinks resolved
(defvar my/org-directory (file-truename (expand-file-name "~/org/"))
  "Base directory for all org files (symlinks resolved).")

;; Define all subdirectories that need to exist
(defvar my/org-subdirs
  '("roam"
    "roam/zettel"
    "roam/literature"
    "roam/ideas"
    "roam/projects"
    "roam/daily"
    "gtd"              ; org-gtd will create its own subdirs
    "reviews"
    "downloads"
    "noter"
    "archive"
    "attachments"
    "backups")
  "List of subdirectories to create under `my/org-directory'.")

;; Helper function to get org subdirectory paths
(defun my/org-subdir (subdir)
  "Return full path for SUBDIR under `my/org-directory'."
  (expand-file-name subdir my/org-directory))

;; Helper function to ensure directory exists
(defun my/ensure-org-dir (subdir)
  "Ensure SUBDIR exists under `my/org-directory'.
Creates parent directories as needed. Returns the full path."
  (let ((dir (my/org-subdir subdir)))
    (unless (file-directory-p dir)
      (make-directory dir t)
      (message "Created directory: %s" dir))
    dir))

;; Helper function to create file with template content
(defun my/ensure-org-file (filename &optional template)
  "Ensure FILENAME exists in org directory with optional TEMPLATE content.
If file doesn't exist, creates it with TEMPLATE content."
  (let ((filepath (expand-file-name filename my/org-directory)))
    (unless (file-exists-p filepath)
      (with-temp-file filepath
        (when template
          (insert template))
        (message "Created file: %s" filepath)))
    filepath))

;; ============================================
;; CREATE ALL DIRECTORIES
;; ============================================
(mapc #'my/ensure-org-dir my/org-subdirs)

;; Journal file
(my/ensure-org-file "journal.org"
  "#+title: Journal
#+filetags: :journal:

,* Journal Entries

")

;; Habits tracking file
(my/ensure-org-file "habits.org"
  "#+title: Habits
#+filetags: :habit:

,* Daily Habits

,* Weekly Habits

,* Monthly Habits

")

;; Long-term goals file
(my/ensure-org-file "goals.org"
  "#+title: Goals
#+filetags: :goals:

,* Life Goals

,* This Year

,* This Quarter

,* This Month

")

;; Reading list and notes
(my/ensure-org-file "reading.org"
  "#+title: Reading List
#+filetags: :reading:

,* Currently Reading

,* To Read

,* Completed

")

;; Meeting notes
(my/ensure-org-file "meetings.org"
  "#+title: Meetings
#+filetags: :meeting:

,* Meetings

")

;; Fleeting notes file (Zettelkasten)
(my/ensure-org-file "roam/ideas/fleeting.org"
  "#+title: Fleeting Notes
#+filetags: :fleeting:
#+date: %<%Y-%m-%d>

,* Quick Captures

")

;; ============================================
;; DEFINE CONVENIENCE VARIABLES
;; ============================================
(defvar my/org-roam-directory (my/org-subdir "roam/"))
(defvar my/org-gtd-directory (my/org-subdir "gtd/"))
(defvar my/org-reviews-directory (my/org-subdir "reviews/"))
#+end_src

** DONE Better Font Faces
#+begin_src emacs-lisp
(defun ar/org-font-setup ()
  ;; Replace list hyphen with dot
  (font-lock-add-keywords 'org-mode
                          '(("^ *\\([-]\\) "
                             (0 (prog1 () (compose-region (match-beginning 1) (match-end 1) "•"))))))

  ;; Set faces for heading levels
  (dolist (face '((org-level-1 . 1.17)
                  (org-level-2 . 1.11)
                  (org-level-3 . 1.10)
                  (org-level-4 . 1.07)
                  (org-level-5 . 1.05)
                  (org-level-6 . 1.03)
                  (org-level-7 . 1.02)
                  (org-level-8 . 1)))
    (set-face-attribute (car face) nil :font "JetBrainsMono Nerd Font" :weight 'bold :height (cdr face))))
#+end_src

** DONE Core Configuration
#+begin_src emacs-lisp
(use-package org
  :straight (:type built-in)
  :custom
  ;; Core settings
  (org-modules nil)
  (org-directory my/org-directory)
  (org-log-done 'time)
  (org-log-into-drawer t)
  (org-return-follows-link t)

  ;; Display settings
  (org-pretty-entities t)
  (org-hide-leading-stars t)
  (org-hide-emphasis-markers t)
  (org-fontify-whole-heading-line t)
  (org-fontify-done-headline t)
  (org-fontify-quote-and-verse-blocks t)

  ;; Source block settings
  (org-src-fontify-natively t)
  (org-src-preserve-indentation t)
  (org-src-tab-acts-natively t)
  (org-edit-src-content-indentation 0)

  ;; Performance optimizations
  (org-element-use-cache t)
  (org-element-cache-persistent t)
  (org-highlight-latex-and-related nil) ;; Performance: disable heavy fontification

  ;; Startup settings
  (org-startup-folded 'overview)
  (org-startup-with-inline-images nil)
  (org-startup-with-latex-preview nil)
  (org-cycle-separator-lines 2))
#+end_src

** DONE Hooks
#+begin_src emacs-lisp
(with-eval-after-load 'org
  (add-hook 'org-mode-hook #'visual-line-mode)
  (add-hook 'org-mode-hook #'ar/org-font-setup)
  (add-hook 'org-mode-hook #'auto-fill-mode)
  (add-hook 'org-mode-hook (lambda () (setq-local yas-parents '(latex-mode))))
  (add-hook 'org-agenda-mode-hook (lambda ()
                                    (visual-line-mode -1)
                                    (toggle-truncate-lines 1)
                                    (display-line-numbers-mode -1)
                                    (setq mode-line-format nil)
                                    (setq header-line-format nil)))
  (add-hook 'org-capture-mode-hook (lambda ()
                                     (setq mode-line-format nil)
                                     (setq header-line-format nil))))
#+end_src

** DONE Keywords
#+begin_src emacs-lisp
(with-eval-after-load 'org
  (setq org-todo-keywords
        '((sequence "TODO(t)" "NEXT(n)" "PROG(p)" "WAIT(w@/!)" "|" "DONE(d)" "CANCEL(c@)")
          (sequence "PLAN(P)" "ACTIVE(A)" "PAUSED(x)" "|" "ACHIEVED(a)" "DROPPED(D)")
          (sequence "INBOX(i)" "GTD-NEXT(N)" "GTD-WAIT(W@/!)" "|" "GTD-DONE(D!)" "GTD-CNCL(C@)")
          (sequence "CRITICAL(!)" "COMMENT(M)" "|" "RESOLVED(R)"  "DISABLED(d!)")))

  (setq org-todo-keyword-faces
        '(("TODO"      . (:foreground "#f7768e" :weight bold))
          ("NEXT"      . (:foreground "#ff9e64" :weight bold))
          ("PROG"      . (:foreground "#7aa2f7" :weight bold))
          ("WAIT"      . (:foreground "#e0af68" :weight bold))
          ("NOTE"      . (:foreground "#7dcfff" :weight bold))
          ("DONE"      . (:foreground "#9ece6a" :weight bold))
          ("CANCEL"    . (:foreground "#565f89" :weight bold))
          ("PLAN"      . (:foreground "#7dcfff" :weight bold))
          ("ACTIVE"    . (:foreground "#bb9af7" :weight bold))
          ("PAUSED"    . (:foreground "#a9b1d6" :weight bold))
          ("ACHIEVED"  . (:foreground "#9ece6a" :weight bold))
          ("DROPPED"   . (:foreground "#565f89" :weight bold))
          ("INBOX"     . (:foreground "#e0af68" :weight bold))
          ("GTD-NEXT"  . (:foreground "#7aa2f7" :weight bold))
          ("GTD-WAIT"  . (:foreground "#ff9e64" :weight bold))
          ("GTD-DONE"  . (:foreground "#9ece6a" :weight bold))
          ("GTD-CNCL"  . (:foreground "#565f89" :weight bold))
          ("CRITICAL"  . (:foreground "#f7768e" :weight bold :underline t))
          ("COMMENT"   . (:foreground "#c0caf5" :weight normal))
          ("RESOLVED"  . (:foreground "#9ece6a" :weight bold))
          ("DISABLED"   . (:foreground "#565f89" :weight bold)))))
#+end_src

** DONE Tags & Priorities
#+begin_src emacs-lisp
(with-eval-after-load 'org
  (setq org-tag-alist '(("@work"      . ?w)
                        ("@home"      . ?h)
                        ("@computer"  . ?c)
                        ("@errands"   . ?e)
                        ("read"       . ?r)
                        ("meeting"    . ?m)
                        ("urgent"     . ?u)
                        ("someday"    . ?s)))

  (setq org-priority-faces '((?A . error)
                             (?B . warning)
                             (?C . success))))
#+end_src

** DONE Org Structure Templates
#+begin_src emacs-lisp
(with-eval-after-load 'org
  ;; Load org-tempo for structure templates
  (require 'org-tempo)

  ;; Babel language configuration
  (setq org-confirm-babel-evaluate nil
        org-src-fontify-natively t
        org-src-tab-acts-natively t)

  (defconst load-language-alist
    '((emacs-lisp . t) (perl . t) (python . t) (ruby . t)
      (js . t) (css . t) (sass . t) (C . t) (java . t)
      (shell . t) (plantuml . t)))

  (org-babel-do-load-languages 'org-babel-load-languages load-language-alist)

  ;; Add Structure Templates
  (dolist (pair '(("sh" . "src shell")
                  ("el" . "src emacs-lisp")
                  ("py" . "src python")
                  ("jpy" . "src jupyter-python")
                  ("tex" . "src latex")))
    (add-to-list 'org-structure-template-alist pair)))
#+end_src

** DONE Transient Template System
#+begin_src emacs-lisp
(with-eval-after-load 'org
  (defun ar/org-template-expand (str &optional mod)
    "Expand org template STR with optional modifier MOD."
    (let (text)
      (when (region-active-p)
        (setq text (buffer-substring (region-beginning) (region-end)))
        (delete-region (region-beginning) (region-end)))
      (insert str)
      (org-tempo-complete-tag)
      (when mod (insert mod) (forward-line))
      (when text (insert text))))

  (defun ar/org-insert-perl-tangled ()
    (interactive)
    (insert "#+HEADERS: :results output :exports both :shebang \"#!/usr/bin/env perl\"\n")
    (ar/org-template-expand "<s" "perl"))

  (defun ar/org-insert-ipython ()
    (interactive)
    (ar/org-template-expand "<s" "ipython :session :exports both :results raw drawer\n$0"))

  (defun ar/org-transient-title ()
    (concat
     (if (and (fboundp 'nerd-icons-sucicon) (display-graphic-p))
         (nerd-icons-sucicon "nf-custom-orgmode" :face 'transient-heading :v-adjust 0.02)
       "")
     (propertize " Org Template" 'face 'transient-heading)))

  (with-eval-after-load 'transient
    (transient-define-prefix ar/org-template-transient ()
      "Org Mode Structure Templates"
      [:description ar/org-transient-title

       ["Basic"
        ("a" "ascii" (lambda () (interactive) (ar/org-template-expand "<a")))
        ("c" "center" (lambda () (interactive) (ar/org-template-expand "<c")))
        ("C" "comment" (lambda () (interactive) (ar/org-template-expand "<C")))
        ("x" "example" (lambda () (interactive) (ar/org-template-expand "<e")))
        ("E" "export" (lambda () (interactive) (ar/org-template-expand "<E")))
        ("h" "html" (lambda () (interactive) (ar/org-template-expand "<h")))
        ("l" "latex" (lambda () (interactive) (ar/org-template-expand "<l")))
        ("n" "note" (lambda () (interactive) (ar/org-template-expand "<n")))
        ("o" "quote" (lambda () (interactive) (ar/org-template-expand "<q")))
        ("v" "verse" (lambda () (interactive) (ar/org-template-expand "<v")))]

       ["Head"
        ("i" "index" (lambda () (interactive) (ar/org-template-expand "<i")))
        ("A" "ASCII" (lambda () (interactive) (ar/org-template-expand "<A")))
        ("I" "INCLUDE" (lambda () (interactive) (ar/org-template-expand "<I")))
        ("H" "HTML" (lambda () (interactive) (ar/org-template-expand "<H")))
        ("L" "LaTeX" (lambda () (interactive) (ar/org-template-expand "<L")))]

       ["Source"
        ("s" "src" (lambda () (interactive) (ar/org-template-expand "<s")))
        ("e" "emacs-lisp" (lambda () (interactive) (ar/org-template-expand "<s" "emacs-lisp")))
        ("y" "python" (lambda () (interactive) (ar/org-template-expand "<s" "python")))
        ("w" "powershell" (lambda () (interactive) (ar/org-template-expand "<s" "powershell")))
        ("r" "ruby" (lambda () (interactive) (ar/org-template-expand "<s" "ruby")))
        ("S" "sh" (lambda () (interactive) (ar/org-template-expand "<s" "sh")))
        ("g" "golang" (lambda () (interactive) (ar/org-template-expand "<s" "go :imports '(\"fmt\")")))]

       ["Misc"
        ("m" "mermaid" (lambda () (interactive) (ar/org-template-expand "<s" "mermaid :file chart.png")))
        ("u" "plantuml" (lambda () (interactive) (ar/org-template-expand "<s" "plantuml :file chart.png")))
        ("Y" "ipython" ar/org-insert-ipython)
        ("P" "Perl tangled" ar/org-insert-perl-tangled)
        ("<" "insert <" self-insert-command)]]))

  (defun ar/org-smart-less-than ()
    "Smart less-than key: trigger transient menu or insert character."
    (interactive)
    (if (or (region-active-p) (looking-back "^[ \t]*" 1))
        (if (featurep 'transient)
            (ar/org-template-transient)
          (require 'transient)
          (ar/org-template-transient))
      (self-insert-command 1)))

  (define-key org-mode-map (kbd "<") #'ar/org-smart-less-than))
#+end_src

** DONE Org iBullets
#+begin_src emacs-lisp
(use-package org-ibullets
  :defer t
  :commands org-ibullets-mode
  :straight (:host github :repo "jamescherti/org-ibullets.el")
  :hook (org-mode . org-ibullets-mode))
#+end_src

** DONE Org Src Buffer Naming
#+begin_src emacs-lisp
(defun ar/org-src-simplify-buffer-name (base-buffer-name lang)
  "Return static buffer name 'src code' for Org source blocks."
  "src code")

(advice-add 'org-src--construct-edit-buffer-name :override #'ar/org-src-simplify-buffer-name)
#+end_src

** DONE Org Habit
#+begin_src emacs-lisp
(use-package org-habit
  :straight (:type built-in)
  :defer t
  :after org
  :custom
  (org-habit-graph-column 60)
  (org-habit-show-habits-only-for-today t)
  (org-habit-preceding-days 21)
  (org-habit-following-days 7)
  (org-habit-completed-glyph
   (string-to-char (nerd-icons-codicon "nf-cod-check")))
  (org-habit-today-glyph
   (string-to-char (nerd-icons-codicon "nf-cod-circle_filled"))))
#+end_src

** DONE Org Pomodoro
#+begin_src emacs-lisp
(use-package org-pomodoro
  :defer t
  :config
  (alert-add-rule :category "org-pomodoro"
                  :style (cond (alert-growl-command
                                'growl)
                               (alert-notifier-command
                                'notifier)
                               (alert-libnotify-command
                                'libnotify)
                               (alert-default-style))))
#+end_src

** DONE Org Download
#+begin_src emacs-lisp
(use-package org-download
  :defer t
  :after org
  :custom
  (org-download-screenshot-method "grim -g \"$(slurp)\" - | swappy -f - -o -")
  (org-download-image-dir "assets")
  (org-download-method 'attach)
  (org-download-timestamp "%Y-%m-%d-%H%M%S_")
  (org-download-display-inline t)
  (org-image-actual-width 600)
  :config
  (advice-add 'org-download-dnd :after #'org-download-display-inline-images))
#+end_src

** DONE Org Remark
#+begin_src emacs-lisp
(use-package org-remark
  :defer t
  :after org
  :config
  (org-remark-global-tracking-mode +1))
#+end_src

** DONE Eldoc for Org Mode
#+begin_src emacs-lisp
(defun ar/org-eldoc-breadcrumb (callback &rest _)
  "Show org heading breadcrumb path in eldoc."
  (when (derived-mode-p 'org-mode)
    (let* ((face-sep '(:inherit shadow :height 0.8))
           (face-path '(:inherit shadow))
           (face-current '(:inherit font-lock-keyword-face :weight bold))
           (sep-str (propertize " → " 'face face-sep)))
      (condition-case nil
          (unless (org-in-src-block-p)
            (cond
             ;; Check if at end of buffer or last line
             ((or (eobp)
                  (save-excursion (forward-line 1) (eobp)))
              (funcall callback (propertize "Bottom Level" 'face face-path)))

             ;; Check heading hierarchy
             ((let ((path (ignore-errors (org-get-outline-path t))))
                (when path
                  (funcall callback
                           (mapconcat
                            (lambda (heading)
                              (if (string= heading (car (last path)))
                                  (propertize heading 'face face-current)
                                (propertize heading 'face face-path)))
                            path
                            sep-str)))))

             ;; Default to Top Level
             (t
              (funcall callback (propertize "Top Level" 'face face-path)))))
        (error nil)))))

(defun ar/org-eldoc-heading-info (callback &rest _)
  "Show TODO keyword, priority, and tags for current heading."
  (when (derived-mode-p 'org-mode)
    (condition-case nil
        (let* ((element (org-element-at-point))
               (type (org-element-type element)))
          (when (eq type 'headline)
            (let* ((todo (org-element-property :todo-keyword element))
                   (priority (org-element-property :priority element))
                   (tags (org-element-property :tags element))
                   (info-parts '()))
              (when todo
                (push (propertize todo 'face (org-get-todo-face todo))
                      info-parts))
              (when priority
                (push (propertize (format "[#%c]" priority) 'face
                                 (org-get-priority-face priority))
                      info-parts))
              (when tags
                (push (propertize (concat ":" (string-join tags ":") ":")
                                 'face 'org-tag)
                      info-parts))
              (when info-parts
                (funcall callback (string-join (nreverse info-parts) " "))))))
      (error nil))))

(defun ar/org-eldoc-timestamps (callback &rest _)
  "Show scheduling info (SCHEDULED, DEADLINE, CLOSED) for current heading."
  (when (derived-mode-p 'org-mode)
    (condition-case nil
        (let* ((element (org-element-at-point))
               (type (org-element-type element)))
          (when (eq type 'headline)
            (let* ((scheduled (org-element-property :scheduled element))
                   (deadline (org-element-property :deadline element))
                   (closed (org-element-property :closed element))
                   (timestamps '()))
              (when scheduled
                (push (concat
                       (propertize "SCHEDULED: " 'face 'org-special-keyword)
                       (org-element-property :raw-value scheduled))
                      timestamps))
              (when deadline
                (push (concat
                       (propertize "DEADLINE: " 'face 'org-special-keyword)
                       (org-element-property :raw-value deadline))
                      timestamps))
              (when closed
                (push (concat
                       (propertize "CLOSED: " 'face 'org-special-keyword)
                       (org-element-property :raw-value closed))
                      timestamps))
              (when timestamps
                (funcall callback (string-join (nreverse timestamps) " │ "))))))
      (error nil))))

(defun ar/org-eldoc-link (callback &rest _)
  "Show link type and target."
  (when (derived-mode-p 'org-mode)
    (condition-case nil
        (when-let ((context (org-element-context)))
          (when (eq (org-element-type context) 'link)
            (let* ((type (org-element-property :type context))
                   (path (org-element-property :path context))
                   (desc (when (org-element-property :contents-begin context)
                           (buffer-substring-no-properties
                            (org-element-property :contents-begin context)
                            (org-element-property :contents-end context)))))
              (when (and type path)
                (funcall callback
                         (concat
                          (propertize "Link: " 'face 'bold)
                          (propertize (concat type ":" path) 'face 'link)
                          (when desc
                            (format " [%s]"
                                   (propertize desc 'face 'font-lock-doc-face)))))))))
      (error nil))))

(defun ar/org-eldoc-table (callback &rest _)
  "Show table cell position and formula information."
  (when (and (derived-mode-p 'org-mode)
             (org-at-table-p)
             (not (org-at-table.el-p)))
    (condition-case nil
        (let* ((col (org-table-current-column))
               (row (save-excursion
                      (org-table-goto-line 1)
                      (count-lines (org-table-begin) (line-beginning-position))))
               (formula (org-table-get-formula col)))
          (funcall callback
                   (concat
                    (propertize (format "Cell[%d,%d]" row col)
                               'face 'font-lock-keyword-face)
                    (when (and formula (not (string-empty-p formula)))
                      (format " Formula: %s"
                             (propertize formula 'face 'font-lock-function-name-face))))))
      (error nil))))

(defun ar/org-eldoc-drawer (callback &rest _)
  "Show current drawer name."
  (when (derived-mode-p 'org-mode)
    (condition-case nil
        (save-excursion
          (beginning-of-line)
          (when (looking-at org-drawer-regexp)
            (let ((drawer (match-string 1)))
              (funcall callback
                       (propertize (format "Drawer: :%s:" drawer)
                                  'face 'org-drawer)))))
      (error nil))))

(defun ar/org-eldoc-property (callback &rest _)
  "Show property at point."
  (when (derived-mode-p 'org-mode)
    (condition-case nil
        (let ((context (org-element-context)))
          (when (eq (org-element-type context) 'node-property)
            (let ((key (org-element-property :key context))
                  (value (org-element-property :value context)))
              (funcall callback
                       (format "%s: %s"
                               (propertize key 'face 'org-special-keyword)
                               (propertize value 'face 'font-lock-string-face))))))
      (error nil))))

(defun ar/org-eldoc-clock (callback &rest _)
  "Show currently clocked item if any."
  (when (and (derived-mode-p 'org-mode)
             (featurep 'org-clock)
             (bound-and-true-p org-clock-current-task))
    (condition-case nil
        (funcall callback
                 (format "%s %s"
                         (propertize "CLOCKING:" 'face 'org-special-keyword)
                         (propertize org-clock-current-task 'face 'org-clock-overlay)))
      (error nil))))

;; On-demand functions (not in eldoc)
(defun ar/org-show-statistics ()
  "Show statistics about current subtree (word count, task count)."
  (interactive)
  (when (derived-mode-p 'org-mode)
    (condition-case nil
        (let* ((element (org-element-at-point))
               (type (org-element-type element)))
          (if (eq type 'headline)
              (save-excursion
                (org-narrow-to-subtree)
                (let* ((words (count-words (point-min) (point-max)))
                       (tasks (length (org-map-entries t "/+TODO|DONE|NEXT|WAIT|HOLD" 'tree)))
                       (done (length (org-map-entries t "/+DONE" 'tree))))
                  (widen)
                  (message (concat
                            (when (> words 0)
                              (format "%s words"
                                     (propertize (number-to-string words)
                                               'face 'font-lock-constant-face)))
                            (when (and (> words 0) (> tasks 0)) " │ ")
                            (when (> tasks 0)
                              (format "Tasks: %s/%s"
                                     (propertize (number-to-string done)
                                               'face 'org-done)
                                     (propertize (number-to-string tasks)
                                               'face 'org-todo)))))))
            (message "Not in an Org heading")))
      (error (message "Failed to calculate statistics")))))

(defun ar/org-show-src-block-info ()
  "Show source block language and important parameters."
  (interactive)
  (when (and (derived-mode-p 'org-mode)
             (org-in-src-block-p))
    (condition-case nil
        (save-excursion
          (let* ((element (org-element-at-point))
                 (lang (org-element-property :language element))
                 (switches (org-element-property :switches element))
                 (parameters (org-element-property :parameters element)))
            (when lang
              (message (concat
                        (propertize "Source: " 'face 'bold)
                        (propertize lang 'face 'font-lock-keyword-face)
                        (when switches
                          (format " %s" (propertize switches 'face 'font-lock-comment-face)))
                        (when (and parameters (not (string-empty-p parameters)))
                          (format " [%s]"
                                 (propertize parameters 'face 'font-lock-comment-face))))))))
      (error (message "Not in a source block or failed to retrieve info")))))

;; Keybindings for on-demand functions (not using general.el)
(with-eval-after-load 'org
  (define-key org-mode-map (kbd "C-c i s") #'ar/org-show-statistics)
  (define-key org-mode-map (kbd "C-c i b") #'ar/org-show-src-block-info))

;; Register eldoc functions for org-mode
(add-hook 'org-mode-hook
          (lambda ()
            (setq-local eldoc-documentation-strategy 'eldoc-documentation-compose)
            ;; Register functions with priorities (negative = higher priority)
            (add-hook 'eldoc-documentation-functions #'ar/org-eldoc-clock -100 t)
            (add-hook 'eldoc-documentation-functions #'ar/org-eldoc-link -80 t)
            (add-hook 'eldoc-documentation-functions #'ar/org-eldoc-table -70 t)
            (add-hook 'eldoc-documentation-functions #'ar/org-eldoc-property -60 t)
            (add-hook 'eldoc-documentation-functions #'ar/org-eldoc-drawer -50 t)
            (add-hook 'eldoc-documentation-functions #'ar/org-eldoc-heading-info -40 t)
            (add-hook 'eldoc-documentation-functions #'ar/org-eldoc-timestamps -30 t)
            (add-hook 'eldoc-documentation-functions #'ar/org-eldoc-breadcrumb -10 t)))
#+end_src


* DONE Second Brain & Productivity
** DONE Org Agenda
#+begin_src emacs-lisp
(use-package org-agenda
  :straight (:type built-in)
  :defer t
  :after org
  :config
  (setq org-agenda-files (list my/org-directory
                               (expand-file-name "gtd" my/org-directory)))

  (setq org-agenda-block-separator ?─
        org-agenda-compact-blocks nil)

  (setq org-agenda-time-grid
        '((daily today require-timed)
          (800 1000 1200 1400 1600 1800 2000)
          " ┄┄┄┄┄ " "┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄"))

  (setq org-agenda-current-time-string
        "◀ now ─────────────────────────────────────────────────")

  (setq org-agenda-inhibit-startup t
        org-agenda-dim-blocked-tasks nil
        org-agenda-use-tag-inheritance nil
        org-agenda-ignore-properties '(effort appt category)
        org-agenda-span 'day
        org-tags-column -80)

  ;; Skip completed tasks
  (setq org-agenda-skip-scheduled-if-done t
        org-agenda-skip-deadline-if-done t))
#+end_src

** DONE Org GTD - Pure Task Management
#+begin_src emacs-lisp
(use-package org-edna
  :defer t
  :after org
  :commands (org-edna-mode org-edna-load)
  :hook (org-mode . org-edna-mode)
  :custom
  (org-edna-use-inheritance t))

(use-package org-gtd
  :defer t
  :after (org org-edna)
  :commands (org-gtd-capture
             org-gtd-process-inbox
             org-gtd-engage
             org-gtd-show-all-next
             org-gtd-show-stuck-projects
             org-gtd-organize)

  :init
  ;; Set GTD directory
  (setq org-gtd-directory my/org-gtd-directory)
  (my/ensure-org-dir "gtd")

  :custom
  (org-todo-keywords
   '((sequence "TODO(t)" "NEXT(n)" "PROG(p)" "WAIT(w@/!)" "|" "DONE(d!)" "CANCEL(c@)")
     (sequence "PLAN(P)" "ACTIVE(A)" "PAUSED(x)" "|" "ACHIEVED(a)" "DROPPED(D)")
     ;; GTD-specific (used only in ~/org/gtd/ files)
     (sequence "INBOX(i)" "GTD-NEXT(N)" "GTD-WAIT(W@/!)" "|" "GTD-DONE(D!)" "GTD-CNCL(C@)")))

  ;; Map GTD semantic states
  (org-gtd-keyword-mapping
   '((todo . "INBOX")
     (next . "GTD-NEXT")
     (wait . "GTD-WAIT")
     (done . "GTD-DONE")
     (canceled . "GTD-CNCL")))

  ;; Disable mode-line clutter
  (org-gtd-mode nil)

  :config
  ;; Add GTD directory to agenda (but NOT roam/)
  (setq org-agenda-files
        (list my/org-directory
              my/org-gtd-directory))

  ;; Performance: Delay database sync until idle
  (run-with-idle-timer 5 nil
    (lambda ()
      (when (and (featurep 'org-gtd)
                 (not (bound-and-true-p org-gtd-mode)))
        (org-gtd-mode 1))))

  ;; Custom TODO faces for GTD keywords
  (setq org-todo-keyword-faces
        (append org-todo-keyword-faces
                '(("INBOX"     . (:foreground "#e0af68" :weight bold))
                  ("GTD-NEXT"  . (:foreground "#7aa2f7" :weight bold))
                  ("GTD-WAIT"  . (:foreground "#ff9e64" :weight bold))
                  ("GTD-DONE"  . (:foreground "#9ece6a" :weight bold))
                  ("GTD-CNCL"  . (:foreground "#565f89" :weight bold))))))
#+end_src

** DONE Org Roam
#+begin_src emacs-lisp
(use-package org-roam
  :defer t
  :functions org-roam-db-autosync-enable
  :commands (org-roam-node-find
             org-roam-node-insert
             org-roam-capture
             org-roam-buffer-toggle)

  :custom
  ;; Ensure org-roam directory exists
  (my/ensure-org-dir "roam")
  (my/ensure-org-dir "roam/zettel")
  (my/ensure-org-dir "roam/literature")
  (my/ensure-org-dir "roam/ideas")
  (my/ensure-org-dir "roam/projects")
  (my/ensure-org-dir "roam/daily")
  (my/ensure-org-dir "roam/reference")
  (my/ensure-org-dir "roam/concepts")
  (my/ensure-org-dir "roam/people")

  (org-roam-directory my/org-roam-directory)

  ;; (org-roam-completion-everywhere t)
  ;; Performance: Disable verbose messages

  ;; :hook
  ;; ;; Delay database sync significantly to avoid startup lag
  ;; ((after-init . (lambda ()
  ;;                  (run-with-idle-timer 10 nil #'org-roam-db-autosync-enable))))

  :config
  (setq org-roam-node-display-template (concat "${title:*} " (propertize "${tags:10}" 'face 'org-tag)))
  (setq org-roam-verbose nil)

  ;; CRITICAL: Do NOT add roam directory to org-agenda-files
  ;; Knowledge notes should not appear in task views

  ;; Capture templates for Zettelkasten
  (setq org-roam-capture-templates
        '(("z" "zettel" plain
           "* Core Idea\n%?\n\n* Elaboration\n\n* Evidence\n\n* Connections\n- Related: \n- Contrasts: \n\n* Source\n"
           :target (file+head "zettel/${slug}.org"
                              "#+title: ${title}\n#+filetags: :zettel:permanent:\n#+date: %<%Y-%m-%d>\n\n")
           :unnarrowed t)

          ("l" "literature" plain
           "* Source\n- Author: %?\n- Title: \n- Year: \n- Type: [Book/Article/Paper]\n- URL: \n\n* Summary\n\n* Key Takeaways\n\n* Quotes\n#+begin_quote\n\n#+end_quote\n\n* Personal Notes\n\n* Related Ideas\n"
           :target (file+head "literature/${slug}.org"
                              "#+title: ${title}\n#+filetags: :literature:\n#+date: %<%Y-%m-%d>\n\n")
           :unnarrowed t)

          ("p" "project note" plain
           "* Project Context\n%?\n\n* Why This Matters\n\n* Key Resources\n\n* Research Notes\n\n* Decision Log\n\n* Learnings\n\n* GTD Link\n- Tasks: [[file:../../gtd/projects.org][GTD Projects]]\n"
           :target (file+head "projects/${slug}.org"
                              "#+title: Project: ${title}\n#+filetags: :project:context:\n#+date: %<%Y-%m-%d>\n\n")
           :unnarrowed t)

          ("i" "fleeting" plain
           "* %?\n\n* Context\n\n* Process Later\n- [ ] Convert to permanent note OR\n- [ ] Extract actionable tasks\n"
           :target (file+head "ideas/fleeting.org"
                              "#+title: Fleeting Notes\n#+filetags: :fleeting:\n\n")
           :prepend t
           :unnarrowed t)

          ("r" "reference" plain
           "* Metadata\n- Type: %?\n- Author: \n- Date: %<%Y-%m-%d>\n- URL/DOI: \n- Tags: \n\n* Summary\n\n* Key Points\n- \n\n* Relevant Quotes\n#+begin_quote\n\n#+end_quote\n\n* My Thoughts\n\n* Related Notes\n- \n"
           :target (file+head "reference/${slug}.org"
                              "#+title: ${title}\n#+filetags: :reference:\n#+date: %<%Y-%m-%d>\n\n")
           :unnarrowed t)

          ("c" "concept" plain
           "* Definition\n%?\n\n* Core Principles\n- \n\n* Examples\n- \n\n* Misconceptions\n- \n\n* Related Concepts\n- \n\n* Applications\n- \n\n* Further Reading\n- \n"
           :target (file+head "concepts/${slug}.org"
                                "#+title: ${title}\n#+filetags: :concept:\n#+date: %<%Y-%m-%d>\n\n")
           :unnarrowed t)

          ("P" "person" plain
           "* Basic Information\n- Full Name: %?\n- Role/Occupation: \n- Affiliation: \n- Contact: \n- Website: \n\n* Background\n\n* Notable Work/Contributions\n- \n\n* Key Ideas\n- \n\n* Related People\n- \n\n* References\n- \n"
           :target (file+head "people/${slug}.org"
                              "#+title: ${title}\n#+filetags: :person:\n#+date: %<%Y-%m-%d>\n\n")
           :unnarrowed t)

          ("m" "meeting" plain
           "* Attendees\n- %?\n\n* Agenda\n- \n\n* Discussion\n\n* Action Items\n- [ ] \n\n* Follow-up\n- \n"
           :target (file+head "meetings/${slug}.org"
                              "#+title: ${title}\n#+filetags: :meeting:\n#+date: %<%Y-%m-%d>\n\n")
           :unnarrowed t)))

  ;; Dailies configuration
  (setq org-roam-dailies-directory "daily/"
        org-roam-dailies-capture-templates
        '(("d" "default" entry "* %<%H:%M> %?"
           :target (file+head "%<%Y-%m-%d>.org"
                              "#+title: %<%Y-%m-%d %A>\n#+filetags: :daily:\n\n"))

          ("j" "journal" entry "* %<%H:%M> Journal\n%?"
           :target (file+head "%<%Y-%m-%d>.org"
                              "#+title: %<%Y-%m-%d %A>\n#+filetags: :daily:journal:\n\n"))

          ("m" "morning" entry "* %<%H:%M> Morning Review\n** Goals for Today\n- %?\n\n** Priorities\n1. \n\n** Notes\n"
           :target (file+head "%<%Y-%m-%d>.org"
                              "#+title: %<%Y-%m-%d %A>\n#+filetags: :daily:\n\n"))

          ("e" "evening" entry "* %<%H:%M> Evening Reflection\n** What went well?\n- %?\n\n** What could improve?\n- \n\n** Learnings\n- \n\n** Tomorrow's focus\n- \n"
           :target (file+head "%<%Y-%m-%d>.org"
                              "#+title: %<%Y-%m-%d %A>\n#+filetags: :daily:\n\n")))))

;; org-roam-ui for visualization (optional)
(use-package org-roam-ui
  :defer t
  :after org-roam
  :commands (org-roam-ui-mode org-roam-ui-open)
  :custom
  (org-roam-ui-sync-theme t)
  (org-roam-ui-follow t)
  (org-roam-ui-update-on-save t)
  (org-roam-ui-open-on-start nil))
#+end_src

** DONE Zettelkasten ↔ GTD Bridges
#+begin_src emacs-lisp
(defun ar/gtd-to-zettel ()
  "Create a Zettelkasten project note from current GTD project.
Links back to the GTD task for execution tracking."
  (interactive)
  (unless (derived-mode-p 'org-mode)
    (user-error "Must be in an org-mode buffer"))

  (let* ((heading (org-get-heading t t t t))
         (gtd-id (org-id-get-create))
         (context (or (org-entry-get nil "CONTEXT") ""))
         (node-title (concat "Project: " heading)))

    ;; Create org-roam project note with template
    (org-roam-capture-
     :node (org-roam-node-create :title node-title)
     :props (list :immediate-finish nil
                  :gtd-id gtd-id
                  :heading heading
                  :context context))

    ;; Add backlink to GTD project
    (save-excursion
      (org-back-to-heading t)
      (org-end-of-meta-data t)
      (unless (looking-at "\n")
        (insert "\n"))
      (insert (format "- Zettelkasten Note: [[id:%s][%s]]\n\n"
                      gtd-id node-title)))

    (message "Created Zettelkasten project note: %s" node-title)))

(defun ar/zettel-to-gtd ()
  "Extract actionable tasks from current Zettelkasten note to GTD inbox."
  (interactive)
  (unless (and (derived-mode-p 'org-mode)
               (string-prefix-p my/org-roam-directory (buffer-file-name)))
    (user-error "Must be in an org-roam buffer"))

  (let* ((note-title (org-roam-node-title (org-roam-node-at-point)))
         (note-id (org-id-get-create))
         (tasks '()))

    ;; Collect TODO items
    (org-map-entries
     (lambda ()
       (let ((heading (org-get-heading t t t t))
             (state (org-get-todo-state)))
         (when (and state (not (member state '("DONE" "CANCEL"))))
           (push heading tasks))))
     t 'tree)

    (if (null tasks)
        (message "No actionable tasks found in current note")
      ;; Create GTD inbox entry
      (let ((inbox-file (expand-file-name "inbox.org" my/org-gtd-directory)))
        (with-current-buffer (find-file-noselect inbox-file)
          (goto-char (point-max))
          (insert (format "\n* INBOX Tasks from [[id:%s][%s]]\n" note-id note-title))
          (insert ":PROPERTIES:\n:CREATED: ")
          (org-insert-time-stamp (current-time) t t)
          (insert "\n:END:\n\n")
          (dolist (task (reverse tasks))
            (insert (format "** TODO %s\n" task)))
          (save-buffer))
        (message "Sent %d tasks to GTD inbox" (length tasks))))))

(defun ar/fleeting-to-permanent ()
  "Process fleeting notes into permanent notes."
  (interactive)
  (let ((fleeting-file (expand-file-name "ideas/fleeting.org" my/org-roam-directory)))
    (unless (file-exists-p fleeting-file)
      (user-error "No fleeting notes file found"))
    (find-file fleeting-file)
    (goto-char (point-min))
    (message "Review fleeting notes and convert to permanent notes as needed")))

(defun ar/weekly-review ()
  "Launch comprehensive weekly review: GTD + Zettelkasten with pre-populated stats."
  (interactive)
  (let* ((week-string (format-time-string "%Y-W%U"))
         (review-file (expand-file-name
                       (format "%s-review.org" week-string)
                       my/org-reviews-directory))
         ;; Gather statistics
         (inbox-count
          (length (org-map-entries t "TODO=\"INBOX\""
                                  (list (expand-file-name "inbox.org" my/org-gtd-directory)))))
         (next-count
          (length (org-map-entries t "TODO=\"GTD-NEXT\""
                                  (list my/org-gtd-directory))))
         (wait-count
          (length (org-map-entries t "TODO=\"GTD-WAIT\""
                                  (list my/org-gtd-directory))))
         (fleeting-count
          (with-temp-buffer
            (let ((fleeting (expand-file-name "ideas/fleeting.org" my/org-roam-directory)))
              (if (file-exists-p fleeting)
                  (progn
                    (insert-file-contents fleeting)
                    (count-matches "^\\* " (point-min) (point-max)))
                0)))))

    ;; Create review file with live data
    (unless (file-exists-p review-file)
      (with-temp-file review-file
        (insert "#+title: Weekly Review - " week-string "\n")
        (insert "#+date: " (format-time-string "%Y-%m-%d") "\n")
        (insert "#+filetags: :review:\n\n")

        (insert "* GTD Health Check\n")
        (insert (format "- Inbox items: *%d* %s\n"
                       inbox-count
                       (if (> inbox-count 10) "⚠ PROCESS URGENTLY" "✓")))
        (insert (format "- NEXT actions: *%d*\n" next-count))
        (insert (format "- WAIT items: *%d*\n" wait-count))
        (insert (format "- Fleeting notes: *%d* %s\n\n"
                       fleeting-count
                       (if (> fleeting-count 20) "⚠ PROCESS" "✓")))

        (insert "* Review Checklist\n")
        (insert "** GTD Review\n")
        (insert "- [ ] Process GTD inbox to zero\n")
        (insert "- [ ] Review all GTD-WAIT items\n")
        (insert "- [ ] Check stuck projects\n")
        (insert "- [ ] Review calendar (past week + next 2 weeks)\n")
        (insert "- [ ] Ensure each project has NEXT action\n")
        (insert "- [ ] Review Someday/Maybe\n\n")

        (insert "** Zettelkasten Review\n")
        (insert "- [ ] Process fleeting notes\n")
        (insert "- [ ] Review notes created this week\n")
        (insert "- [ ] Identify missing connections\n")
        (insert "- [ ] Update active project notes\n\n")

        (insert "* Reflections\n")
        (insert "** What Went Well?\n\n\n")
        (insert "** What Could Improve?\n\n\n")
        (insert "** Key Insights This Week\n\n\n")
        (insert "** Next Week's Focus\n\n\n")))

    ;; Open file
    (find-file review-file)
    (goto-char (point-min))
    (when (re-search-forward "^\\*\\* What Went Well" nil t)
      (org-end-of-line))))

;; Add to org-roam-capture-templates for GTD bridge
(with-eval-after-load 'org-roam
  (add-to-list 'org-roam-capture-templates
               '("g" "GTD Project Bridge" plain
                 "* Project Context\nThis is the knowledge hub for a GTD project.\n\n* Why This Matters\n\n* Research & Resources\n\n* Key Decisions\n\n* Learnings\n\n* GTD Link\n- Execution: [[file:../../gtd/projects.org][GTD Projects]]\n"
                 :target (file+head "projects/${slug}.org"
                                    "#+title: ${title}\n#+filetags: :project:context:gtd:\n#+date: %<%Y-%m-%d>\n\n")
                 :unnarrowed t)
               t))
#+end_src

** DONE Org Capture
#+begin_src emacs-lisp
(use-package org-capture
  :straight (:type built-in)
  :defer t
  :after org
  :init
  ;; Smart capture dispatcher
  (defun ar/capture-dispatch ()
    "Smart capture: GTD task, Zettelkasten note, or journal."
    (interactive)
    (let ((choice (read-char-choice
                   "Capture: [t]ask [n]ote [f]leeting [j]ournal [q]uit? "
                   '(?t ?n ?f ?j ?q))))
      (pcase choice
        (?t (org-gtd-capture))
        (?n (org-roam-capture))
        (?f (find-file (expand-file-name "ideas/fleeting.org" my/org-roam-directory))
            (goto-char (point-max))
            (unless (bolp) (insert "\n"))
            (insert (format "\n* %s\n\n" (read-string "Fleeting thought: ")))
            (backward-char 1))
        (?j (org-capture nil "j"))
        (?q (keyboard-quit)))))

  :custom
  (org-capture-templates
   `(;; Quick journal entry (NOT a task)
     ("j" "Journal" entry
      (file+olp+datetree ,(expand-file-name "journal.org" my/org-directory))
      "* %<%H:%M> %?\n"
      :empty-lines 1)

     ;; Meeting notes (extract tasks later)
     ("m" "Meeting" entry
      (file+headline ,(expand-file-name "journal.org" my/org-directory) "Meetings")
      "* %<%Y-%m-%d> %? :meeting:\n:PROPERTIES:\n:CREATED: %U\n:ATTENDEES: \n:END:\n\n** Agenda\n\n** Notes\n\n** Action Items\n- [ ] \n"
      :empty-lines 1
      :clock-in t
      :clock-resume t)

     ;; Reading/book notes (becomes literature note)
     ("b" "Book/Article" entry
      (file ,(expand-file-name "reading.org" my/org-directory))
      "* %? :read:\n:PROPERTIES:\n:CREATED: %U\n:AUTHOR: \n:TYPE: [Book/Article/Paper]\n:STATUS: [Reading/Finished]\n:END:\n\n** Summary\n\n** Key Ideas\n\n** Personal Thoughts\n"
      :empty-lines 1)

     ;; Habit (tracked in agenda, not GTD)
     ("h" "Habit" entry
      (file+headline ,(expand-file-name "habits.org" my/org-directory) "Habits")
      "* TODO %?\nSCHEDULED: %(format-time-string \"<%Y-%m-%d %a .+1d>\")\n:PROPERTIES:\n:STYLE: habit\n:END:\n"
      :empty-lines 1)))

  :config
  ;; Performance: Don't save file on every capture
  (remove-hook 'org-capture-prepare-finalize-hook 'org-capture-insert-template-here))
#+end_src

** DONE Org Super Agenda
#+begin_src emacs-lisp
(use-package org-super-agenda
  :defer t
  :after org-agenda
  :hook (org-agenda-mode . org-super-agenda-mode)
  :custom
  (org-super-agenda-header-separator "─────────────────────────────────")
  :config
  ;; Global groups for all agenda views (can be overridden per command)
  (setq org-super-agenda-groups
        '((:name "🔴 Overdue"
           :deadline past
           :scheduled past
           :face (:foreground "#f7768e")
           :order 1)

          (:name "🔥 GTD Inbox (Process Today)"
           :todo "INBOX"
           :file-path "gtd/inbox.org"
           :order 2)

          (:name "⚡ Today's Schedule"
           :time-grid t
           :date today
           :scheduled today
           :order 3)

          (:name "🎯 High Priority"
           :priority "A"
           :order 4)

          (:name "💻 @Computer"
           :and (:tag "@computer" :todo ("GTD-NEXT" "NEXT"))
           :order 5)

          (:name "🏠 @Home"
           :and (:tag "@home" :todo ("GTD-NEXT" "NEXT"))
           :order 6)

          (:name "📞 @Phone"
           :and (:tag "@phone" :todo ("GTD-NEXT" "NEXT"))
           :order 7)

          (:name "⏳ Waiting For"
           :todo ("GTD-WAIT" "WAIT")
           :order 8)

          (:name "📆 Due Soon (Next 7 Days)"
           :deadline future
           :order 9)

          (:name "🚀 Active Projects (Zettelkasten)"
           :and (:tag "project" :file-path "roam/projects")
           :order 10)

          (:name "📋 Other Tasks"
           :anything t
           :order 99))))
#+end_src

** DONE Org Agenda Custom Commands
#+begin_src emacs-lisp
(with-eval-after-load 'org-super-agenda
  (setq org-agenda-custom-commands
        '(("d" "Daily Dashboard"
           ((agenda ""
                    ((org-agenda-span 'day)
                     (org-agenda-start-day "0d")
                     (org-super-agenda-groups
                      '((:name "⏰ Time-Blocked Today"
                         :time-grid t
                         :date today
                         :order 1)

                        (:name "🔴 Overdue"
                         :deadline past
                         :scheduled past
                         :order 2)

                        (:name "🔥 GTD Inbox (Must Process)"
                         :todo "INBOX"
                         :order 3)))))

            (alltodo ""
                     ((org-agenda-overriding-header "")
                      (org-super-agenda-groups
                       '((:name "🎯 Priority A"
                          :priority "A"
                          :order 1)

                         (:name "💻 @Computer"
                          :and (:tag "@computer" :todo ("GTD-NEXT" "NEXT"))
                          :order 2)

                         (:name "🏠 @Home"
                          :and (:tag "@home" :todo ("GTD-NEXT" "NEXT"))
                          :order 3)

                         (:name "📞 @Phone"
                          :and (:tag "@phone" :todo ("GTD-NEXT" "NEXT"))
                          :order 4)

                         (:name "⏳ Waiting"
                          :todo ("GTD-WAIT" "WAIT")
                          :order 5)

                         (:discard (:anything t))))))))


          ("w" "Weekly Review"
           ((todo "INBOX"
                  ((org-agenda-overriding-header "🔥 GTD Inbox (Zero This Out)")
                   (org-agenda-files (list (expand-file-name "gtd/inbox.org" my/org-directory)))
                   (org-super-agenda-groups
                    '((:auto-ts t)))))

            (todo "GTD-WAIT"
                  ((org-agenda-overriding-header "⏳ Waiting For (Follow-up Required)")
                   (org-super-agenda-groups
                    '((:auto-property "DELEGATED_TO")))))

            (stuck ""
                   ((org-agenda-overriding-header "🚫 Stuck Projects (No NEXT Actions)")
                    (org-super-agenda-groups
                     '((:auto-category t)))))

            (todo "GTD-NEXT"
                  ((org-agenda-overriding-header "✅ All NEXT Actions")
                   (org-super-agenda-groups
                    '((:auto-parent t)))))))


          ("p" "Projects Dashboard"
           ((tags "LEVEL=1"
                  ((org-agenda-overriding-header "📋 GTD Projects (Execution Layer)")
                   (org-agenda-files (list (expand-file-name "gtd/projects.org" my/org-directory)))
                   (org-super-agenda-groups
                    '((:name "🔴 Stuck (No NEXT)"
                       :children ("GTD-WAIT" "TODO" "INBOX")
                       :order 1)

                      (:name "✅ Active (Has NEXT)"
                       :children "GTD-NEXT"
                       :order 2)

                      (:name "⸻ Paused"
                       :scheduled future
                       :order 3)))))

            (tags "+ACTIVE"
                  ((org-agenda-overriding-header "💡 Knowledge Context (Zettelkasten)")
                   (org-agenda-files (list (expand-file-name "roam/projects" my/org-roam-directory)))
                   (org-super-agenda-groups
                    '((:auto-tags t)))))))


          ("g" . "GTD Views")

          ("gn" "Next Actions"
           ((todo "GTD-NEXT"
                  ((org-agenda-overriding-header "✅ Next Actions")
                   (org-agenda-sorting-strategy '(priority-down category-keep))
                   (org-super-agenda-groups
                    '((:auto-category t)))))))

          ("gi" "Inbox (Unprocessed)"
           ((todo "INBOX"
                  ((org-agenda-overriding-header "🔥 GTD Inbox")
                   (org-agenda-files (list (expand-file-name "gtd/inbox.org" my/org-directory)))
                   (org-super-agenda-groups
                    '((:auto-ts t)))))))

          ("gw" "Waiting For"
           ((todo "GTD-WAIT"
                  ((org-agenda-overriding-header "⏳ Waiting For")
                   (org-super-agenda-groups
                    '((:auto-property "DELEGATED_TO")))))))

          ("gs" "Stuck Projects"
           ((stuck ""
                   ((org-agenda-overriding-header "🚫 Stuck Projects")
                    (org-super-agenda-groups
                     '((:auto-category t)))))))

          ("gc" "By Context"
           ((tags-todo "@computer/GTD-NEXT"
                       ((org-agenda-overriding-header "💻 @Computer")
                        (org-super-agenda-groups
                         '((:auto-priority t)))))

            (tags-todo "@home/GTD-NEXT"
                       ((org-agenda-overriding-header "🏠 @Home")
                        (org-super-agenda-groups
                         '((:auto-priority t)))))

            (tags-todo "@errands/GTD-NEXT"
                       ((org-agenda-overriding-header "🚗 @Errands")
                        (org-super-agenda-groups
                         '((:auto-priority t)))))

            (tags-todo "@phone/GTD-NEXT"
                       ((org-agenda-overriding-header "📞 @Phone")
                        (org-super-agenda-groups
                         '((:auto-priority t))))))))))
#+end_src





* TODO Workflow Management
** DONE Dired
#+begin_src emacs-lisp
(use-package dired
  :straight (:type built-in)
  :commands (dired dired-jump)
  :hook (dired-mode . dired-hide-details-mode)
  :hook (dired-mode . hl-line-mode)
  :custom
  ;; Doom-like cleanup: Don't confirm simple recursive deletes
  (dired-recursive-copies 'always)
  (dired-recursive-deletes 'top)
  (delete-by-moving-to-trash t)
  (dired-dwim-target t)

  ;; Performance & UX
  (dired-auto-revert-buffer t)
  (dired-kill-when-opening-new-dired-buffer t)
  (insert-directory-program "/usr/bin/ls")
  (dired-listing-switches "-l --almost-all --human-readable --time-style=long-iso --group-directories-first --no-group"))
#+end_src

** DONE Dired Extensions
#+begin_src emacs-lisp
(use-package dired-x
  :straight (:type built-in)
  :hook (dired-mode . dired-omit-mode)
  :config
  (setq dired-omit-verbose nil
        dired-omit-files
        (concat "^\\.?#\\|^\\.$\\|^\\.\\.$"
                "\\|^\\.DS_Store\\'"
                "\\|^flycheck_.*"
                "\\|^\\.project\\(?:ile\\)?\\'"
                "\\|^\\.\\(?:svn\\|git\\)\\'"
                "\\|^\\.ccls-cache\\'"
                "\\|\\(?:\\.js\\)?\\.meta\\'"
                "\\|\\.\\(?:elc\\|o\\|pyo\\|swp\\|class\\)\\'"))

  (setq dired-clean-confirm-killing-deleted-buffers nil))

(use-package diredfl
  :hook
  ((dired-mode . diredfl-mode)
   ;; highlight parent and directory preview as well
   (dirvish-directory-view-mode . diredfl-mode))
  :config
  (set-face-attribute 'diredfl-dir-name nil :bold t))


(use-package wdired
  :straight (:type built-in)
  :after dired
  :custom
  (wdired-allow-to-change-permissions t)
  (wdired-create-parent-directories t))
#+end_src

** DONE Dirvish
#+begin_src emacs-lisp
(use-package dirvish
  :defer t
  :after dired
  :init
  ;; MAGIC: This makes ALL dired commands use Dirvish interfaces
  (dirvish-override-dired-mode)

  :custom
  (dirvish-cache-dir (expand-file-name "dirvish/" user-emacs-directory))

  ;; Restored your specific layout ratios
  (dirvish-default-layout '(1 0.11 0.55))
  (dirvish-layout-recipes
   '((0 0   0.4)   ; No parent, smaller preview
     (1 0.1 0.5)   ; Balanced layout
     (1 0.15 0.6))) ; More preview space

  ;; Restored your shortcuts
  (dirvish-quick-access-entries
   `(("h" "~/" "Home")
     ("e" ,user-emacs-directory "Emacs")
     ("d" "~/Downloads/" "Downloads")
     ("D" "~/Documents/" "Documents")
     ("p" "~/projects/" "Projects")
     ("o" ,my/org-directory "Org")
     ("c" "~/.config/" "Config")
     ("t" "~/.local/share/Trash/files/" "Trash")))

 ;; Attributes
  (dirvish-attributes
   '(subtree-state nerd-icons collapse vc-state))

  ;; Doom-like UI: Headers and Mode lines
  (dirvish-use-header-line t)
  (dirvish-use-mode-line t)
  (dirvish-header-line-height '(25 . 35))
  (dirvish-mode-line-height 25)
  (dirvish-header-line-format '(:left (path) :right (free-space)))
  (dirvish-mode-line-format
   '(:left (sort file-time " " file-size symlink)
     :right (omit yank index)))

  ;; Restored: Ranger-like session behavior (kill on quit)
  (dirvish-reuse-session nil)
  (dirvish-hide-cursor t)
  (dirvish-hide-details '(dirvish dirvish-side))

  ;; Restored: Emerge groups
  (dirvish-emerge-groups
   '(("Recent files" (predicate . recent-files-2h))
     ("Documents" (extensions "pdf" "tex" "bib" "epub"))
     ("Video" (extensions "mp4" "mkv" "webm"))
     ("Pictures" (extensions "jpg" "png" "svg" "gif"))
     ("Audio" (extensions "mp3" "flac" "wav" "ape"))
     ("Archives" (extensions "gz" "rar" "zip"))))

  ;; Previews
  (dirvish-preview-dispatchers
   '(image gif video audio epub archive pdf))

  :config
  (setq dirvish-mode-line-format
        '(:left (sort symlink) :right (omit yank index)))
  ;; open large directory (over 20000 files) asynchronously with `fd' command
  (setq dirvish-large-directory-threshold 20000)
  (require 'dirvish-fd)
  (require 'dirvish-emerge)

  (require 'dirvish-side)

  ;; Side window configuration (Restored to Left side)
  (setq dirvish-side-width 30
        dirvish-side-follow-buffer-file t)
        dirvish-side-display-alist '((side . bottom) (slot . -1)))
#+end_src

** DONE Project.el
#+begin_src emacs-lisp
(use-package project :straight (:type built-in))

(defun ar/open-emacs-config-project ()
  "Open Emacs config directory as a project."
  (interactive)
  (let ((default-directory user-emacs-directory))
    (call-interactively #'project-find-file)))

(defun ar/project-switch-to-file ()
  "Switch to a project and immediately find a file in it."
  (interactive)
  (let ((project-switch-commands #'project-find-file))
    (call-interactively #'project-switch-project)))

(defun ar/project-switch-with-menu ()
  "Switch to a project and show the dispatch menu."
  (interactive)
  (call-interactively #'project-switch-project))
#+end_src

** DONE iBuffer
#+begin_src emacs-lisp
(use-package ibuffer
  :straight (:type built-in)
  :defer t
  :init (setq ibuffer-filter-group-name-face '(:inherit (font-lock-string-face bold))))

;; Display icons for buffers
(use-package nerd-icons-ibuffer
  :defer t
  :hook (ibuffer-mode . nerd-icons-ibuffer-mode))

;; Group ibuffer's list by project
(use-package ibuffer-project
  :defer t
  :autoload (ibuffer-project-generate-filter-groups ibuffer-do-sort-by-project-file-relative)
  :functions icons-displayable-p
  :hook (ibuffer . (lambda ()
                     "Group ibuffer's list by project."
                     (setq ibuffer-filter-groups (ibuffer-project-generate-filter-groups))
                     (unless (eq ibuffer-sorting-mode 'project-file-relative)
                       (ibuffer-do-sort-by-project-file-relative))))
  :init (setq ibuffer-project-use-cache t)
  :config
  (with-no-warnings
    (defun my-ibuffer-project-group-name (root type)
      "Return group name for project ROOT and TYPE."
      (if (and (stringp type) (> (length type) 0))
          (format "%s %s" type root)
        (format "%s" root)))
    (if (icons-displayable-p)
        (progn
          (advice-add #'ibuffer-project-group-name :override #'my-ibuffer-project-group-name)
          (setq ibuffer-project-root-functions
                `((ibuffer-project-project-root . ,(nerd-icons-octicon "nf-oct-repo" :height 1.2 :face ibuffer-filter-group-name-face))
                  (file-remote-p . ,(nerd-icons-codicon "nf-cod-radio_tower" :height 1.2 :face ibuffer-filter-group-name-face)))))
      (progn
        (advice-remove #'ibuffer-project-group-name #'my-ibuffer-project-group-name)
        (setq ibuffer-project-root-functions
              '((ibuffer-project-project-root . "Project")
                (file-remote-p . "Remote")))))))


;; Group ibuffer's list by version control repository (backup option)
;; (use-package ibuffer-vc
;;   :defer t
;;   :hook (ibuffer . (lambda ()
;;                      (ibuffer-vc-set-filter-groups-by-vc-root)
;;                      (unless (eq ibuffer-sorting-mode 'alphabetic)
;;                        (ibuffer-do-sort-by-alphabetic))))
;;   :custom
;;   (ibuffer-show-empty-filter-groups nil))
#+end_src

** DONE Tabspaces
#+begin_src emacs-lisp
(use-package tabspaces
  :straight (:type git :host github :repo "mclear-tools/tabspaces")
  :hook (after-init . tabspaces-mode)
  :commands (tabspaces-switch-or-create-workspace
             tabspaces-open-or-create-project-and-workspace)
  :custom
  (tabspaces-use-filtered-buffers-as-default t)
  (tabspaces-default-tab "Home")
  (tabspaces-remove-to-default t)
  (tabspaces-include-buffers '("*scratch*"))
  (tabspaces-initialize-project-with-todo t)
  (tabspaces-todo-file-name "project-todo.org")
  (tabspaces-session t)
  (tabspaces-session-auto-restore nil)
  (tabspaces-fully-resolve-paths t)
  (tabspaces-exclude-buffers '("*Messages*" "*Compile-Log*"))
  (tab-bar-new-tab-choice "*scratch*")

  :config
  ;;; Frame-Local Project Tracking
  (defun ar/frame-projects ()
    "Get list of projects for the current frame."
    (or (frame-parameter (selected-frame) 'ar/frame-projects) nil))

  (defun ar/frame-add-project (project-root)
    "Add PROJECT-ROOT to the current frame's project list."
    (when (and project-root (file-directory-p project-root))
      (let* ((frame (selected-frame))
             (projects (ar/frame-projects))
             (root (expand-file-name project-root)))
        (unless (member root projects)
          (set-frame-parameter frame 'ar/frame-projects (cons root projects))))))

  (defun ar/track-project ()
    "Track the current project in the frame's project list."
    (when-let ((project (project-current)))
      (ar/frame-add-project (project-root project))))

  ;; Track projects when files are opened
  (add-hook 'find-file-hook #'ar/track-project)
  (add-hook 'dired-mode-hook #'ar/track-project)

  ;;; Consult Integration - Frame-Local Buffer Filtering
  (with-eval-after-load 'consult
    ;; Frame-local workspace buffer source
    (defvar consult--source-frame-workspace
      (list :name     "Workspace Buffers"
            :narrow   ?w
            :history  'buffer-name-history
            :category 'buffer
            :state    #'consult--buffer-state
            :default  t
            :items    (lambda ()
                       ;; Get frame's buffer-list (automatically maintained by Emacs)
                       (let ((frame-buffers (buffer-list (selected-frame))))
                         (consult--buffer-query
                          :predicate (lambda (buf)
                                      ;; Must be in frame's buffer list AND
                                      ;; if tabspaces is active, must be in workspace
                                      (and (memq buf frame-buffers)
                                           (or (not tabspaces-mode)
                                               (tabspaces--local-buffer-p buf))))
                          :sort 'visibility
                          :as #'buffer-name))))
      "Frame-local workspace buffer list for consult-buffer.")

    ;; All buffers source (hidden by default, access with 'o')
    (defvar consult--source-all-buffers
      (list :name     "All Buffers (Other Frames)"
            :narrow   ?o
            :hidden   t
            :history  'buffer-name-history
            :category 'buffer
            :state    #'consult--buffer-state
            :items    (lambda ()
                       (consult--buffer-query
                        :sort 'visibility
                        :as #'buffer-name)))
      "All buffers from all frames.")

    ;; Update consult-buffer-sources
    (setq consult-buffer-sources
          '(consult--source-frame-workspace
            consult--source-all-buffers))

    ;; Hide default buffer source
    (consult-customize consult-source-buffer :hidden t :default nil))

  ;;; Project.el Integration - Frame-Local Project Switching
  (with-eval-after-load 'project
    ;; Track projects and create workspaces when switching projects
    (defun ar/project-switch-track (&rest _)
      "Track project in frame-local list and create workspace."
      (when-let ((project (project-current)))
        (let ((root (project-root project)))
          ;; Add to frame's project list
          (ar/frame-add-project root)
          ;; Create or switch to workspace for this project
          (when (and tabspaces-mode (fboundp 'tabspaces-switch-or-create-workspace))
            (let ((project-name (file-name-nondirectory
                                (directory-file-name root))))
              (tabspaces-switch-or-create-workspace project-name))))))

    ;; Advice project-switch-project
    (advice-add 'project-switch-project :after #'ar/project-switch-track))

  ;;; Frame Initialization
  (defun ar/init-frame (frame)
    "Initialize FRAME with frame-local parameters and workspace."
    (with-selected-frame frame
      ;; Initialize project tracking parameter if not present
      (unless (frame-parameter frame 'ar/frame-projects)
        (set-frame-parameter frame 'ar/frame-projects nil))

      ;; Set up initial workspace if tabspaces is active and tabs don't exist
      (when (and tabspaces-mode (boundp 'tab-bar-mode))
        (let ((tabs (and (fboundp 'tab-bar-tabs) (tab-bar-tabs))))
          ;; Only create initial tab if no tabs exist
          (when (or (null tabs) (= (length tabs) 0))
            (when (fboundp 'tab-bar-new-tab)
              (tab-bar-new-tab))
            (when (fboundp 'tab-bar-rename-tab)
              (tab-bar-rename-tab "Home")))))))

  ;; Initialize all existing frames
  (dolist (frame (frame-list))
    (ar/init-frame frame))

  ;; Initialize new frames as they're created
  (add-hook 'after-make-frame-functions #'ar/init-frame)

  ;;; Startup Hooks
  (defun ar/tabspaces-startup ()
    "Initialize tabspaces at startup."
    (when (fboundp 'tabspaces-mode)
      (tabspaces-mode 1))
    (ar/init-frame (selected-frame)))

  ;; Hook into after-init
  (add-hook 'after-init-hook #'ar/tabspaces-startup))
#+end_src

** TODO Ace Window
#+begin_src emacs-lisp
;; (use-package ace-window
;;   :defer t
;;   :commands (toggle-window-split)
;;   :pretty-hydra
;;   ((:title (pretty-hydra-title "Window Management" 'faicon "nf-fa-th")
;;     :foreign-keys warn :quit-key ("q" "C-g"))
;;    ("Actions"
;;     (("TAB" other-window "switch")
;;      ("x" ace-delete-window "delete")
;;      ("X" ace-delete-other-windows "delete other" :exit t)
;;      ("s" ace-swap-window "swap")
;;      ("a" ace-select-window "select" :exit t)
;;      ("m" toggle-frame-maximized "maximize" :exit t)
;;      ("u" toggle-frame-fullscreen "fullscreen" :exit t))
;;     "Resize"
;;     (("h" shrink-window-horizontally "←")
;;      ("j" enlarge-window "↓")
;;      ("k" shrink-window "↑")
;;      ("l" enlarge-window-horizontally "→")
;;      ("n" balance-windows "balance"))
;;     "Split"
;;     (("r" split-window-right "horizontally")
;;      ("R" split-window-horizontally-instead "horizontally instead")
;;      ("v" split-window-below "vertically")
;;      ("V" split-window-vertically-instead "vertically instead")
;;      ("t" toggle-window-split "toggle"))
;;     "Zoom"
;;     (("+" text-scale-increase "in")
;;      ("=" text-scale-increase "in")
;;      ("-" text-scale-decrease "out")
;;      ("0" (text-scale-increase 0) "reset"))
;;     "Misc"
;;     (("o" set-frame-font "frame font")
;;      ("f" make-frame-command "new frame")
;;      ("d" delete-frame "delete frame")
;;      ("<left>" winner-undo "winner undo")
;;      ("<right>" winner-redo "winner redo"))))
;;   :custom-face
;;   (aw-leading-char-face ((t (:inherit font-lock-keyword-face :foreground unspecified :bold t :height 3.0))))
;;   (aw-minibuffer-leading-char-face ((t (:inherit font-lock-keyword-face :bold t :height 1.0))))
;;   (aw-mode-line-face ((t (:inherit mode-line-emphasis :bold t))))
;;   :bind (([remap other-window] . ace-window)
;;          ("C-c w" . ace-window-hydra/body)
;;          ("C-x |" . split-window-horizontally-instead)
;;          ("C-x _" . split-window-vertically-instead))
;;   ;; REMOVED: :hook (emacs-startup . ace-window-display-mode)
;;   ;; This prevents the "1" from appearing in the modeline.
;;   :config
;;   (defun toggle-window-split ()
;;     (interactive)
;;     (if (= (count-windows) 2)
;;         (let* ((this-win-buffer (window-buffer))
;;                (next-win-buffer (window-buffer (next-window)))
;;                (this-win-edges (window-edges (selected-window)))
;;                (next-win-edges (window-edges (next-window)))
;;                (this-win-2nd (not (and (<= (car this-win-edges)
;;                                            (car next-win-edges))
;;                                        (<= (cadr this-win-edges)
;;                                            (cadr next-win-edges)))))
;;                (splitter
;;                 (if (= (car this-win-edges)
;;                        (car (window-edges (next-window))))
;;                     'split-window-horizontally
;;                   'split-window-vertically)))
;;           (delete-other-windows)
;;           (let ((first-win (selected-window)))
;;             (funcall splitter)
;;             (if this-win-2nd (other-window 1))
;;             (set-window-buffer (selected-window) this-win-buffer)
;;             (set-window-buffer (next-window) next-win-buffer)
;;             (select-window first-win)
;;             (if this-win-2nd (other-window 1))))
;;       (user-error "`toggle-window-split' only supports two windows")))

;;   ;; Bind hydra to dispatch list
;;   (add-to-list 'aw-dispatch-alist '(?w ace-window-hydra/body) t)

;;   ;; Select window via `M-1'...`M-9'
;;   (defun aw--select-window (number)
;;     "Select the specified window."
;;     (when (numberp number)
;;       (let ((found nil))
;;         (dolist (win (aw-window-list))
;;           (when (and (window-live-p win)
;;                      (eq number
;;                          (string-to-number
;;                           (window-parameter win 'ace-window-path))))
;;             (setq found t)
;;             (aw-switch-to-window win)))
;;         (unless found
;;           (message "No specified window: %d" number)))))
;;   (dotimes (n 9)
;;     (bind-key (format "M-%d" (1+ n))
;;               (lambda ()
;;                 (interactive)
;;                 (aw--select-window (1+ n))))))
#+end_src

** DONE Treemacs
#+begin_src emacs-lisp
(use-package treemacs
  :defer t
  :custom-face
  (cfrs-border-color ((t (:inherit posframe-border))))
  (treemacs-root-face ((t (:inherit font-lock-constant-face :height 1.1 :weight bold))))
  :custom
  (treemacs-width 33)
  (treemacs-position 'left)
  (treemacs-is-never-other-window t)
  (treemacs-space-between-root-nodes t)
  (treemacs-silent-refresh t)
  (treemacs-silent-filewatch t)
  (treemacs-file-follow-delay 0.2)
  (treemacs-show-cursor nil)
  :config
  (treemacs-follow-mode t)
  (treemacs-filewatch-mode t)
  (treemacs-fringe-indicator-mode 'always)

  ;; Git integration configuration
  (when (and (executable-find "git")
             (executable-find "python3"))
    (treemacs-git-mode 'deferred)
    (setq treemacs-collapse-dirs 3))
  (when (and (executable-find "git")
             (not (executable-find "python3")))
    (treemacs-git-mode 'simple)
    (setq treemacs-collapse-dirs 0)))

;; treemacs-nerd-icons with hidden directory arrows
(use-package treemacs-nerd-icons
  :defer t
  :after treemacs
  :config (treemacs-load-theme "nerd-icons"))

;; Magit integration (refresh sidebar on git changes)
(use-package treemacs-magit
  :after (treemacs magit)
  :hook ((magit-post-commit
          git-commit-post-finish
          magit-post-stage
          magit-post-unstage)
         . treemacs-magit--schedule-update))

(use-package treemacs-tab-bar
  :after (treemacs)
  :config (treemacs-set-scope-type 'Tabs))

;; Evil navigation in the sidebar with mouse interface
(use-package treemacs-evil
  :after (treemacs evil)
  :config
  (evil-define-key 'normal treemacs-mode-map
    (kbd "TAB") #'treemacs-TAB-action
    (kbd "o")   #'treemacs-visit-node-ace
    (kbd "q")   #'treemacs-quit
    ;; Mouse interface
    [mouse-1] #'treemacs-single-click-expand-action
    [double-mouse-1] #'treemacs-doubleclick-action
    [drag-mouse-1] #'treemacs-dragleftclick-action))
#+end_src

* DONE Completion Framework
** DONE Orderless
#+begin_src emacs-lisp
(use-package orderless
  :custom
  (completion-styles '(orderless basic))
  (completion-category-overrides '((file (styles partial-completion))))
  (completion-category-defaults nil) ;; Disable defaults, use our settings
  (completion-pcm-leading-wildcard t)) ;; Emacs 31: partial-completion behaves like substring
#+end_src

** DONE Vertico
VERTical Interactive COmpletion
#+begin_src emacs-lisp
(use-package vertico
  :custom
  (vertico-count 10)
  (vertico-resize nil)
  (vertico-cycle t)
  :init
  (vertico-mode)

  :bind (:map vertico-map
         ("RET" . vertico-directory-enter)
         ("DEL" . vertico-directory-delete-char)
         ("M-DEL" . vertico-directory-delete-word))
  :hook ((rfn-eshadow-update-overlay . vertico-directory-tidy)))
#+end_src

** DONE Marginalia
Enrich existing commands with completion annotations
#+begin_src emacs-lisp
(use-package marginalia
  :init
  (marginalia-mode)
  :config
  (setq marginalia-max-relative-age 0 ; Always show absolute time
        marginalia-align 'right))
#+end_src

** DONE Nerd Icons Completion
#+begin_src emacs-lisp
(use-package nerd-icons-completion
  :after marginalia
  :config
  (nerd-icons-completion-mode)
  (add-hook 'marginalia-mode-hook #'nerd-icons-completion-marginalia-setup))
#+end_src

** DONE Consult
#+begin_src emacs-lisp
(use-package consult
  :defines (xref-show-xrefs-function xref-show-definitions-function)
  :defines shr-color-html-colors-alist
  :autoload (consult-register-format consult-register-window consult-xref)
  :autoload (consult--read consult--customize-put)
  :commands (consult-narrow-help)
  :functions (list-colors-duplicates consult-colors--web-list)
  :bind (([remap switch-to-buffer] . consult-buffer)
         ([remap switch-to-buffer-other-window] . consult-buffer-other-window)
         ([remap switch-to-buffer-other-frame] . consult-buffer-other-frame)
         ([remap bookmark-jump] . consult-bookmark)
         ([remap evil-show-marks] . consult-mark)
         ([remap evil-show-jumps] . consult-jump-list)
         ([remap goto-line] . consult-goto-line)
         ([remap imenu] . consult-imenu)
         ([remap load-theme] . consult-theme)
         ([remap recentf-open-files] . consult-recent-file)
         ([remap yank-pop] . consult-yank-pop)
         ([remap InfO-search]        . consult-info)
         ([remap isearch-forward]    . consult-line))
  :hook (completion-list-mode . consult-preview-at-point-mode)
  :init
  (setq register-preview-delay 0.5
        register-preview-function #'consult-register-format)
  (advice-add #'register-preview :override #'consult-register-window)

  (with-eval-after-load 'xref
    (setq xref-show-xrefs-function #'consult-xref
          xref-show-definitions-function #'consult-xref))

  (defvar consult-colors-history nil
    "History for `consult-colors-emacs' and `consult-colors-web'.")

  (autoload 'list-colors-duplicates "facemenu")
  (autoload 'consult--read "consult")

  (defun consult-colors-emacs (color)
    "Show a list of all supported colors for a particular frame."
    (interactive
     (list (consult--read (list-colors-duplicates (defined-colors))
                          :prompt "Emacs color: "
                          :require-match t
                          :category 'color
                          :history '(:input consult-colors-history))))
    (insert color))

  (defun consult-colors--web-list nil
    "Return list of CSS colors for `counsult-colors-web'."
    (require 'shr-color)
    (sort (mapcar #'downcase (mapcar #'car shr-color-html-colors-alist)) #'string-lessp))

  (defun consult-colors-web (color)
    "Show a list of all CSS colors."
    (interactive
     (list (consult--read (consult-colors--web-list)
                          :prompt "Color: "
                          :require-match t
                          :category 'color
                          :history '(:input consult-colors-history))))
    (insert color))
  :config
  (setq consult-preview-key nil)

  (defvar consult--source-file-visiting-buffer
    `(:name "Main"
      :narrow ?f
      :category buffer
      :face consult-buffer
      :history buffer-name-history
      :state ,#'consult--buffer-state
      :default t
      :items ,(lambda ()
                (consult--buffer-query
                 :sort 'visibility
                 :predicate (lambda (buf)
                              (buffer-file-name buf))
                 :as #'buffer-name)))
    "Buffer source for file-visiting buffers only.")

  (setq consult-buffer-sources
        '(consult--source-file-visiting-buffer))

  ;; Removed :initial. Use M-n to insert symbol-at-point dynamically.
  (consult-customize
   consult-line consult-line-multi :preview-key 'any
   consult-buffer consult-recent-file consult-theme :preview-key '(:debounce 1.0 any)
   consult-goto-line :preview-key '(:debounce 0.5 any)
   consult-ripgrep consult-git-grep consult-grep
   :preview-key '(:debounce 0.5 any))

  (setq consult-narrow-key "<")
  (define-key consult-narrow-map (vconcat consult-narrow-key "?") #'consult-narrow-help))

#+end_src

** DONE Consult Dir
#+begin_src emacs-lisp
(use-package consult-dir :defer t)
#+end_src

** DONE Consult-Project-Extra
#+begin_src emacs-lisp
(use-package consult-project-extra
  :defer t
  :custom (consult-project-function #'consult-project-extra-project-fn)
  :config
  ;; Frame-local project filtering (requires tabspaces)
  (with-eval-after-load 'tabspaces
    (defun ar/consult-project-filter (projects)
      "Filter PROJECTS to only show those in the current frame."
      (let ((frame-projects (ar/frame-projects)))
        (if (null frame-projects)
            projects
          (seq-filter (lambda (proj)
                       (member (expand-file-name proj) frame-projects))
                     projects))))

    (advice-add 'consult-project-extra--known-projects
                :filter-return
                #'ar/consult-project-filter))

  :bind
  (("C-c p f" . consult-project-extra-find)
   ("C-c p o" . consult-project-extra-find-other-window)))
#+end_src

** DONE Embark
#+begin_src emacs-lisp
(use-package embark
  :commands embark-prefix-help-command
  :init
  (setq prefix-help-command #'embark-prefix-help-command)
  :config
  ;; Manual preview for non-Consult commands using Embark
  (defun my-embark-preview ()
    "Previews candidate in vertico buffer, unless it's a consult command."
    (interactive)
    (unless (bound-and-true-p consult--preview-function)
      (save-selected-window
        (let ((embark-quit-after-action nil))
          (embark-dwim)))))

  ;; Hide the mode line of the Embark live/completions buffers
  (add-to-list 'display-buffer-alist
               '("\\`\\*Embark Collect \\(Live\\|Completions\\)\\*"
                 nil
                 (window-parameters (mode-line-format . none))))

  (with-no-warnings
    (with-eval-after-load 'which-key
      (defun embark-which-key-indicator ()
        "An embark indicator that displays keymaps using which-key.
The which-key help message will show the type and value of the
current target followed by an ellipsis if there are further
targets."
        (lambda (&optional keymap targets prefix)
          (if (null keymap)
              (which-key--hide-popup-ignore-command)
            (which-key--show-keymap
             (if (eq (plist-get (car targets) :type) 'embark-become)
                 "Become"
               (format "Act on %s '%s'%s"
                       (plist-get (car targets) :type)
                       (embark--truncate-target (plist-get (car targets) :target))
                       (if (cdr targets) "…" "")))
             (if prefix
                 (pcase (lookup-key keymap prefix 'accept-default)
                   ((and (pred keymapp) km) km)
                   (_ (key-binding prefix 'accept-default)))
               keymap)
             nil nil t (lambda (binding)
                         (not (string-suffix-p "-argument" (cdr binding))))))))

      (setq embark-indicators
            '(embark-which-key-indicator
              embark-highlight-indicator
              embark-isearch-highlight-indicator))

      (defun embark-hide-which-key-indicator (fn &rest args)
        "Hide the which-key indicator immediately when using the completing-read prompter."
        (which-key--hide-popup-ignore-command)
        (let ((embark-indicators
               (remq #'embark-which-key-indicator embark-indicators)))
          (apply fn args)))

      (advice-add #'embark-completing-read-prompter
                  :around #'embark-hide-which-key-indicator))))
#+end_src

** DONE Embark Consult
#+begin_src emacs-lisp
(use-package embark-consult
  :defer t
  :after (embark consult)
  :hook
  (embark-collect-mode . consult-preview-at-point-mode))
#+end_src

** DONE Corfu
#+begin_src emacs-lisp
(use-package corfu
  :autoload (corfu-quit consult-completion-in-region)
  :functions (persistent-scratch-save corfu-move-to-minibuffer)
  :custom
  (corfu-cycle t)
  (corfu-auto t)
  (corfu-auto-prefix 3)
  (corfu-count 12)
  (corfu-preselect 'prompt)
  (corfu-preview-current nil)
  (corfu-on-exact-match nil)
  (corfu-auto-delay 0.5)
  (global-corfu-modes '((not erc-mode
                             circe-mode
                             help-mode
                             gud-mode
                             vterm-mode)
                        t))
  :custom-face
  (corfu-border ((t (:inherit region :background unspecified))))
  :bind
  (:map corfu-map
        ("TAB" . corfu-next)
        ([tab] . corfu-next)
        ("S-TAB" . corfu-previous)
        ([backtab] . corfu-previous)
        ("M-h" . corfu-info-documentation))
  :hook ((after-init . global-corfu-mode)
         (global-corfu-mode . corfu-history-mode))
  :config
  ;;Quit completion before saving
  (add-hook 'before-save-hook #'corfu-quit)
  (advice-add #'persistent-scratch-save :before #'corfu-quit))
#+end_src

** DONE Basic Completion
#+begin_src emacs-lisp
(use-package emacs
  :straight (:type built-in)
  :custom
  (tab-always-indent 'complete)
  (text-mode-ispell-word-completion nil)
  (read-extended-command-predicate #'command-completion-default-include-p))
#+end_src

** DONE Nerd Icons Corfu
#+begin_src emacs-lisp
(use-package nerd-icons-corfu
  :autoload nerd-icons-corfu-formatter
  :after corfu
  :init (add-to-list 'corfu-margin-formatters #'nerd-icons-corfu-formatter))
#+end_src

** DONE Cape

#+begin_comment
===========================================================================
CAPE / CORFU CONFIGURATION & DEBUGGING GUIDE
===========================================================================

CONTEXT:
Emacs completion in Org Mode source blocks is complex due to three conflicting factors:
1. Org Mode's Native Completion: Org has its own CAPF (`org-block-capf`) that
   often aggressively claims priority, preventing other backends from running.
2. Large File Optimization (JIT Lock): In files >3000 lines, Emacs delays
   fontification (syntax highlighting). `cape-elisp-block` natively relies on
   detecting the `org-block` face to know it's inside code. In large files,
   this face is often missing, causing Cape to fail (return nil).
3. Syntax Corruption: Even if detection works, standard `elisp-completion-at-point`
   uses the buffer's global syntax table (Org syntax). In large files, parsing
   state (`syntax-ppss`) gets corrupted by previous Org headings/drawers, causing
   the Lisp parser to think it's inside a string/comment and return no results.

THE SOLUTION (`ar/org-elisp-capf`):
We implement a custom Completion-At-Point Function (CAPF) that:
1. STRUCTURAL DETECTION: Uses `org-element-at-point` instead of visual faces,
   guaranteeing detection even in un-fontified large files.
2. NARROWING: We `narrow-to-region` around the code block content. This is
   critical because it resets the `syntax-ppss` parser cache, forcing it to
   parse the Lisp code from a clean state (point-min) without pollution from
   the preceding 50,000 lines of Org text.
3. BOUNDARY SAFETY: We manually calculate start/end points to exclude
   `#+begin_src` headers so the parser sees only pure Lisp code.
4. SYNTAX SWAPPING: We temporarily enforce `emacs-lisp-mode-syntax-table`
   so atoms/lists are read correctly.

DEBUGGING / TESTING:
If completion fails in the future, check these:
1. Run `M-x describe-char` inside the block. If `face: org-block` is missing,
   the structural fix is doing its job.
2. Verify `completion-at-point-functions` variable (C-h v). `ar/org-elisp-capf`
   must be at the START of the list (depth -100).
3. If Corfu crashes with "Point outside narrowing", ensure the manual
   boundary calculation logic handles the current cursor position.

===========================================================================
#+end_comment

#+begin_src emacs-lisp
(use-package cape
  :init
  ;; 1. Global Setup
  (add-hook 'completion-at-point-functions #'cape-tex)
  (add-hook 'completion-at-point-functions #'cape-dict)
  (add-hook 'completion-at-point-functions #'cape-dabbrev)
  (add-hook 'completion-at-point-functions #'cape-file)
  (add-hook 'completion-at-point-functions #'cape-keyword)

  ;; NOTE: We do NOT add cape-elisp-block globally here.
  ;; We use the custom function below for Org mode instead.

  ;; -----------------------------------------------------------------------
  ;; 2. Robust Elisp Completion for Large Org Files (Narrowing Strategy)
  ;; -----------------------------------------------------------------------
  (defun ar/org-elisp-capf ()
    "A robust Capf for Elisp in Org mode.
    It identifies the block, narrows to the inner content (excluding headers),
    switches to Elisp syntax, and then completes."
    ;; Cheap check first to avoid overhead
    (when (org-in-src-block-p)
      (let ((element (org-element-at-point)))
        (when (and (eq (org-element-type element) 'src-block)
                   (member (org-element-property :language element)
                           '("elisp" "emacs-lisp")))
          (let* ((block-start (org-element-property :post-affiliated element))
                 (block-end (org-element-property :end element))
                 ;; Calculate inner start: Jump to header start, move down 1 line
                 (code-beg (save-excursion
                             (goto-char block-start)
                             (forward-line 1)
                             (point)))
                 ;; Calculate inner end: Jump to block end, move up 1 line
                 ;; (This excludes the #+end_src line)
                 (code-end (save-excursion
                             (goto-char block-end)
                             (forward-line -1)
                             (point))))
            ;; ROBUSTNESS CHECK 1: Ensure boundaries are valid numbers
            (when (and (numberp code-beg)
                       (numberp code-end)
                       (< code-beg code-end))
              ;; ROBUSTNESS CHECK 2: Ensure point is strictly inside the code.
              ;; If we are on #+begin_src, narrowing would fail/crash.
              ;; Returning nil lets Org handle header completion instead.
              (when (and (>= (point) code-beg)
                         (<= (point) code-end))
                (save-restriction
                  ;; Narrow to the code itself so the parser doesn't see Org headers
                  ;; and the syntax-ppss cache is reset for this region.
                  (narrow-to-region code-beg code-end)
                  (with-syntax-table emacs-lisp-mode-syntax-table
                    (elisp-completion-at-point))))))))))

  (defun ar/setup-org-cape-completion ()
    ;; Add to the VERY FRONT (-100) to bypass Org's native completion
    (add-hook 'completion-at-point-functions #'ar/org-elisp-capf -100 t))

  (add-hook 'org-mode-hook #'ar/setup-org-cape-completion)

  ;; -----------------------------------------------------------------------
  ;; 3. Advice Wrappers
  ;; -----------------------------------------------------------------------
  (advice-add #'lsp-completion-at-point :around #'cape-wrap-noninterruptible)
  (advice-add #'lsp-completion-at-point :around #'cape-wrap-nonexclusive)
  (advice-add #'comint-completion-at-point :around #'cape-wrap-nonexclusive)
  (advice-add #'eglot-completion-at-point :around #'cape-wrap-nonexclusive)
  (advice-add #'pcomplete-completions-at-point :around #'cape-wrap-nonexclusive))
#+end_src

** DONE Dabbrev
#+begin_src emacs-lisp
(use-package dabbrev
  :straight (:type built-in)
  :config
  (add-to-list 'dabbrev-ignored-buffer-regexps "\\` ")
  (add-to-list 'dabbrev-ignored-buffer-modes 'doc-view-mode)
  (add-to-list 'dabbrev-ignored-buffer-modes 'pdf-view-mode)
  (add-to-list 'dabbrev-ignored-buffer-modes 'vterm-mode)
  (add-to-list 'dabbrev-ignored-buffer-modes 'eshell-mode)
  (add-to-list 'dabbrev-ignored-buffer-modes 'tags-table-mode))
#+end_src


* TODO Consult Roam - combine these keybindings with general
#+begin_src emacs-lisp
(use-package consult-org-roam
  :after org-roam
  :init
  (require 'consult-org-roam)
  (consult-org-roam-mode 1)
  :custom
  (consult-org-roam-grep-func #'consult-ripgrep)
  (consult-org-roam-buffer-narrow-key ?r)
  (consult-org-roam-buffer-after-buffers t)
  :config
  (consult-customize
   consult-org-roam-forward-links
   :preview-key "M-."))
#+end_src

* TODO Development Tools
** OKAY Direnv
#+begin_src emacs-lisp
(use-package envrc
  :hook (after-init . envrc-global-mode))
#+end_src

** TODO LSP - handle the org-src-context.el file
#+begin_src emacs-lisp
(use-package eglot
  :straight (:type built-in)
  :defer t
  :hook
  ((prog-mode . (lambda ()
                  (unless (derived-mode-p
                           'emacs-lisp-mode 'lisp-mode
                           'makefile-mode 'snippet-mode
                           'ron-mode)
                    (eglot-ensure))))
   ((markdown-mode yaml-mode yaml-ts-mode) . eglot-ensure))

  :init
  ;; Optimization: disable logging events to improve performance
  (setq eglot-events-buffer-size 0)
  ;; Optimization: delay sending changes to the server slightly (0.5s)
  (setq eglot-send-changes-idle-time 0.5)
  ;; Shutdown server when the last buffer managed by it is closed
  (setq eglot-autoshutdown nil))

(use-package eglot-booster
  :straight (:host github :repo "jdtsmith/eglot-booster")
  :after eglot
  :init
  (setq eglot-booster-io-only
        ;; JSON parser on 30+ is faster, so we only exploit eglot-booster's IO buffering (benefits more talkative LSP servers).
        (and (> emacs-major-version 29)
             (not (functionp 'json-rpc-connection))))
  :config
  (eglot-booster-mode))

;; (use-package org-src-context
;;   :straight (:type built-in) ; Relies on lisp/org-src-context.el
;;   :hook (after-init . org-src-context-mode)
;;   :custom
;;   ;; Visual: Set to 'nil' to see the grayed-out context surrounding your block.
;;   ;; Set to 't' if you prefer a focused view (narrowed to just your code).
;;   (org-src-context-narrow-p nil)

;;   ;; Safety: Disable context injection for files larger than 500KB to prevent lag.
;;   (org-src-context-max-filesize 500000)

;;   :config
;;   ;; Enable Apheleia (auto-formatting) inside the edit buffer.
;;   ;; The patched org-src-context ensures a valid file path exists for this to work.
;;   (with-eval-after-load 'apheleia
;;     (add-hook 'org-src-mode-hook
;;               (lambda ()
;;                 (apheleia-mode 1)))))

;; Integration with Consult for searching symbols
(use-package consult-eglot
  :defer t
  :after consult
  :bind (:map eglot-mode-map
         ("C-M-." . consult-eglot-symbols)))

(use-package consult-eglot-embark :defer t)
#+end_src

** DONE Syntax Checking
#+begin_src emacs-lisp
(use-package flymake
  :straight (:type built-in)
  :defer t
  :hook (prog-mode . flymake-mode)
  :custom
  ;; Doom-inspired behavior: better navigation and visual density
  (flymake-fringe-indicator-position 'right-fringe)
  (flymake-wrap-around t)
  (flymake-suppress-zero-counters t)
  (flymake-no-changes-timeout 0.5)
  (flymake-start-on-save-buffer t)
  :config
  ;; UI: Doom Emacs Double-Arrow Fringe Bitmaps
  (define-fringe-bitmap 'ar/flymake-double-arrow
    [#b00000000 #b00010000 #b00011000 #b00011100 #b00011110
     #b00011100 #b00011000 #b00010000 #b00000000])

  (setq flymake-error-bitmap   '(ar/flymake-double-arrow flymake-error)
        flymake-warning-bitmap '(ar/flymake-double-arrow flymake-warning)
        flymake-note-bitmap    '(ar/flymake-double-arrow flymake-note))

  ;; UI: Nerd Icons in Diagnostics Buffer (SPC c B)
  (defun ar/flymake-diagnostics-buffer-icons ()
    "Apply nerd-icons to the Flymake diagnostics buffer."
    (when (derived-mode-p 'flymake-diagnostics-mode)
      (save-excursion
        (goto-char (point-min))
        (while (re-search-forward "^\\s-*\\(error\\|warning\\|note\\)" nil t)
          (let* ((type (match-string 1))
                 (icon (pcase type
                         ("error"   (nerd-icons-faicon "nf-fa-times_circle" :face 'flymake-error))
                         ("warning" (nerd-icons-faicon "nf-fa-exclamation_circle" :face 'flymake-warning))
                         ("note"    (nerd-icons-faicon "nf-fa-info_circle" :face 'flymake-note)))))
            (add-text-properties (match-beginning 1) (match-end 1) `(display ,icon)))))))
  (add-hook 'flymake-diagnostics-mode-hook #'ar/flymake-diagnostics-buffer-icons)

  ;; Navigation Logic
  (defun ar/flymake-next-error () (interactive) (flymake-goto-next-error 1 '(:error :warning) t))
  (defun ar/flymake-prev-error () (interactive) (flymake-goto-prev-error 1 '(:error :warning) t)))

;; (use-package flymake-popon
;;   :hook (flymake-mode . flymake-popon-mode)
;;   :custom
;;   (flymake-popon-method 'posframe)
;;   (flymake-popon-delay 0.2)
;;   :config
;;   ;; Border logic to match your custom posframe configuration
;;   (set-face-attribute 'flymake-popon-posframe-border nil
;;                       :background (face-attribute 'posframe-border :background nil t)))
#+end_src

** DONE Formatting
#+begin_src emacs-lisp
(use-package apheleia
  :hook (after-init . apheleia-global-mode)
  :custom
  (apheleia-log-only-errors t)
  :config
  ;; === THE CORRECTED LSP BRIDGE ===
  ;; We use cl-defun because Apheleia v3+ passes arguments as keywords.
  ;; Note: 'buffer' is the original buffer, 'scratch' is where formatting should happen.
  (cl-defun ar/apheleia-format-with-eglot (&key buffer scratch callback &allow-other-keys)
    "Format with Eglot if available; otherwise return nil to fallback."
    (with-current-buffer buffer
      (if (and (bound-and-true-p eglot--managed-mode)
               (eglot-server-capable :documentFormattingProvider))
          (progn
            ;; Silence eglot messages during the background format
            (cl-letf (((symbol-function 'message) #'ignore))
              (eglot-format-buffer))
            ;; After eglot-format-buffer runs on the original,
            ;; we copy the result to scratch so Apheleia can diff it.
            (with-current-buffer scratch
              (erase-buffer)
              (insert-buffer-substring buffer))
            ;; Tell Apheleia we are done and provide the formatted scratch buffer
            (funcall callback scratch))
        ;; Return nil to tell Apheleia to move to the next CLI tool in the list
        (funcall callback nil))))

  ;; Add the corrected eglot bridge to formatters
  (push '(eglot . ar/apheleia-format-with-eglot) apheleia-formatters)

  ;; Inhibit for prose where whitespace is sensitive
  (setq apheleia-inhibit-functions
        (list (lambda () (derived-mode-p 'org-mode)))))
#+end_src

** DONE Symbols Outline
#+begin_src emacs-lisp
(use-package symbols-outline
  :defer t
  :init
  (add-hook 'eglot-managed-mode-hook
            (lambda ()
              (setq-local symbols-outline-fetch-fn #'symbols-outline-lsp-fetch)))
  :config
  (setq symbols-outline-window-position 'left)
  (symbols-outline-follow-mode))
#+end_src

** TODO Dape - Add transient menu
#+begin_src emacs-lisp
(use-package dape
  :defer t
  :bind ("<f5>" . ar/toggles-dape)
  :hook
  (kill-emacs . dape-breakpoint-save)
  (after-init . dape-breakpoint-load)

  :custom
  (dape-breakpoint-global-mode +1)
  (dape-buffer-window-arrangement 'right)
  ;; Info buffers like gud (gdb-mi)
  ;; (dape-buffer-window-arrangement 'gud)
  ;; (dape-info-hide-mode-line nil)

  ;; Projectile users
  ;; (dape-cwd-function #'projectile-project-root)

  :config
  (add-hook 'dape-display-source-hook #'pulse-momentary-highlight-one-line)
  (add-hook 'dape-start-hook (lambda () (save-some-buffers t t)))
  (add-hook 'dape-compile-hook #'kill-buffer)

  (with-eval-after-load 'transient
    (defun ar/dape-title ()
      (concat
       (if (fboundp 'nerd-icons-codicon)
           (nerd-icons-codicon "nf-cod-debug" :face 'transient-heading :v-adjust 0.02)
         "")
       (propertize " Debug" 'face 'transient-heading)))

    (transient-define-prefix ar/toggles-dape ()
      "Debugger"
      [:description ar/dape-title
                    ["Stepping"
                     ("n" "next" dape-next :transient t)
                     ("s" "step in" dape-step-in :transient t)
                     ("o" "step out" dape-step-out :transient t)
                     ("c" "continue" dape-continue :transient t)
                     ("p" "pause" dape-pause :transient t)
                     ("r" "restart" dape-restart :transient t)]

                    ["Switch"
                     ("m" "memory" dape-memory :transient t)
                     ("t" "thread" dape-select-thread :transient t)
                     ("w" "watch" dape-watch-dwim :transient t)
                     ("s" "stack" dape-select-stack :transient t)
                     ("i" "info" dape-info :transient t)
                     ("r" "repl" dape-repl :transient t)]

                    ["Breakpoints"
                     ("b" "toggle" dape-breakpoint-toggle :transient t)
                     ("l" "log" dape-breakpoint-log :transient t)
                     ("e" "expression" dape-breakpoint-expression :transient t)
                     ("B" "clear" dape-breakpoint-remove-all :transient t)]

                    ["Debug"
                     ("d" "dape" dape :transient t)
                     ("D" "disconnect" dape-disconnect-quit)
                     ("k" "kill" dape-kill)
                     ("Q" "quit" dape-quit)
                     ("<f5>" "" transient-quit-one :format " ")]]))
  )
#+end_src

** TODO Eldoc-box
#+begin_src emacs-lisp
(use-package eldoc-box
  :defer t
  :commands (eldoc-box-help-at-point eldoc-box-eglot-help-at-point)
  :init
  ;; Bind K in normal/visual mode for on-demand documentation
  (with-eval-after-load 'evil
    (evil-define-key '(normal visual) 'global (kbd "K") #'eldoc-box-help-at-point))

  :custom
  ;; Dimensions optimized for JetBrains Mono at height 125
  (eldoc-box-max-pixel-width 800)
  (eldoc-box-max-pixel-height 600)

  ;; Display multi-line in childframe, single-line in minibuffer
  (eldoc-box-only-multi-line t)

  ;; Quick cleanup for responsive feel
  (eldoc-box-cleanup-interval 0.5)

  ;; Match posframe fringe behavior
  (eldoc-box-fringe-use-same-bg t)

  ;; Clean mode-line
  (eldoc-box-lighter nil)

  ;; Offset from point (left, right, top) - nice positioning
  (eldoc-box-offset '(16 16 16))

  :config
  ;; === Theme Integration ===
  ;; Match doom-tokyo-night and posframe border styling
  (defface eldoc-box-border
    `((t (:background ,(face-attribute 'region :background nil t)
          :inherit region)))
    "Eldoc-box border face matching posframe styling."
    :group 'eldoc-box)

  (defface eldoc-box-body
    `((t (:background ,(face-attribute 'default :background nil t)
          :family "JetBrains Mono"
          :height 125)))
    "Eldoc-box body face with JetBrains Mono font."
    :group 'eldoc-box)

  ;; === Buffer Enhancements ===
  ;; Better text wrapping and font rendering
  (add-hook 'eldoc-box-buffer-hook
            (lambda ()
              (visual-line-mode 1)
              (face-remap-add-relative 'default :family "JetBrains Mono" :height 125)))

  ;; === Frame Styling ===
  ;; Match posframe aesthetics
  (add-hook 'eldoc-box-frame-hook
            (lambda (frame)
              (set-face-background 'fringe nil frame)
              (set-face-background 'internal-border
                                   (face-attribute 'posframe-border :background nil t)
                                   frame)))

  ;; === Eglot Integration ===
  ;; Configure eldoc strategy for LSP documentation
  (with-eval-after-load 'eglot
    (defun ar/eldoc-box-eglot-setup ()
      "Configure eldoc display strategy for eglot buffers."
      (setq-local eldoc-documentation-strategy #'eldoc-documentation-compose))
    (add-hook 'eglot-managed-mode-hook #'ar/eldoc-box-eglot-setup))

  ;; === System Compatibility Check ===
  (when (not (childframe-workable-p))
    (message "Warning: eldoc-box childframes may not work on this system")))
#+end_src

** TODO Eldoc Mouse
#+begin_src emacs-lisp
(use-package eldoc-mouse
  :hook (eldoc-mode . eldoc-mouse-mode)
  :init
  (setq eldoc-mouse-posframe-border-color (face-background 'posframe-border nil t))
  :config
  (tooltip-mode -1)
  (add-to-list 'eldoc-mouse-posframe-override-parameters
               `(background-color . ,(face-background 'tooltip nil t))))

#+end_src



** TODO Breadcrumbs
#+begin_src emacs-lisp
#+end_src

** TODO Transient Menu
#+begin_src emacs-lisp
;; (pretty-hydra-define dev-hydra
;;   (:title (pretty-hydra-title "Development" 'codicon "nf-cod-code" :face 'nerd-icons-blue)
;;    :color amaranth :quit-key ("q" "C-g"))
;;   ("LSP (Eglot)"
;;    (("a" eglot-code-actions "actions")
;;     ("r" eglot-rename "rename")
;;     ("d" xref-find-definitions "definition")
;;     ("D" xref-find-references "references")
;;     ("s" consult-eglot-symbols "symbols")
;;     ("h" eldoc "hover doc"))

;;    "Syntax (Flymake)"
;;    (("n" ar/flymake-next-error "next error")
;;     ("p" ar/flymake-prev-error "prev error")
;;     ("b" flymake-show-buffer-diagnostics "buffer list")
;;     ("B" consult-flymake "project list")
;;     ("!" flymake-running-backends "backends"))

;;    "Formatting"
;;    (("f" apheleia-format-buffer "format buffer")
;;     ("F" (lambda () (interactive) (let ((apheleia-formatter 'eglot)) (apheleia-format-buffer))) "format w/ LSP"))

;;    "Toggles"
;;    (("t l" eglot-managed-p "LSP mode" :toggle t)
;;     ("t s" flymake-mode "syntax mode" :toggle t)
;;     ("t f" apheleia-mode "auto-format" :toggle t)
;;     ("t e" eldoc-mode "eldoc" :toggle t)
;;     ("t p" flymake-popon-mode "popon tooltips" :toggle t))))
#+end_src

* DONE Treesitter/Folding
** DONE Treesit
#+begin_src emacs-lisp
(use-package treesit
  :straight (:type built-in)
  :mode (("\\.tsx\\'" . tsx-ts-mode))
  :init
  (defvar ar/treesit-grammar-dir
    (file-truename (expand-file-name "tree-sitter/" user-emacs-directory))
    "Target directory for installing tree-sitter grammars.")

  (unless (file-exists-p ar/treesit-grammar-dir)
    (make-directory ar/treesit-grammar-dir t))

  (add-to-list 'treesit-extra-load-path ar/treesit-grammar-dir)

  :config
  (setq treesit-font-lock-level 4)

  (setq treesit-language-source-alist
        '((python "https://github.com/tree-sitter/tree-sitter-python")
          (bash "https://github.com/tree-sitter/tree-sitter-bash")
          (dockerfile "https://github.com/camdencheek/tree-sitter-dockerfile.git")
          (json "https://github.com/tree-sitter/tree-sitter-json")
          (nix "https://github.com/nix-community/tree-sitter-nix")
          (typescript "https://github.com/tree-sitter/tree-sitter-typescript" "master" "typescript/src")
          (tsx "https://github.com/tree-sitter/tree-sitter-typescript" "master" "tsx/src")))

  (setq major-mode-remap-alist
        '((python-mode . python-ts-mode)
          (json-mode . json-ts-mode)
          (js-mode . js-ts-mode)
          (typescript-mode . typescript-ts-mode)
          (conf-toml-mode . toml-ts-mode))))
#+end_src

** DONE Treesit-Fold
#+begin_src emacs-lisp
(use-package treesit-fold
  :defer t
  :straight (:host github :repo "emacs-tree-sitter/treesit-fold")
  ;; :custom
  ;; (treesit-fold-indicators-priority -1)
  :config
  (global-treesit-fold-mode 1)
  (global-treesit-fold-indicators-mode 1))
#+end_src

** DONE Evil Text Objects
#+begin_src emacs-lisp
(use-package evil-textobj-tree-sitter
  :defer t
  :after evil
  :config
  ;; Bindings for function objects (next/prev)
  (define-key evil-normal-state-map (kbd "]f")
              (lambda () (interactive) (evil-textobj-tree-sitter-goto-textobj "function.outer")))
  (define-key evil-normal-state-map (kbd "[f")
              (lambda () (interactive) (evil-textobj-tree-sitter-goto-textobj "function.outer" t)))
  (define-key evil-normal-state-map (kbd "]F")
              (lambda () (interactive) (evil-textobj-tree-sitter-goto-textobj "function.outer" nil t)))
  (define-key evil-normal-state-map (kbd "[F")
              (lambda () (interactive) (evil-textobj-tree-sitter-goto-textobj "function.outer" t t)))

  (define-key evil-inner-text-objects-map "f" (evil-textobj-tree-sitter-get-textobj "function.inner"))
  (define-key evil-outer-text-objects-map "f" (evil-textobj-tree-sitter-get-textobj "function.outer"))
  (define-key evil-inner-text-objects-map "c" (evil-textobj-tree-sitter-get-textobj "class.inner"))
  (define-key evil-outer-text-objects-map "c" (evil-textobj-tree-sitter-get-textobj "class.outer"))

  (define-key evil-inner-text-objects-map "a" (evil-textobj-tree-sitter-get-textobj "parameter.inner"))
  (define-key evil-outer-text-objects-map "a" (evil-textobj-tree-sitter-get-textobj "parameter.outer")))
#+end_src

** DONE Vimish Fold
#+begin_src emacs-lisp
(use-package vimish-fold
  :defer t
  :after evil
  :config (vimish-fold-global-mode 1))

(use-package evil-vimish-fold
  :defer t
  :after vimish-fold
  :init
  (setq evil-vimish-fold-mode-lighter " ⮒")
  (setq evil-vimish-fold-target-modes '(prog-mode conf-mode text-mode))
  :config (global-evil-vimish-fold-mode))
#+end_src

* DONE Highlight TODOs
** hl-todo
#+begin_src emacs-lisp
(use-package hl-todo
  :defer t
  :commands (hl-todo-rg-project hl-todo-rgrep hl-todo-next hl-todo-previous hl-todo-occur)

  :custom-face
  (hl-todo ((t (:inherit default :height 0.9 :width condensed :weight bold :underline nil :inverse-video nil))))

  :hook ((after-init . global-hl-todo-mode)
         (org-mode . hl-todo-mode))

  :custom
  (hl-todo-require-punctuation t)
  (hl-todo-highlight-punctuation ":")

  :config
  ;; Define keywords with Tokyo Night colors
  (setq hl-todo-keyword-faces
        '(("TODO"       . "#e0af68")  ; Yellow
          ("FIXME"      . "#f7768e")  ; Red
          ("BUG"        . "#f7768e")  ; Red
          ("ISSUE"      . "#f7768e")  ; Red
          ("PROG"       . "#7aa2f7")  ; Blue
          ("TRICK"      . "#ff9e64")  ; Orange
          ("WORKAROUND" . "#ff9e64")  ; Orange
          ("BENCHMARK"  . "#9ece6a")  ; Green
          ("REVIEW"     . "#7dcfff")  ; Cyan
          ("NOTE"       . "#bb9af7")  ; Purple
          ("DEPRECATED" . "#73daca")  ; Teal
          ("HACK"       . "#db4b4b")  ; Darker Red
          ("DEBUG"      . "#e0af68")  ; Yellow
          ("STUB"       . "#e0af68"))) ; Yellow

  ;; Enhanced project search function with fallback
  (defun hl-todo-rg-project ()
    "Use `consult-ripgrep' to find TODO keywords in the current project.
Falls back to `hl-todo-rgrep' if consult-ripgrep is not available."
    (interactive)
    (let ((regexp (concat "\\b(" (string-join (mapcar #'car hl-todo-keyword-faces) "|") ")\\b")))
      (cond
       ;; Prefer consult-ripgrep for better UI
       ((fboundp 'consult-ripgrep)
        (consult-ripgrep nil regexp))
       ;; Fallback to built-in hl-todo-rgrep
       ((fboundp 'hl-todo-rgrep)
        (hl-todo-rgrep))
       (t
        (user-error "Neither consult-ripgrep nor hl-todo-rgrep is available")))))

  ;; Add hl-todo-mode to consult preview hooks for better highlighting
  (with-eval-after-load 'consult
    (when (boundp 'consult-preview-allowed-hooks)
      (add-to-list 'consult-preview-allowed-hooks 'hl-todo-mode)
      (add-to-list 'consult-preview-allowed-hooks 'global-hl-todo-mode))))
#+end_src

** flymake-todo
#+begin_src emacs-lisp
(with-eval-after-load 'hl-todo
  (with-eval-after-load 'flymake
    ;; Helper function to register hl-todo-flymake
    (defun ar/hl-todo-flymake-enable ()
      "Enable hl-todo-flymake in the current buffer."
      (when (and (bound-and-true-p hl-todo-mode)
                 (fboundp 'hl-todo-flymake))
        (add-hook 'flymake-diagnostic-functions #'hl-todo-flymake nil t)))

    ;; Add to relevant modes
    (add-hook 'prog-mode-hook #'ar/hl-todo-flymake-enable)
    (add-hook 'text-mode-hook #'ar/hl-todo-flymake-enable)
    (add-hook 'conf-mode-hook #'ar/hl-todo-flymake-enable)))
#+end_src

** consult-todo
#+begin_src emacs-lisp
(use-package consult-todo
  :defer t
  :commands (consult-todo consult-todo-project consult-todo-all)
  :after (consult hl-todo)

  :custom
  ;; Other missing keywords go under 'other' category
  (consult-todo-other '(?o . "OTHER"))

  ;; Only search keywords in comments (recommended for code files)
  (consult-todo-only-comment t)

  ;; Cache threshold for large projects (in seconds)
  (consult-todo-cache-threshold 5.0))
#+end_src

** magit-todos
#+begin_src emacs-lisp
(use-package magit-todos
  :defer t
  :after magit
  :hook (magit-mode . magit-todos-mode)

  :config
  (add-hook 'magit-log-wash-summary-hook
            #'hl-todo-search-and-highlight t)
  (add-hook 'magit-revision-wash-message-hook
            #'hl-todo-search-and-highlight t)

  ;; Scanner selection - prefer ripgrep for speed
  (setq magit-todos-scanner
        (if (executable-find "rg")
            'magit-todos--scan-with-rg
          'magit-todos--scan-with-git-grep))

  ;; Keywords list (should match hl-todo-keyword-faces)
  (setq magit-todos-keywords-list
        '("TODO" "FIXME" "BUG" "ISSUE" "PROG" "TRICK" "WORKAROUND"
          "BENCHMARK" "REVIEW" "NOTE" "DEPRECATED" "HACK" "DEBUG" "STUB"))

  ;; Keyword suffix pattern (matches hl-todo configuration)
  (setq magit-todos-keyword-suffix ":")

  ;; Exclude common non-source directories
  (setq magit-todos-exclude-globs
        '("*.map" "*.min.*" ".git/" "node_modules/" "dist/" "build/" "vendor/"))

  ;; Group by keyword by default
  (setq magit-todos-group-by
        '(magit-todos-item-keyword magit-todos-item-filename))

  ;; Fontify keyword headers with Tokyo Night colors
  (setq magit-todos-fontify-keyword-headers t)

  ;; Insert the TODO section after the bottom
  (setq magit-todos-insert-after '(bottom))

  ;; Depth for grouping
  (setq magit-todos-depth 1)

  ;; Auto-group items threshold
  (setq magit-todos-auto-group-items 20)

  ;; Don't update remote repositories automatically (performance)
  (setq magit-todos-update-remote nil)

  ;; Faces for TODO keywords in magit-todos (Tokyo Night colors)
  (custom-set-faces
   '(magit-todos-item ((t (:inherit magit-section-secondary-heading))))
   '(hl-todo-TODO ((t (:foreground "#e0af68" :weight bold))))
   '(hl-todo-FIXME ((t (:foreground "#f7768e" :weight bold))))
   '(hl-todo-BUG ((t (:foreground "#f7768e" :weight bold))))
   '(hl-todo-ISSUE ((t (:foreground "#f7768e" :weight bold))))
   '(hl-todo-PROG ((t (:foreground "#7aa2f7" :weight bold))))
   '(hl-todo-TRICK ((t (:foreground "#ff9e64" :weight bold))))
   '(hl-todo-WORKAROUND ((t (:foreground "#ff9e64" :weight bold))))
   '(hl-todo-BENCHMARK ((t (:foreground "#9ece6a" :weight bold))))
   '(hl-todo-REVIEW ((t (:foreground "#7dcfff" :weight bold))))
   '(hl-todo-NOTE ((t (:foreground "#bb9af7" :weight bold))))
   '(hl-todo-DEPRECATED ((t (:foreground "#73daca" :weight bold))))
   '(hl-todo-HACK ((t (:foreground "#db4b4b" :weight bold))))
   '(hl-todo-DEBUG ((t (:foreground "#e0af68" :weight bold))))
   '(hl-todo-STUB ((t (:foreground "#e0af68" :weight bold))))))
#+end_src

* DONE Rainbow Mode
#+begin_src emacs-lisp
(use-package rainbow-mode
  :hook ((prog-mode . rainbow-mode)
         (LaTeX-mode . rainbow-mode)
         (org-mode . rainbow-mode))
  :config
  (setq rainbow-html-colors t)
  (setq rainbow-x-colors t)
  (setq rainbow-latex-colors t))
#+end_src

* DONE Delimiters
** show-paren-mode
#+begin_src emacs-lisp
(use-package paren
  :straight (:type built-in)
  :hook (after-init . show-paren-mode)
  :custom
  (show-paren-delay 0.05)
  (show-paren-highlight-openparen t)
  (show-paren-when-point-inside-paren t)
  (show-paren-when-point-in-periphery t)
  (show-paren-style 'parenthesis)
  (show-paren-context-when-offscreen nil)

  :config
  ;; === CUSTOM ELDOC BACKEND FOR PARENTHESIS ===
  (defun ar/paren-eldoc-offscreen-context (callback &rest _)
    "Show off-screen parenthesis context in Echo Area via ElDoc."
    (let* ((pos (point))
           (match-pos nil)
           (label nil)
           (line-content nil)
           (syntax-at (when (char-after pos) (char-syntax (char-after pos))))
           (syntax-before (when (char-before pos) (char-syntax (char-before pos))))
           ;; Default bounds are the whole buffer
           (scan-beg (point-min))
           (scan-end (point-max)))

      ;; 0. ORG MODE FIX: Constrain search to current source block
      (when (and (derived-mode-p 'org-mode)
                 (org-in-src-block-p))
        (let ((elem (org-element-at-point)))
          (when elem
            (setq scan-beg (org-element-property :begin elem))
            (setq scan-end (org-element-property :end elem)))))

      (save-restriction
        ;; Safety check: Ensure bounds are valid numbers before narrowing
        (when (and (numberp scan-beg) (numberp scan-end) (< scan-beg scan-end))
          (narrow-to-region scan-beg scan-end))

        ;; 1. FIND MATCHING POSITION
        ;; Note: Comments below must not contain raw parens to avoid Org syntax issues
        (cond
         ;; Case A: At Opening Bracket
         ((eq syntax-at ?\()
          (setq match-pos (ignore-errors (scan-sexps pos 1)))
          (when match-pos
            (setq match-pos (1- match-pos))
            (setq label "Closing: ")))

         ;; Case B: At Closing Bracket (Evil/Block cursor)
         ((eq syntax-at ?\))
          (setq match-pos (ignore-errors (scan-sexps (1+ pos) -1)))
          (setq label "Opening: "))

         ;; Case C: After Closing Bracket (Standard Emacs)
         ((eq syntax-before ?\))
          (setq match-pos (ignore-errors (scan-sexps pos -1)))
          (setq label "Opening: ")))

        ;; 2. RETRIEVE CONTENT IF OFF-SCREEN
        (when (and match-pos
                   label
                   (not (pos-visible-in-window-p match-pos)))
          (with-current-buffer (current-buffer)
            (save-excursion
              (goto-char match-pos)
              (setq line-content (string-trim (substring-no-properties (thing-at-point 'line t)))))))

        ;; 3. DISPLAY
        (when line-content
          (funcall callback
                   (concat
                    (propertize label 'face '(:inherit shadow :weight bold))
                    (propertize line-content 'face '(:inherit font-lock-keyword-face :weight bold))))))))

  ;; Register with ElDoc (Priority -45) to avoid conflict with org-eldoc-drawer (-50)
  ;; Positioned between drawer (-50) and heading-info (-40)
  (add-hook 'eldoc-mode-hook
            (lambda ()
              (add-hook 'eldoc-documentation-functions #'ar/paren-eldoc-offscreen-context -45 t))))
#+end_src

** rainbow-delimiters
#+begin_src emacs-lisp
(use-package rainbow-delimiters
  :defer t
  :hook ((LaTeX-mode . rainbow-delimiters-mode)
         (prog-mode . rainbow-delimiters-mode))
  :custom-face
  (rainbow-delimiters-depth-1-face ((t (:foreground "#7aa2f7"))))
  (rainbow-delimiters-depth-2-face ((t (:foreground "#e0af68"))))
  (rainbow-delimiters-depth-3-face ((t (:foreground "#9ece6a"))))
  (rainbow-delimiters-depth-4-face ((t (:foreground "#1abc9c"))))
  (rainbow-delimiters-depth-5-face ((t (:foreground "#bb9af7"))))
  (rainbow-delimiters-depth-6-face ((t (:foreground "#9d7cd8"))))
  (rainbow-delimiters-depth-7-face ((t (:foreground "#ff9e64"))))
  (rainbow-delimiters-depth-8-face ((t (:foreground "#f7768e"))))
  (rainbow-delimiters-depth-9-face ((t (:foreground "#7aa2f7")))))
#+end_src

* DONE Indentations
** DONE Indent Bars
#+begin_src emacs-lisp
(use-package indent-bars
  :defer t
  :config
  (require 'seq)

  (setq indent-bars-treesit-support t
        indent-bars-starting-column 0
        indent-bars-no-descend-lists 'skip
        indent-bars-color '(highlight :face-bg t :blend 0.185)
        indent-bars-no-descend-string 'all
        indent-bars-highlight-current-depth '(:face default :blend 0.85)
        indent-bars-prefer-character t)

  (defun ar/indent-bars-should-enable-p ()
    "Return non-nil if indent-bars should be enabled in current buffer.
Returns nil to block activation if any inhibiting condition is met."
    (not (or
          (frame-parameter nil 'parent-frame)
          (bound-and-true-p org-indent-mode)
          (string-prefix-p " *org-src-fontification:" (buffer-name))
          (and (derived-mode-p 'org-mode)
               (not (bound-and-true-p org-src-mode))))))

  (defun ar/indent-bars-maybe-enable ()
    "Enable indent-bars-mode if conditions are met."
    (when (ar/indent-bars-should-enable-p)
      (indent-bars-mode 1)))

  (defun ar/indent-bars-fix-move-to-column (original-fn col &rest args)
    "Prevent move-to-column from incorrectly handling display property newlines.
When indent-bars uses display properties containing newlines on blank lines,
move-to-column can incorrectly move past the visual line end, breaking Evil
operators and other column-based navigation."
    (if-let* (((bound-and-true-p indent-bars-mode))
              ((bound-and-true-p indent-bars-display-on-blank-lines))
              (line-end (line-end-position))
              (display-prop (get-text-property line-end 'display))
              ((seq-contains-p display-prop ?\n))
              ((> col (- line-end (point)))))
        (goto-char line-end)
      (apply original-fn col args)))

  (advice-add 'move-to-column :around #'ar/indent-bars-fix-move-to-column)

  (with-eval-after-load 'magit-blame
    (add-to-list 'magit-blame-disable-modes 'indent-bars-mode))

  :hook ((prog-mode text-mode conf-mode yaml-mode) . ar/indent-bars-maybe-enable))
#+end_src

** DONE Dirt Indent
#+begin_src emacs-lisp
(use-package dtrt-indent
  :config
  (dtrt-indent-global-mode 1)
  ;; Optional: Adjust verbosity
  ;; 0 = silent, 1 = notify on change (default), 2 = explain why not changed, 3 = debug
  (setq dtrt-indent-verbosity 1)
  ;; Optional: Set minimum confidence threshold
  ;; Only adjust if dtrt-indent is confident in its detection
  (setq dtrt-indent-min-quality 80.0)

  ;; Optional: Exclude certain modes where you want manual control
  (setq dtrt-indent-mode-exclude-list '(org-mode)))
#+end_src

* LaTeX Writing Environment
** Project Awareness
#+begin_src emacs-lisp
(defun ar/get-project-bibliographies ()
  "Find .bib files in the current project root recursively.
Returns a list of absolute paths to bibliography files, or nil if none found."
  (when-let* ((project (project-current nil))
              (root (project-root project)))
    (directory-files-recursively root "\\.bib$")))

(defun ar/setup-project-bibliography ()
  "Create a references.bib file in the project root if it doesn't exist."
  (interactive)
  (if-let* ((project (project-current t))
            (root (project-root project))
            (bib-file (expand-file-name "references.bib" root)))
      (if (file-exists-p bib-file)
          (message "Bibliography already exists: %s" bib-file)
        (with-temp-file bib-file
          (insert "% Bibliography for " (file-name-nondirectory (directory-file-name root)) "\n")
          (insert "% Created: " (format-time-string "%Y-%m-%d") "\n\n"))
        (message "Created project bibliography: %s" bib-file))
    (message "Not currently visiting a project.")))
#+end_src

** Adaptive Wrap
#+begin_src emacs-lisp
(use-package adaptive-wrap
  :hook (LaTeX-mode . adaptive-wrap-prefix-mode)
  :init (setq-default adaptive-wrap-extra-indent 0))
#+end_src

* Utils
** Which Key
#+begin_src emacs-lisp
(use-package which-key
  :defer t
  :hook (after-init . which-key-mode)
  :custom
  (which-key-idle-delay 1.5)
  (which-key-separator " → ")
  (which-key-popup-type 'minibuffer))
#+end_src

** TODO vi-fringe
#+begin_src emacs-lisp
;; Display tildes beyond end-of-buffer like Vim/Neovim
(defface ar/vi-tilde-face
  '((t (:inherit font-lock-comment-face)))
  "Face for tildes displayed beyond end of buffer."
  :group 'ar)

(defvar-local ar/vi-tilde-bitmap
  [#b00000000
   #b01100011
   #b11010110
   #b10001100
   #b00000000]
  "Tilde bitmap for fringe.")

(when (display-graphic-p)
  (define-fringe-bitmap 'ar/vi-tilde-bitmap
    [#b00000000
     #b01100011
     #b11010110
     #b10001100
     #b00000000]
    nil nil 'center))

(defun ar/vi-tilde-display ()
  "Add tilde indicators to lines beyond end of buffer."
  (when (and (display-graphic-p) ar/vi-tilde-mode)
    (save-excursion
      ;; Remove old overlays
      (remove-overlays (point-min) (point-max) 'ar/vi-tilde t)
      ;; Find last actual line
      (goto-char (point-max))
      (unless (bolp) (forward-line 1))
      ;; Add tildes to visible empty lines beyond EOF
      (let ((eof-pos (point))
            (window-end-pos (window-end nil t)))
        (when (< eof-pos window-end-pos)
          (goto-char eof-pos)
          (while (and (not (eobp))
                      (<= (point) window-end-pos))
            (let ((ov (make-overlay (point) (point))))
              (overlay-put ov 'ar/vi-tilde t)
              (overlay-put ov 'before-string
                          (propertize " " 'display
                                     '(left-fringe ar/vi-tilde-bitmap
                                                   ar/vi-tilde-face))))
            (forward-line 1)))))))

(define-minor-mode ar/vi-tilde-mode
  "Display tildes in fringe for lines beyond end of buffer."
  :lighter nil
  :group 'ar
  (if ar/vi-tilde-mode
      (progn
        (ar/vi-tilde-display)
        (add-hook 'window-scroll-functions #'ar/vi-tilde--on-scroll nil t)
        (add-hook 'window-configuration-change-hook #'ar/vi-tilde-display nil t))
    (remove-overlays (point-min) (point-max) 'ar/vi-tilde t)
    (remove-hook 'window-scroll-functions #'ar/vi-tilde--on-scroll t)
    (remove-hook 'window-configuration-change-hook #'ar/vi-tilde-display t)))

(defun ar/vi-tilde--on-scroll (_window _display-start)
  "Update tildes when scrolling."
  (ar/vi-tilde-display))

;; Enable for relevant modes
(dolist (hook '(prog-mode-hook text-mode-hook conf-mode-hook))
  (add-hook hook #'ar/vi-tilde-mode))
#+end_src

* General Keybindings
#+begin_src emacs-lisp
(use-package general
  :after evil
  :demand t
  :config
  ;; Set up leader keys
  (general-create-definer ar/global-leader
    :states '(normal insert visual emacs)
    :prefix "SPC"
    :global-prefix "C-SPC")

  (general-create-definer ar/local-leader
    :states '(normal insert visual emacs)
    :prefix "SPC m"
    :global-prefix "C-SPC m")

  (ar/global-leader
    "SPC" '(execute-extended-command :wk "M-x")
    ":" '(eval-expression :wk "Eval")
    "u" '(universal-argument :wk "Universal arg")
    "!" '(shell-command :wk "Shell cmd")
    "X" '(org-capture :wk "Org capture"))

  ;; Buffer operations (SPC b)
  (ar/global-leader
    "b" '(:ignore t :wk "buffer")
    "b b" '(consult-buffer :wk "Switch buffer")
    "b i" '(ibuffer :wk "Ibuffer")
    "b k" '(kill-current-buffer :wk "Kill buffer")
    "b K" '(kill-buffer :wk "Kill buffer (choose)")
    "b n" '(next-buffer :wk "Next buffer")
    "b p" '(previous-buffer :wk "Previous buffer")
    "b r" '(revert-buffer-quick :wk "Revert buffer")
    "b R" '(rename-buffer :wk "Rename buffer")
    "b S" '(save-buffer :wk "Save buffer")
    "b z" '(bury-buffer :wk "Bury buffer")
    "b [" '(previous-buffer :wk "Previous buffer")
    "b ]" '(next-buffer :wk "Next buffer"))

  ;; Dired/Dirvish operations (Doom-like)
  (ar/global-leader
    "d" '(:ignore t :wk "dired")
    "d d" '(dired-jump :wk "Open dired here")
    "d D" '(dired :wk "Open dired...")
    "d s" '(dirvish-side :wk "Dirvish sidebar")
    "d f" '(dirvish-dwim :wk "Dirvish fullscreen")
    "d h" '(dirvish-show-history :wk "History")
    "d a" '(dirvish-quick-access :wk "Quick access")
    "d j" '(dirvish-fd-jump :wk "Jump fd"))

  ;; File operations (SPC f)
  (ar/global-leader
    "f" '(:ignore t :wk "file")
    "f f" '(find-file :wk "Find file")
    "f r" '(consult-recent-file :wk "Recent files")
    "f s" '(save-buffer :wk "Save file")
    "f S" '(write-file :wk "Save as")
    "f p" '(ar/open-emacs-config-project :wk "Config project")
    "f E" '(sudo-edit :wk "Sudo edit")
    "f l" '(reload-init-file :wk "Reload config")
    "f e" '(:ignore t :wk "emacs")
    "f e d" '((lambda () (interactive) (find-file user-emacs-directory)) :wk "Open emacs.d")
    "f e i" '((lambda () (interactive) (find-file user-init-file)) :wk "Open init.el")
    "f d" '(consult-dir :wk "Change directory")
    "f j" '(consult-dir-jump-file :wk "Jump to file in dir"))

  ;; Search operations (SPC s)
  (ar/global-leader
    "s" '(:ignore t :wk "search")
    "s s" '(consult-line :wk "Search buffer")
    "s S" '(consult-line-multi :wk "Search buffers")
    "s p" '(consult-ripgrep :wk "Search project")
    "s d" '(consult-dir :wk "Search directory")
    "s i" '(consult-imenu :wk "Imenu")
    "s I" '(consult-imenu-multi :wk "Imenu multi")
    "s o" '(consult-outline :wk "Outline")
    "s b" '(consult-line :wk "Search buffer")
    "s j" '(evil-show-jumps :wk "Jump list")
    "s m" '(consult-mark :wk "Mark ring")
    "s e" '(consult-isearch-history :wk "Search history")
    "s y" '(consult-yasnippet :wk "Yasnippet")
    "s t" '(hl-todo-occur :wk "Todo list")
    "s T" '(hl-todo-rg-project :wk "Todo in project"))

  ;; Window operations (SPC w)
  (ar/global-leader
    "w" '(:ignore t :wk "window")
    "w w" '(other-window :wk "Other window")
    "w d" '(delete-window :wk "Delete window")
    "w D" '(delete-other-windows :wk "Delete other windows")
    "w s" '(split-window-below :wk "Split below")
    "w v" '(split-window-right :wk "Split right")
    "w h" '(evil-window-left :wk "Window left")
    "w j" '(evil-window-down :wk "Window down")
    "w k" '(evil-window-up :wk "Window up")
    "w l" '(evil-window-right :wk "Window right")
    "w H" '(evil-window-move-far-left :wk "Move far left")
    "w J" '(evil-window-move-very-bottom :wk "Move bottom")
    "w K" '(evil-window-move-very-top :wk "Move top")
    "w L" '(evil-window-move-far-right :wk "Move far right")
    "w =" '(balance-windows :wk "Balance windows")
    "w m" '(delete-other-windows :wk "Maximize")
    "w o" '(other-window :wk "Other window")
    "w u" '(winner-undo :wk "Winner undo")
    "w r" '(winner-redo :wk "Winner redo")
    "w t" '(toggle-window-split :wk "Toggle split")
    "w _" '(split-window-vertically-instead :wk "Split vertically instead")
    "w |" '(split-window-horizontally-instead :wk "Split horizontally instead"))

  ;; Project operations (SPC p)
  (ar/global-leader
    "p" '(:ignore t :wk "project")
    "p p" '(ar/project-switch-to-file :wk "Switch project → find file")
    "p P" '(ar/project-switch-with-menu :wk "Switch project (menu)")
    "p f" '(projectile-find-file :wk "Find file in project")
    "p s" '(consult-ripgrep :wk "Search project")
    "p b" '(projectile-switch-to-buffer :wk "Project buffers")
    "p k" '(projectile-kill-buffers :wk "Kill project buffers")
    "p c" '(projectile-compile-project :wk "Compile project")
    "p d" '(projectile-dired :wk "Dired project root")
    "p e" '(projectile-run-eshell :wk "Eshell in project")
    "p t" '(ar/treemacs-toggle :wk "Toggle treemacs (current project)")
    "p i" '(projectile-invalidate-cache :wk "Invalidate cache")
    "p r" '(projectile-replace :wk "Replace in project")
    "p R" '(projectile-replace-regexp :wk "Replace regexp in project")
    "p a" '(projectile-add-known-project :wk "Add known project"))


  ;; Toggle operations (SPC t)
  (ar/global-leader
    "t" '(:ignore t :wk "toggle")
    "t l" '(display-line-numbers-mode :wk "Line numbers")
    "t w" '(whitespace-mode :wk "Whitespace")
    "t f" '(toggle-frame-fullscreen :wk "Fullscreen")
    "t m" '(markdown-toggle-markup-hiding :wk "Markdown markup")
    "t t" '(consult-theme :wk "Theme")
    "t v" '(visual-line-mode :wk "Visual line mode")
    "t r" '(rainbow-mode :wk "Rainbow mode")
    "t h" '(global-hl-line-mode :wk "Highlight line")
    "t s" '(global-prettify-symbols-mode :wk "Prettify symbols")
    "t p" '(show-paren-mode :wk "Show paren")
    "t T" '(toggles-hydra/body :wk "Toggles hydra"))


  ;; Open operations (SPC o)
  (ar/global-leader
    "o" '(:ignore t :wk "open")
    "o c" '(container-hydra/body :wk "Container menu")
    "o e" '(ar/eshell-toggle :wk "Toggle eshell")
    "o E" '(ar/eshell-new :wk "Eshell (new)")
    "o t" '(vterm :wk "Vterm")
    "o s" '(shell :wk "Shell")
    "o d" '(dired :wk "Dired")
    "o D" '((lambda () (interactive) (switch-to-buffer "*dashboard*")) :wk "Dashboard")
    "o P" '(popper-toggle :wk "Toggle popup"))

  ;; Help operations (SPC h)
  (ar/global-leader
    "h" '(:ignore t :wk "help")
    "h f" '(helpful-callable :wk "Describe function")
    "h v" '(helpful-variable :wk "Describe variable")
    "h k" '(helpful-key :wk "Describe key")
    "h m" '(describe-mode :wk "Describe mode")
    "h o" '(helpful-symbol :wk "Describe symbol")
    "h c" '(helpful-command :wk "Describe command")
    "h C" '(ar/show-char-info :wk "Char info")
    "h ." '(helpful-at-point :wk "Describe at point")
    "h i" '(info :wk "Info")
    "h I" '(consult-info :wk "Consult info")
    "h p" '(describe-package :wk "Describe package")
    "h a" '(apropos :wk "Apropos")
    "h w" '(woman :wk "Woman")
    "h r" '(:ignore t :wk "reload")
    "h r r" '(reload-init-file :wk "Reload config"))

  (general-define-key
   :states 'motion
    "] e" 'ar/flymake-next-error
    "[ e" 'ar/flymake-prev-error)

  (ar/global-leader
    "c" '(:ignore t :wk "code")
    "c ." '(dev-hydra/body :wk "Dev dashboard")
    "c e" '(consult-flymake :wk "Search errors")
    "c B" '(flymake-show-buffer-diagnostics :wk "Buffer diagnostics")
    "c n" '(ar/flymake-next-error :wk "Next error")
    "c p" '(ar/flymake-prev-error :wk "Prev error")
    "c f" '(apheleia-format-buffer :wk "Format buffer")
    "c r" '(eglot-rename :wk "Rename")
    "c a" '(eglot-code-actions :wk "Code action"))

  ;; Git operations (SPC g)
  (ar/global-leader
    "g" '(:ignore t :wk "git")
    "g s" '(magit-status :wk "Status")
    "g c" '(magit-commit :wk "Commit")
    "g C" '(magit-commit-amend :wk "Commit amend")
    "g p" '(magit-push-current-to-pushremote :wk "Push")
    "g P" '(magit-pull-from-upstream :wk "Pull")
    "g b" '(magit-branch :wk "Branches")
    "g l" '(magit-log-buffer-file :wk "Log current file")
    "g L" '(magit-log-current :wk "Log current branch")
    "g f" '(magit-fetch :wk "Fetch")
    "g h" '(version-control-hydra/body :wk "VC hydra")
    "g m" '(magit-merge :wk "Merge")
    "g r" '(magit-rebase :wk "Rebase")
    "g t" '(git-timemachine-toggle :wk "Timemachine")
    "g n" '(diff-hl-next-hunk :wk "Next hunk")
    "g N" '(diff-hl-previous-hunk :wk "Previous hunk")
    "g S" '(diff-hl-stage-current-hunk :wk "Stage hunk")
    "g R" '(diff-hl-revert-hunk :wk "Revert hunk")
    "g H" '(diff-hl-show-hunk :wk "Preview hunk"))


  ;; Unified Capture
  (ar/global-leader
    "X" '(ar/capture-dispatch :wk "Smart capture"))

  ;; GTD operations
  (ar/global-leader
    "g d" '(:ignore t :wk "gtd")
    "g d c" '(org-gtd-capture :wk "Capture to inbox")
    "g d p" '(org-gtd-process-inbox :wk "Process inbox")
    "g d e" '(org-gtd-engage :wk "Daily engage")
    "g d n" '(org-gtd-show-all-next :wk "Show all NEXT")
    "g d s" '(org-gtd-show-stuck-projects :wk "Stuck projects"))

  (ar/global-leader
    "j" '(:ignore t :wk "jinx (spellcheck)")
    "j c" '(jinx-correct :wk "Correct word at point")
    "j n" '(jinx-next-error :wk "Go to next error")
    "j p" '(jinx-previous-error :wk "Go to previous error")
    "j s" '(jinx-suggest :wk "Show suggestions")
    "j a" '(jinx-add-word-to-personal-dictionary :wk "Add to dictionary")
    "j l" '(jinx-languages :wk "Select language")
    "j t" '(jinx-toggle-checking :wk "Toggle checking in buffer"))

  ;; Register/Bookmark operations (SPC r)
  (ar/global-leader
    "r" '(:ignore t :wk "register/bookmark")
    "r r" '(consult-register :wk "Registers")
    "r s" '(consult-register-store :wk "Store register")
    "r l" '(consult-register-load :wk "Load register")
    "r b" '(consult-bookmark :wk "Bookmarks")
    "r B" '(bookmark-set :wk "Set bookmark")
    "r d" '(bookmark-delete :wk "Delete bookmark")
    "r m" '(bookmark-bmenu-list :wk "Bookmark menu"))

  ;; === NOTES OPERATIONS (SPC n) ===
  (ar/global-leader
    "n" '(:ignore t :wk "notes")

    ;; Capture
    "n c" '(ar/capture-dispatch :wk "Smart capture")

    ;; Find & Navigate
    "n f" '(org-roam-node-find :wk "Find node")
    "n F" '(consult-org-roam-file-find :wk "Find file")
    "n i" '(org-roam-node-insert :wk "Insert node")
    "n s" '(consult-org-roam-search :wk "Search notes")

    ;; Links & Backlinks
    "n l" '(org-roam-buffer-toggle :wk "Backlinks panel")
    "n b" '(consult-org-roam-backlinks :wk "Backlinks")
    "n B" '(consult-org-roam-backlinks-recursive :wk "Backlinks recursive")
    "n L" '(consult-org-roam-forward-links :wk "Forward links")

    ;; Visualization
    "n v" '(org-roam-graph :wk "Roam graph")
    "n u" '(org-roam-ui-open :wk "Roam UI")

    ;; Daily Notes
    "n j" '(org-roam-dailies-capture-today :wk "Daily note")

    ;; Bridge Operations (GTD ↔ Zettelkasten)
    "n g" '(ar/gtd-to-zettel :wk "GTD → Zettelkasten")
    "n G" '(ar/zettel-to-gtd :wk "Zettelkasten → GTD")
    "n p" '(ar/fleeting-to-permanent :wk "Process fleeting")

    ;; Review
    "n w" '(ar/weekly-review :wk "Weekly review")

    ;; Agenda Views (Submenu)
    "n a" '(:ignore t :wk "agenda")
    "n a d" '((lambda () (interactive) (org-agenda nil "d")) :wk "Daily")
    "n a w" '((lambda () (interactive) (org-agenda nil "w")) :wk "Weekly")
    "n a p" '((lambda () (interactive) (org-agenda nil "p")) :wk "Projects")

    ;; Table Operations (Submenu)
    "n t" '(:ignore t :wk "table")
    "n t c" '(org-table-create :wk "Create table")
    "n t a" '(org-table-align :wk "Align table")
    "n t r" '(org-table-recalculate :wk "Recalculate"))

  ;; Quit/Session operations (SPC q)
  (ar/global-leader
    "q" '(:ignore t :wk "quit/session")
    "q q" '(save-buffers-kill-terminal :wk "Quit Emacs")
    "q Q" '(kill-emacs :wk "Quit (no save)")
    "q f" '(delete-frame :wk "Delete frame")
    "q s" '(tabspaces-save-session :wk "Save session")
    "q l" '(tabspaces-restore-session :wk "Load session"))

  ;; Insert operations (SPC i)
  (ar/global-leader
    "i" '(:ignore t :wk "insert")
    "i s" '(consult-yasnippet :wk "Snippet")
    "i u" '(insert-char :wk "Unicode char"))

  ;; Global Zoom Shortcuts (Browser-style)
  (general-define-key
   "C-=" 'text-scale-increase
   "C--" 'text-scale-decrease)

  ;; Workspace operations (SPC TAB)
  (ar/global-leader
    "TAB" '(:ignore t :wk "workspace")
    "TAB TAB" '(tabspaces-switch-or-create-workspace :wk "Switch workspace")
    "TAB n" '(tabspaces-switch-or-create-workspace :wk "New workspace")
    "TAB d" '(tabspaces-close-workspace :wk "Delete workspace")
    "TAB r" '(tab-bar-rename-tab :wk "Rename workspace")
    "TAB [" '(tab-bar-switch-to-prev-tab :wk "Previous workspace")
    "TAB ]" '(tab-bar-switch-to-next-tab :wk "Next workspace")
    "TAB s" '(tabspaces-save-session :wk "Save session")
    "TAB l" '(tabspaces-restore-session :wk "Load session"))

  ;; Macro operations (SPC @)
  (ar/global-leader
    "@" '(:ignore t :wk "macro")
    "@ @" '(kmacro-end-and-call-macro :wk "End and call")
    "@ s" '(kmacro-start-macro :wk "Start recording")
    "@ e" '(kmacro-end-macro :wk "End recording")
    "@ c" '(kmacro-call-macro :wk "Call macro")
    "@ n" '(kmacro-name-last-macro :wk "Name last")
    "@ b" '(kmacro-bind-to-key :wk "Bind to key")
    "@ v" '(kmacro-view-macro :wk "View macro")
    "@ d" '(kmacro-delete-ring-head :wk "Delete"))

  ;; Kill ring (SPC k)
  (ar/global-leader
    "k" '(browse-kill-ring :wk "Kill ring"))

  ;; Iedit (SPC e)
  (ar/global-leader
    "e" '(:ignore t :wk "iedit")
    "e e" '(iedit-mode :wk "Iedit mode")
    "e r" '(iedit-rectangle-mode :wk "Rectangle mode"))

  ;; Treemacs (SPC 0)
  (ar/global-leader
    "0" '(treemacs-select-window :wk "Select treemacs"))

  (general-define-key
   :states 'motion
   ;; Avy bindings
   "g s" 'avy-goto-char-2
   "g S" 'avy-goto-line
   "g w" 'avy-goto-word-1
   "g e" 'avy-goto-word-0

   ;; Xref/LSP navigation
   "g d" 'xref-find-definitions
   "g D" 'xref-find-references
   "g i" 'lsp-find-implementation
   "g t" 'lsp-find-type-definition
   "g ," 'xref-go-back)

  (general-define-key
   :states '(normal visual)
   ;; Better navigation
   "j" 'evil-next-visual-line
   "k" 'evil-previous-visual-line
   "gj" 'evil-next-line
   "gk" 'evil-previous-line

   ;; Avy zap
   "z" 'avy-zap-to-char-dwim
   "Z" 'avy-zap-up-to-char-dwim)

  (general-define-key
   :states 'normal
   ;; Undo-fu
   "u" 'undo-fu-only-undo
   "C-r" 'undo-fu-only-redo)

  (general-define-key
   ;; Ace-link
   "M-o" 'ace-link-addr

   ;; Popper
   "C-`" 'popper-toggle
   "C-~" 'popper-cycle
   "M-`" 'popper-toggle-type)

  (general-define-key
   :states 'normal
   :keymaps 'dired-mode-map
   "h" 'dired-up-directory
   "l" 'dired-find-file
   "o" 'dired-find-file-other-window
   "v" 'dired-view-file
   "m" 'dired-mark
   "u" 'dired-unmark
   "U" 'dired-unmark-all-marks
   "c" 'dired-create-directory
   "C" 'dired-do-copy
   "D" 'dired-do-delete
   "R" 'dired-do-rename
   "Y" 'dired-do-copy
   "!" 'dired-do-shell-command
   "&" 'dired-do-async-shell-command
   "q" 'quit-window
   "g r" 'revert-buffer
   "g g" 'evil-goto-first-line
   "G" 'evil-goto-line
   "s" 'dired-sort-toggle-or-edit
   "(" 'dired-hide-details-mode
   ")" 'dired-omit-mode)

  ;; Dirvish specific bindings (Moved from use-package dirvish)
  (general-define-key
   :states 'normal
   :keymaps 'dirvish-mode-map
   ;; Navigation (Arrow Keys)
   "<left>"  'dired-up-directory
   "<right>" 'dired-find-file
   "<up>"    'dired-previous-line
   "<down>"  'dired-next-line

   ;; Core Actions
   "q"   'dirvish-quit
   "TAB" 'dirvish-subtree-toggle
   "?"   'dirvish-dispatch

   ;; Layout & History
   "M-t" 'dirvish-layout-switch
   "F"   'dirvish-layout-toggle
   "b"   'dirvish-history-go-backward
   "f"   'dirvish-history-go-forward

   ;; Menus & Tools
   "a"   'dirvish-quick-access
   "s"   'dirvish-quicksort
   "y"   'dirvish-yank-menu
   "v"   'dirvish-vc-menu
   "M-e" 'dirvish-emerge-menu
   "M-j" 'dirvish-fd-jump
   "M-s" 'dirvish-setup-menu)

  (general-define-key
   :states 'normal
   :keymaps 'helpful-mode-map
   "q" 'quit-window
   "g r" 'helpful-update
   "TAB" 'forward-button
   "S-TAB" 'backward-button
   "RET" 'push-button)

  (general-define-key
   :states 'normal
   :keymaps 'pdf-view-mode-map
   "j" 'pdf-view-next-line-or-next-page
   "k" 'pdf-view-previous-line-or-previous-page
   "h" 'image-backward-hscroll
   "l" 'image-forward-hscroll
   "J" 'pdf-view-next-page
   "K" 'pdf-view-previous-page
   "g g" 'pdf-view-first-page
   "G" 'pdf-view-last-page
   "g t" 'pdf-view-goto-page
   "g l" 'pdf-view-goto-label
   "+" 'pdf-view-enlarge
   "=" 'pdf-view-enlarge
   "-" 'pdf-view-shrink
   "0" 'pdf-view-scale-reset
   "W" 'pdf-view-fit-width-to-window
   "H" 'pdf-view-fit-height-to-window
   "P" 'pdf-view-fit-page-to-window
   "n" 'pdf-view-next-page-command
   "p" 'pdf-view-previous-page-command
   "d" 'pdf-view-midnight-minor-mode
   "/" 'isearch-forward
   "?" 'isearch-backward
   "o" 'pdf-outline
   "m" 'pdf-view-set-slice-using-mouse
   "b" 'pdf-view-set-slice-from-bounding-box
   "r" 'pdf-view-reset-slice
   "q" 'quit-window)

  ;; Move text up and down
  (general-define-key
   :states '(normal visual insert)
   "M-j" 'move-text-down
   "M-k" 'move-text-up)

  (ar/local-leader
    :keymaps 'org-mode-map
    "," '(org-ctrl-c-ctrl-c :wk "Ctrl-c Ctrl-c")
    "." '(org-time-stamp :wk "Timestamp")
    "*" '(org-ctrl-c-star :wk "Heading")
    "-" '(org-ctrl-c-minus :wk "List")
    "a" '(org-agenda :wk "Agenda")
    "c" '(org-capture :wk "Capture")
    "e" '(org-export-dispatch :wk "Export")
    "i" '(:ignore t :wk "insert")
    "i l" '(org-insert-link :wk "Link")
    "i s" '(org-download-screenshot :wk "Screenshot")
    "i y" '(org-download-yank :wk "Yank image")
    "i t" '(org-table-create :wk "Table")
    "i h" '(org-insert-heading :wk "Heading")
    "t" '(org-todo :wk "Todo")
    "T" '(org-show-todo-tree :wk "Todo tree")
    "s" '(org-schedule :wk "Schedule")
    "d" '(org-deadline :wk "Deadline")
    "p" '(org-priority :wk "Priority")
    "r" '(org-refile :wk "Refile")
    "A" '(org-archive-subtree :wk "Archive")
    "l" '(:ignore t :wk "link")
    "l l" '(org-insert-link :wk "Insert link")
    "l s" '(org-store-link :wk "Store link")
    "l i" '(org-id-get-create :wk "Insert ID")
    "b" '(:ignore t :wk "babel")
    "b t" '(org-babel-tangle :wk "Tangle")
    "b e" '(org-babel-execute-src-block :wk "Execute")
    "b b" '(org-babel-execute-buffer :wk "Execute buffer")
    "b c" '(org-babel-check-src-block :wk "Check")
    "x" '(:ignore t :wk "text")
    "x b" '(org-toggle-checkbox :wk "Toggle checkbox")
    "x i" '(org-toggle-item :wk "Toggle item")
    "x p" '(org-set-property :wk "Set property")
    "x t" '(org-set-tags-command :wk "Set tags")))
#+end_src
